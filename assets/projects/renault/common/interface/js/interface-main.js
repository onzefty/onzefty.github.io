import t from"./lib/debug/debug.js";import e from"./lib/device/device.js";import i from"./lib/emitter/emitter-mixin.js";import{clamp as n,EVENTS as s,getElementFrom as r,getUuidv4 as o}from"./lib/utils/utils.js";import a from"./lib/resizer/window-resize.js";import c from"./lib/render/renderer.js";import"./lib/render/renderer-time.js";var l={};function u(t,e){e||(e=window.location.href),t=t.replace(/[\[\]]/g,"\\$&");var i=new RegExp("[?&]"+t+"(=([^&#]*)|&|#|$)").exec(e);return i?i[2]?decodeURIComponent(i[2].replace(/\+/g," ")):"":null}function h(t){try{if(!t.origin||t.origin.indexOf(window.ofp_distHost)<0)return;if(t.data){var e=JSON.parse(t.data);if("setLocalSCORMData"!=e.method)return;var i=e.data;l.SCORM.data.local=i,i["cmi.interactions._count"]>0&&Object.keys(i).map((function(t){"cmi.interactions"==t.substr(0,16)&&t.indexOf("_count")})),window.ofp_distantSCORMAPILoaded=!0}}catch(t){}}if(l.UTILS={},l.debug={isActive:!1},l.SCORM={version:null,handleCompletionStatus:!0,handleExitMode:!0,API:{handle:null,isFound:!1},connection:{isActive:!1},data:{completionStatus:null,exitStatus:null,local:{}},debug:{}},l.SCORM.isAvailable=function(){return!0},l.SCORM.API.find=function(t){for(var e=null,i=0,n="SCORM.API.find",s=l.UTILS.trace,r=l.SCORM;!t.API&&!t.API_1484_11&&t.parent&&t.parent!=t&&i<=500;)i++,t=t.parent;if(r.version)switch(r.version){case"2004":t.API_1484_11?e=t.API_1484_11:s(n+": SCORM version 2004 was specified by user, but API_1484_11 cannot be found.");break;case"1.2":t.API?e=t.API:s(n+": SCORM version 1.2 was specified by user, but API cannot be found.")}else t.API_1484_11?(r.version="2004",e=t.API_1484_11):t.API&&(r.version="1.2",e=t.API);return e?(s(n+": API found. Version: "+r.version),s("API: "+e)):s(n+": Error finding API. \nFind attempts: "+i+". \nFind attempt limit: 500"),e},l.SCORM.API.get=function(){var t=null,e=window,i=l.SCORM,n=i.API.find,s=l.UTILS.trace;return e.parent&&e.parent!=e&&(t=n(e.parent)),!t&&e.top.opener&&(t=n(e.top.opener)),!t&&e.top.opener&&e.top.opener.document&&(t=n(e.top.opener.document)),t?i.API.isFound=!0:s("API.get failed: Can't find the API!"),t},l.SCORM.API.getHandle=function(){var t=l.SCORM.API;return t.handle||t.isFound||(t.handle=t.get()),t.handle},l.SCORM.connection.initialize=function(){var t=!1,e=l.SCORM,i=e.data.completionStatus,n=l.UTILS.trace,s=l.UTILS.StringToBoolean,r=e.debug,o="SCORM.connection.initialize ";if(n("connection.initialize called."),e.connection.isActive)n(o+"aborted: Connection already active.");else{var a=e.API.getHandle(),c=0;if(a){switch(e.version){case"1.2":t=s(a.LMSInitialize(""));break;case"2004":t=s(a.Initialize(""))}if(t)if(null!==(c=r.getCode())&&0===c){if(e.connection.isActive=!0,e.handleCompletionStatus&&(i=e.status("get")))switch(i){case"not attempted":case"unknown":e.status("set","incomplete")}}else t=!1,n(o+"failed. \nError code: "+c+" \nError info: "+r.getInfo(c));else n(null!==(c=r.getCode())&&0!==c?o+"failed. \nError code: "+c+" \nError info: "+r.getInfo(c):o+"failed: No response from server.")}else n(o+"failed: API is null.")}return t},l.SCORM.connection.terminate=function(){var t=!1,e=l.SCORM,i=e.data.exitStatus;e.data.completionStatus;var n=l.UTILS.trace,s=l.UTILS.StringToBoolean,r=e.debug,o="SCORM.connection.terminate ";if(e.connection.isActive){var a=e.API.getHandle(),c=0;if(a){if(e.handleExitMode&&!i)switch(e.version){case"1.2":t=e.set("cmi.core.exit","suspend");break;case"2004":t=e.set("cmi.exit","suspend")}switch(e.version){case"1.2":t=s(a.LMSFinish(""));break;case"2004":t=s(a.Terminate(""))}t?e.connection.isActive=!1:n(o+"failed. \nError code: "+(c=r.getCode())+" \nError info: "+r.getInfo(c))}else n(o+"failed: API is null.")}else n(o+"aborted: Connection already terminated.");return t},l.SCORM.data.get=function(t){var e=null,i=l.SCORM,n=l.UTILS.trace,s=i.debug,r="SCORM.data.get("+t+") ";if(i.connection.isActive){var o=i.API.getHandle(),a=0;if(o){switch(i.version){case"1.2":e=o.LMSGetValue(t);break;case"2004":e=o.GetValue(t)}if(a=s.getCode(),""!==e||0===a)switch(t){case"cmi.core.lesson_status":case"cmi.completion_status":i.data.completionStatus=e;break;case"cmi.core.exit":case"cmi.exit":i.data.exitStatus=e}else n(r+"failed. \nError code: "+a+"\nError info: "+s.getInfo(a))}else n(r+"failed: API is null.")}else n(r+"failed: API connection is inactive.");return n(r+" value: "+e),String(e)},l.SCORM.data.set=function(t,e){var i=!1,n=l.SCORM,s=l.UTILS.trace,r=l.UTILS.StringToBoolean,o=n.debug,a="SCORM.data.set("+t+") ";if(n.connection.isActive){var c=n.API.getHandle();if(c){switch(n.version){case"1.2":i=r(c.LMSSetValue(t,e));break;case"2004":i=r(c.SetValue(t,e))}i?"cmi.core.lesson_status"!==t&&"cmi.completion_status"!==t||(n.data.completionStatus=e):s(a+"failed. \nError code: 0. \nError info: "+o.getInfo(0))}else s(a+"failed: API is null.")}else s(a+"failed: API connection is inactive.");return s(a+" value: "+e),i},l.SCORM.data.save=function(){var t=!1,e=l.SCORM,i=l.UTILS.trace,n=l.UTILS.StringToBoolean,s="SCORM.data.save failed";if(e.connection.isActive){var r=e.API.getHandle();if(r)switch(e.version){case"1.2":t=n(r.LMSCommit(""));break;case"2004":t=n(r.Commit(""))}else i(s+": API is null.")}else i(s+": API connection is inactive.");return t},l.SCORM.status=function(t,e){var i=!1,n=l.SCORM,s=l.UTILS.trace,r="SCORM.getStatus failed",o="";if(null!==t){switch(n.version){case"1.2":o="cmi.core.lesson_status";break;case"2004":o="cmi.completion_status"}switch(t){case"get":i=n.data.get(o);break;case"set":null!==e?i=n.data.set(o,e):(i=!1,s(r+": status was not specified."));break;default:i=!1,s(r+": no valid action was specified.")}}else s(r+": action was not specified.");return i},l.SCORM.debug.getCode=function(){var t=l.SCORM,e=t.API.getHandle(),i=l.UTILS.trace,n=0;if(e)switch(t.version){case"1.2":n=parseInt(e.LMSGetLastError(),10);break;case"2004":n=parseInt(e.GetLastError(),10)}else i("SCORM.debug.getCode failed: API is null.");return n},l.SCORM.debug.getInfo=function(t){var e=l.SCORM,i=e.API.getHandle(),n=l.UTILS.trace,s="";if(i)switch(e.version){case"1.2":s=i.LMSGetErrorString(t.toString());break;case"2004":s=i.GetErrorString(t.toString())}else n("SCORM.debug.getInfo failed: API is null.");return String(s)},l.SCORM.debug.getDiagnosticInfo=function(t){var e=l.SCORM,i=e.API.getHandle(),n=l.UTILS.trace,s="";if(i)switch(e.version){case"1.2":s=i.LMSGetDiagnostic(t);break;case"2004":s=i.GetDiagnostic(t)}else n("SCORM.debug.getDiagnosticInfo failed: API is null.");return String(s)},null!=u("disthost")&&""!=u("disthost")){window.ofp_distHost=u("disthost"),window.ofp_waitForDistantSCORMAPI=!0,window.ofp_distantSCORMAPILoaded=!1;var d=u("scormver");d&&/12|2004/gi.test(d)||(d="2004"),d=/12/gi.test(d)?"1.2":"2004";var p=location.protocol+window.ofp_distHost;p.indexOf("//")<0&&(p=location.protocol+"//"+window.ofp_distHost),window.addEventListener?addEventListener("message",h,!1):attachEvent("onmessage",h),l.SCORM.API.handle={LMSGetLastError:function(){return 0},GetLastError:function(){return 0},GetErrorString:function(){return""},LMSGetErrorString:function(){return""},GetDiagnostic:function(){return""},LMSGetDiagnostic:function(){return""}},l.SCORM.API.isFound=!0,l.SCORM.init=function(){return window.API=JSON.parse(JSON.stringify(l.SCORM.API.handle)),window.parent.postMessage(JSON.stringify({method:"scorm.init",arguments:arguments}),p),l.SCORM.connection.isActive=!0,!0},l.SCORM.get=function(t){return void 0!==l.SCORM.data.local[t]?l.SCORM.data.local[t]:""},l.SCORM.set=function(){window.parent.postMessage(JSON.stringify({method:"scorm.set",arguments:arguments}),p);var t=!1;try{if(arguments[0].indexOf("cmi.interactions")>=0){if((i=arguments[0].split(".")).length>3){var e=parseInt(i[2]);l.SCORM.data.local["cmi.interactions._count"]=e+1}}else if(arguments[0].indexOf("cmi.objectives")>=0){var i;if((i=arguments[0].split(".")).length>3){var n=parseInt(i[2]);l.SCORM.data.local["cmi.objectives._count"]=n+1}}t=!0}catch(t){}return l.SCORM.data.local[arguments[0]]=arguments[1],t},l.SCORM.save=function(){return window.parent.postMessage(JSON.stringify({method:"scorm.save",arguments:arguments}),p),!0},l.SCORM.quit=function(){return window.parent.postMessage(JSON.stringify({method:"scorm.quit",arguments:arguments}),p),!0},l.SCORM.version=d,l.SCORM.init(),window.parent.postMessage(JSON.stringify({method:"scorm.preload",arguments:[]}),p)}else l.SCORM.init=l.SCORM.connection.initialize,l.SCORM.get=l.SCORM.data.get,l.SCORM.set=l.SCORM.data.set,l.SCORM.save=l.SCORM.data.save,l.SCORM.quit=l.SCORM.connection.terminate;l.UTILS.StringToBoolean=function(t){switch(typeof t){case"object":case"string":return/(true|1)/i.test(t);case"number":return!!t;case"boolean":return t;case"undefined":return null;default:return!1}},l.UTILS.trace=function(t){l.debug.isActive&&window.console&&window.console.log&&console.log(t)},window.pipwerks=l;var f,m,g,v,y,S=S||function(t){var e={},i=e.lib={},n=function(){},s=i.Base={extend:function(t){n.prototype=this;var e=new n;return t&&e.mixIn(t),e.hasOwnProperty("init")||(e.init=function(){e.$super.init.apply(this,arguments)}),e.init.prototype=e,e.$super=this,e},create:function(){var t=this.extend();return t.init.apply(t,arguments),t},init:function(){},mixIn:function(t){for(var e in t)t.hasOwnProperty(e)&&(this[e]=t[e]);t.hasOwnProperty("toString")&&(this.toString=t.toString)},clone:function(){return this.init.prototype.extend(this)}},r=i.WordArray=s.extend({init:function(t,e){t=this.words=t||[],this.sigBytes=null!=e?e:4*t.length},toString:function(t){return(t||a).stringify(this)},concat:function(t){var e=this.words,i=t.words,n=this.sigBytes;if(t=t.sigBytes,this.clamp(),n%4)for(var s=0;s<t;s++)e[n+s>>>2]|=(i[s>>>2]>>>24-s%4*8&255)<<24-(n+s)%4*8;else if(65535<i.length)for(s=0;s<t;s+=4)e[n+s>>>2]=i[s>>>2];else e.push.apply(e,i);return this.sigBytes+=t,this},clamp:function(){var e=this.words,i=this.sigBytes;e[i>>>2]&=4294967295<<32-i%4*8,e.length=t.ceil(i/4)},clone:function(){var t=s.clone.call(this);return t.words=this.words.slice(0),t},random:function(e){for(var i=[],n=0;n<e;n+=4)i.push(4294967296*t.random()|0);return new r.init(i,e)}}),o=e.enc={},a=o.Hex={stringify:function(t){var e=t.words;t=t.sigBytes;for(var i=[],n=0;n<t;n++){var s=e[n>>>2]>>>24-n%4*8&255;i.push((s>>>4).toString(16)),i.push((15&s).toString(16))}return i.join("")},parse:function(t){for(var e=t.length,i=[],n=0;n<e;n+=2)i[n>>>3]|=parseInt(t.substr(n,2),16)<<24-n%8*4;return new r.init(i,e/2)}},c=o.Latin1={stringify:function(t){var e=t.words;t=t.sigBytes;for(var i=[],n=0;n<t;n++)i.push(String.fromCharCode(e[n>>>2]>>>24-n%4*8&255));return i.join("")},parse:function(t){for(var e=t.length,i=[],n=0;n<e;n++)i[n>>>2]|=(255&t.charCodeAt(n))<<24-n%4*8;return new r.init(i,e)}},l=o.Utf8={stringify:function(t){try{return decodeURIComponent(escape(c.stringify(t)))}catch(t){throw Error("Malformed UTF-8 data")}},parse:function(t){return c.parse(unescape(encodeURIComponent(t)))}},u=i.BufferedBlockAlgorithm=s.extend({reset:function(){this._data=new r.init,this._nDataBytes=0},_append:function(t){"string"==typeof t&&(t=l.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes},_process:function(e){var i=this._data,n=i.words,s=i.sigBytes,o=this.blockSize,a=s/(4*o);if(e=(a=e?t.ceil(a):t.max((0|a)-this._minBufferSize,0))*o,s=t.min(4*e,s),e){for(var c=0;c<e;c+=o)this._doProcessBlock(n,c);c=n.splice(0,e),i.sigBytes-=s}return new r.init(c,s)},clone:function(){var t=s.clone.call(this);return t._data=this._data.clone(),t},_minBufferSize:0});i.Hasher=u.extend({cfg:s.extend(),init:function(t){this.cfg=this.cfg.extend(t),this.reset()},reset:function(){u.reset.call(this),this._doReset()},update:function(t){return this._append(t),this._process(),this},finalize:function(t){return t&&this._append(t),this._doFinalize()},blockSize:16,_createHelper:function(t){return function(e,i){return new t.init(i).finalize(e)}},_createHmacHelper:function(t){return function(e,i){return new h.HMAC.init(t,i).finalize(e)}}});var h=e.algo={};return e}(Math);m=(y=(f=S).lib).WordArray,g=y.Hasher,v=[],y=f.algo.SHA1=g.extend({_doReset:function(){this._hash=new m.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(t,e){for(var i=this._hash.words,n=i[0],s=i[1],r=i[2],o=i[3],a=i[4],c=0;80>c;c++){if(16>c)v[c]=0|t[e+c];else{var l=v[c-3]^v[c-8]^v[c-14]^v[c-16];v[c]=l<<1|l>>>31}l=(n<<5|n>>>27)+a+v[c],l=20>c?l+(1518500249+(s&r|~s&o)):40>c?l+(1859775393+(s^r^o)):60>c?l+((s&r|s&o|r&o)-1894007588):l+((s^r^o)-899497514),a=o,o=r,r=s<<30|s>>>2,s=n,n=l}i[0]=i[0]+n|0,i[1]=i[1]+s|0,i[2]=i[2]+r|0,i[3]=i[3]+o|0,i[4]=i[4]+a|0},_doFinalize:function(){var t=this._data,e=t.words,i=8*this._nDataBytes,n=8*t.sigBytes;return e[n>>>5]|=128<<24-n%32,e[14+(n+64>>>9<<4)]=Math.floor(i/4294967296),e[15+(n+64>>>9<<4)]=i,t.sigBytes=4*e.length,this._process(),this._hash},clone:function(){var t=g.clone.call(this);return t._hash=this._hash.clone(),t}}),f.SHA1=g._createHelper(y),f.HmacSHA1=g._createHmacHelper(y);var w,b,O,x,C,_,D,A,R,T,P,I,k,E,N,M,U,L,j,F,H,J,B,q,V,z,G,W,$,X,K,Y;S=S||function(t){var e={},i=e.lib={},n=function(){},s=i.Base={extend:function(t){n.prototype=this;var e=new n;return t&&e.mixIn(t),e.hasOwnProperty("init")||(e.init=function(){e.$super.init.apply(this,arguments)}),e.init.prototype=e,e.$super=this,e},create:function(){var t=this.extend();return t.init.apply(t,arguments),t},init:function(){},mixIn:function(t){for(var e in t)t.hasOwnProperty(e)&&(this[e]=t[e]);t.hasOwnProperty("toString")&&(this.toString=t.toString)},clone:function(){return this.init.prototype.extend(this)}},r=i.WordArray=s.extend({init:function(t,e){t=this.words=t||[],this.sigBytes=null!=e?e:4*t.length},toString:function(t){return(t||a).stringify(this)},concat:function(t){var e=this.words,i=t.words,n=this.sigBytes;if(t=t.sigBytes,this.clamp(),n%4)for(var s=0;s<t;s++)e[n+s>>>2]|=(i[s>>>2]>>>24-s%4*8&255)<<24-(n+s)%4*8;else if(65535<i.length)for(s=0;s<t;s+=4)e[n+s>>>2]=i[s>>>2];else e.push.apply(e,i);return this.sigBytes+=t,this},clamp:function(){var e=this.words,i=this.sigBytes;e[i>>>2]&=4294967295<<32-i%4*8,e.length=t.ceil(i/4)},clone:function(){var t=s.clone.call(this);return t.words=this.words.slice(0),t},random:function(e){for(var i=[],n=0;n<e;n+=4)i.push(4294967296*t.random()|0);return new r.init(i,e)}}),o=e.enc={},a=o.Hex={stringify:function(t){var e=t.words;t=t.sigBytes;for(var i=[],n=0;n<t;n++){var s=e[n>>>2]>>>24-n%4*8&255;i.push((s>>>4).toString(16)),i.push((15&s).toString(16))}return i.join("")},parse:function(t){for(var e=t.length,i=[],n=0;n<e;n+=2)i[n>>>3]|=parseInt(t.substr(n,2),16)<<24-n%8*4;return new r.init(i,e/2)}},c=o.Latin1={stringify:function(t){var e=t.words;t=t.sigBytes;for(var i=[],n=0;n<t;n++)i.push(String.fromCharCode(e[n>>>2]>>>24-n%4*8&255));return i.join("")},parse:function(t){for(var e=t.length,i=[],n=0;n<e;n++)i[n>>>2]|=(255&t.charCodeAt(n))<<24-n%4*8;return new r.init(i,e)}},l=o.Utf8={stringify:function(t){try{return decodeURIComponent(escape(c.stringify(t)))}catch(t){throw Error("Malformed UTF-8 data")}},parse:function(t){return c.parse(unescape(encodeURIComponent(t)))}},u=i.BufferedBlockAlgorithm=s.extend({reset:function(){this._data=new r.init,this._nDataBytes=0},_append:function(t){"string"==typeof t&&(t=l.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes},_process:function(e){var i=this._data,n=i.words,s=i.sigBytes,o=this.blockSize,a=s/(4*o);if(e=(a=e?t.ceil(a):t.max((0|a)-this._minBufferSize,0))*o,s=t.min(4*e,s),e){for(var c=0;c<e;c+=o)this._doProcessBlock(n,c);c=n.splice(0,e),i.sigBytes-=s}return new r.init(c,s)},clone:function(){var t=s.clone.call(this);return t._data=this._data.clone(),t},_minBufferSize:0});i.Hasher=u.extend({cfg:s.extend(),init:function(t){this.cfg=this.cfg.extend(t),this.reset()},reset:function(){u.reset.call(this),this._doReset()},update:function(t){return this._append(t),this._process(),this},finalize:function(t){return t&&this._append(t),this._doFinalize()},blockSize:16,_createHelper:function(t){return function(e,i){return new t.init(i).finalize(e)}},_createHmacHelper:function(t){return function(e,i){return new h.HMAC.init(t,i).finalize(e)}}});var h=e.algo={};return e}(Math);function Q(){this._debug=!1,this.enabled=!1,this.tincan=null,this.course_data=null,Object.defineProperty(this,"debug",{get:function(){return this._debug},set:function(t){this._debug=t,TinCan.DEBUG=t}})}!function(t){for(var e=S,i=(s=e.lib).WordArray,n=s.Hasher,s=e.algo,r=[],o=[],a=function(t){return 4294967296*(t-(0|t))|0},c=2,l=0;64>l;){var u;t:{u=c;for(var h=t.sqrt(u),d=2;d<=h;d++)if(!(u%d)){u=!1;break t}u=!0}u&&(8>l&&(r[l]=a(t.pow(c,.5))),o[l]=a(t.pow(c,1/3)),l++),c++}var p=[];s=s.SHA256=n.extend({_doReset:function(){this._hash=new i.init(r.slice(0))},_doProcessBlock:function(t,e){for(var i=this._hash.words,n=i[0],s=i[1],r=i[2],a=i[3],c=i[4],l=i[5],u=i[6],h=i[7],d=0;64>d;d++){if(16>d)p[d]=0|t[e+d];else{var f=p[d-15],m=p[d-2];p[d]=((f<<25|f>>>7)^(f<<14|f>>>18)^f>>>3)+p[d-7]+((m<<15|m>>>17)^(m<<13|m>>>19)^m>>>10)+p[d-16]}f=h+((c<<26|c>>>6)^(c<<21|c>>>11)^(c<<7|c>>>25))+(c&l^~c&u)+o[d]+p[d],m=((n<<30|n>>>2)^(n<<19|n>>>13)^(n<<10|n>>>22))+(n&s^n&r^s&r),h=u,u=l,l=c,c=a+f|0,a=r,r=s,s=n,n=f+m|0}i[0]=i[0]+n|0,i[1]=i[1]+s|0,i[2]=i[2]+r|0,i[3]=i[3]+a|0,i[4]=i[4]+c|0,i[5]=i[5]+l|0,i[6]=i[6]+u|0,i[7]=i[7]+h|0},_doFinalize:function(){var e=this._data,i=e.words,n=8*this._nDataBytes,s=8*e.sigBytes;return i[s>>>5]|=128<<24-s%32,i[14+(s+64>>>9<<4)]=t.floor(n/4294967296),i[15+(s+64>>>9<<4)]=n,e.sigBytes=4*i.length,this._process(),this._hash},clone:function(){var t=n.clone.call(this);return t._hash=this._hash.clone(),t}});e.SHA256=n._createHelper(s),e.HmacSHA256=n._createHmacHelper(s)}(Math),b=(w=S).lib.WordArray,w.enc.Base64={stringify:function(t){var e=t.words,i=t.sigBytes,n=this._map;t.clamp();for(var s=[],r=0;r<i;r+=3)for(var o=(e[r>>>2]>>>24-r%4*8&255)<<16|(e[r+1>>>2]>>>24-(r+1)%4*8&255)<<8|e[r+2>>>2]>>>24-(r+2)%4*8&255,a=0;a<4&&r+.75*a<i;a++)s.push(n.charAt(o>>>6*(3-a)&63));var c=n.charAt(64);if(c)for(;s.length%4;)s.push(c);return s.join("")},parse:function(t){var e=t.length,i=this._map,n=i.charAt(64);if(n){var s=t.indexOf(n);-1!=s&&(e=s)}for(var r=[],o=0,a=0;a<e;a++)if(a%4){var c=i.indexOf(t.charAt(a-1))<<a%4*2,l=i.indexOf(t.charAt(a))>>>6-a%4*2;r[o>>>2]|=(c|l)<<24-o%4*8,o++}return b.create(r,o)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="},function(){if("function"==typeof ArrayBuffer){var t=S.lib.WordArray,e=t.init,i=t.init=function(t){if(t instanceof ArrayBuffer&&(t=new Uint8Array(t)),(t instanceof Int8Array||t instanceof Uint8ClampedArray||t instanceof Int16Array||t instanceof Uint16Array||t instanceof Int32Array||t instanceof Uint32Array||t instanceof Float32Array||t instanceof Float64Array)&&(t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength)),t instanceof Uint8Array){for(var i=t.byteLength,n=[],s=0;s<i;s++)n[s>>>2]|=t[s]<<24-s%4*8;e.call(this,n,i)}else e.apply(this,arguments)};i.prototype=t}}(),x={statementId:!0,voidedStatementId:!0,verb:!0,object:!0,registration:!0,context:!0,actor:!0,since:!0,until:!0,limit:!0,authoritative:!0,sparse:!0,instructor:!0,ascending:!0,continueToken:!0,agent:!0,activityId:!0,stateId:!0,profileId:!0,activity_platform:!0,grouping:!0,"Accept-Language":!0},(O=function(t){this.log("constructor"),this.recordStores=[],this.actor=null,this.activity=null,this.registration=null,this.context=null,this.init(t)}).prototype={LOG_SRC:"TinCan",log:function(t,e){O.DEBUG&&"undefined"!=typeof console&&console.log&&(e=e||this.LOG_SRC||"TinCan",console.log("TinCan."+e+": "+t))},init:function(t){var e;if(this.log("init"),(t=t||{}).hasOwnProperty("url")&&""!==t.url&&this._initFromQueryString(t.url),t.hasOwnProperty("recordStores")&&void 0!==t.recordStores)for(e=0;e<t.recordStores.length;e+=1)this.addRecordStore(t.recordStores[e]);t.hasOwnProperty("activity")&&(t.activity instanceof O.Activity?this.activity=t.activity:this.activity=new O.Activity(t.activity)),t.hasOwnProperty("actor")&&(t.actor instanceof O.Agent?this.actor=t.actor:this.actor=new O.Agent(t.actor)),t.hasOwnProperty("context")&&(t.context instanceof O.Context?this.context=t.context:this.context=new O.Context(t.context)),t.hasOwnProperty("registration")&&(this.registration=t.registration)},_initFromQueryString:function(t){this.log("_initFromQueryString");var e,i,n,s=O.Utils.parseURL(t).params,r=["endpoint","auth"],o={},a=null;if(s.hasOwnProperty("actor")){this.log("_initFromQueryString - found actor: "+s.actor);try{this.actor=O.Agent.fromJSON(s.actor),delete s.actor}catch(t){this.log("_initFromQueryString - failed to set actor: "+t)}}if(s.hasOwnProperty("activity_id")&&(this.activity=new O.Activity({id:s.activity_id}),delete s.activity_id),(s.hasOwnProperty("activity_platform")||s.hasOwnProperty("registration")||s.hasOwnProperty("grouping"))&&(n={},s.hasOwnProperty("activity_platform")&&(n.platform=s.activity_platform,delete s.activity_platform),s.hasOwnProperty("registration")&&(n.registration=this.registration=s.registration,delete s.registration),s.hasOwnProperty("grouping")&&(n.contextActivities={},n.contextActivities.grouping=s.grouping,delete s.grouping),this.context=new O.Context(n)),s.hasOwnProperty("endpoint")){for(e=0;e<r.length;e+=1)i=r[e],s.hasOwnProperty(i)&&(o[i]=s[i],delete s[i]);for(e in s)s.hasOwnProperty(e)&&(x.hasOwnProperty(e)?delete s[e]:(a=a||{})[e]=s[e]);null!==a&&(o.extended=a),o.allowFail=!1,this.addRecordStore(o)}},addRecordStore:function(t){var e;this.log("addRecordStore"),e=t instanceof O.LRS?t:new O.LRS(t),this.recordStores.push(e)},prepareStatement:function(t){return this.log("prepareStatement"),t instanceof O.Statement||(t=new O.Statement(t)),null===t.actor&&null!==this.actor&&(t.actor=this.actor),null===t.target&&null!==this.activity&&(t.target=this.activity),null!==this.context&&(null===t.context?t.context=this.context:(null===t.context.registration&&(t.context.registration=this.context.registration),null===t.context.platform&&(t.context.platform=this.context.platform),null!==this.context.contextActivities&&(null===t.context.contextActivities?t.context.contextActivities=this.context.contextActivities:(null!==this.context.contextActivities.grouping&&null===t.context.contextActivities.grouping&&(t.context.contextActivities.grouping=this.context.contextActivities.grouping),null!==this.context.contextActivities.parent&&null===t.context.contextActivities.parent&&(t.context.contextActivities.parent=this.context.contextActivities.parent),null!==this.context.contextActivities.other&&null===t.context.contextActivities.other&&(t.context.contextActivities.other=this.context.contextActivities.other))))),t},sendStatement:function(t,e){this.log("sendStatement");var i,n,s,r=this,o=this.prepareStatement(t),a=this.recordStores.length,c=[],l=[];if(a>0)for("function"==typeof e&&(s=function(t,i){var n;r.log("sendStatement - callbackWrapper: "+a),a>1?(a-=1,l.push({err:t,xhr:i})):1===a?(l.push({err:t,xhr:i}),n=[l,o],e.apply(this,n)):r.log("sendStatement - unexpected record store count: "+a)}),n=0;n<a;n+=1)i=this.recordStores[n],c.push(i.saveStatement(o,{callback:s}));else this.log("[warning] sendStatement: No LRSs added yet (statement not sent)"),"function"==typeof e&&e.apply(this,[null,o]);return{statement:o,results:c}},getStatement:function(t,e,i){if(this.log("getStatement"),(i=i||{}).params=i.params||{},this.recordStores.length>0)return this.recordStores[0].retrieveStatement(t,{callback:e,params:i.params});this.log("[warning] getStatement: No LRSs added yet (statement not retrieved)")},voidStatement:function(t,e,i){this.log("voidStatement");var n,s,r,o,a,c=this,l=this.recordStores.length,u=[],h=[];if(t instanceof O.Statement&&(t=t.id),void 0!==i.actor?s=i.actor:null!==this.actor&&(s=this.actor),r=new O.Statement({actor:s,verb:{id:"http://adlnet.gov/expapi/verbs/voided"},target:{objectType:"StatementRef",id:t}}),l>0)for("function"==typeof e&&(a=function(t,i){var n;c.log("voidStatement - callbackWrapper: "+l),l>1?(l-=1,h.push({err:t,xhr:i})):1===l?(h.push({err:t,xhr:i}),n=[h,r],e.apply(this,n)):c.log("voidStatement - unexpected record store count: "+l)}),o=0;o<l;o+=1)n=this.recordStores[o],u.push(n.saveStatement(r,{callback:a}));else this.log("[warning] voidStatement: No LRSs added yet (statement not sent)"),"function"==typeof e&&e.apply(this,[null,r]);return{statement:r,results:u}},getVoidedStatement:function(t,e){if(this.log("getVoidedStatement"),this.recordStores.length>0)return this.recordStores[0].retrieveVoidedStatement(t,{callback:e});this.log("[warning] getVoidedStatement: No LRSs added yet (statement not retrieved)")},sendStatements:function(t,e){this.log("sendStatements");var i,n,s,r=this,o=[],a=this.recordStores.length,c=[],l=[];if(0===t.length)"function"==typeof e&&e.apply(this,[null,o]);else{for(n=0;n<t.length;n+=1)o.push(this.prepareStatement(t[n]));if(a>0)for("function"==typeof e&&(s=function(t,i){var n;r.log("sendStatements - callbackWrapper: "+a),a>1?(a-=1,l.push({err:t,xhr:i})):1===a?(l.push({err:t,xhr:i}),n=[l,o],e.apply(this,n)):r.log("sendStatements - unexpected record store count: "+a)}),n=0;n<a;n+=1)i=this.recordStores[n],c.push(i.saveStatements(o,{callback:s}));else this.log("[warning] sendStatements: No LRSs added yet (statements not sent)"),"function"==typeof e&&e.apply(this,[null,o])}return{statements:o,results:c}},getStatements:function(t){this.log("getStatements");var e,i,n={};if(this.recordStores.length>0)return e=this.recordStores[0],i=(t=t||{}).params||{},t.sendActor&&null!==this.actor&&("0.9"===e.version||"0.95"===e.version?i.actor=this.actor:i.agent=this.actor),t.sendActivity&&null!==this.activity&&("0.9"===e.version||"0.95"===e.version?i.target=this.activity:i.activity=this.activity),void 0===i.registration&&null!==this.registration&&(i.registration=this.registration),n={params:i},void 0!==t.callback&&(n.callback=t.callback),e.queryStatements(n);this.log("[warning] getStatements: No LRSs added yet (statements not read)")},getState:function(t,e){var i,n;if(this.log("getState"),this.recordStores.length>0)return n=this.recordStores[0],i={agent:void 0!==(e=e||{}).agent?e.agent:this.actor,activity:void 0!==e.activity?e.activity:this.activity},void 0!==e.registration?i.registration=e.registration:null!==this.registration&&(i.registration=this.registration),void 0!==e.callback&&(i.callback=e.callback),n.retrieveState(t,i);this.log("[warning] getState: No LRSs added yet (state not retrieved)")},setState:function(t,e,i){var n,s;if(this.log("setState"),this.recordStores.length>0)return s=this.recordStores[0],n={agent:void 0!==(i=i||{}).agent?i.agent:this.actor,activity:void 0!==i.activity?i.activity:this.activity},void 0!==i.registration?n.registration=i.registration:null!==this.registration&&(n.registration=this.registration),void 0!==i.lastSHA1&&(n.lastSHA1=i.lastSHA1),void 0!==i.contentType&&(n.contentType=i.contentType,void 0!==i.overwriteJSON&&!i.overwriteJSON&&O.Utils.isApplicationJSON(i.contentType)&&(n.method="POST")),void 0!==i.callback&&(n.callback=i.callback),s.saveState(t,e,n);this.log("[warning] setState: No LRSs added yet (state not saved)")},deleteState:function(t,e){var i,n;if(this.log("deleteState"),this.recordStores.length>0)return n=this.recordStores[0],i={agent:void 0!==(e=e||{}).agent?e.agent:this.actor,activity:void 0!==e.activity?e.activity:this.activity},void 0!==e.registration?i.registration=e.registration:null!==this.registration&&(i.registration=this.registration),void 0!==e.callback&&(i.callback=e.callback),n.dropState(t,i);this.log("[warning] deleteState: No LRSs added yet (state not deleted)")},getActivityProfile:function(t,e){var i,n;if(this.log("getActivityProfile"),this.recordStores.length>0)return n=this.recordStores[0],i={activity:void 0!==(e=e||{}).activity?e.activity:this.activity},void 0!==e.callback&&(i.callback=e.callback),n.retrieveActivityProfile(t,i);this.log("[warning] getActivityProfile: No LRSs added yet (activity profile not retrieved)")},setActivityProfile:function(t,e,i){var n,s;if(this.log("setActivityProfile"),this.recordStores.length>0)return s=this.recordStores[0],n={activity:void 0!==(i=i||{}).activity?i.activity:this.activity},void 0!==i.callback&&(n.callback=i.callback),void 0!==i.lastSHA1&&(n.lastSHA1=i.lastSHA1),void 0!==i.contentType&&(n.contentType=i.contentType,void 0!==i.overwriteJSON&&!i.overwriteJSON&&O.Utils.isApplicationJSON(i.contentType)&&(n.method="POST")),s.saveActivityProfile(t,e,n);this.log("[warning] setActivityProfile: No LRSs added yet (activity profile not saved)")},deleteActivityProfile:function(t,e){var i,n;if(this.log("deleteActivityProfile"),this.recordStores.length>0)return n=this.recordStores[0],i={activity:void 0!==(e=e||{}).activity?e.activity:this.activity},void 0!==e.callback&&(i.callback=e.callback),n.dropActivityProfile(t,i);this.log("[warning] deleteActivityProfile: No LRSs added yet (activity profile not deleted)")},getAgentProfile:function(t,e){var i,n;if(this.log("getAgentProfile"),this.recordStores.length>0)return n=this.recordStores[0],i={agent:void 0!==(e=e||{}).agent?e.agent:this.actor},void 0!==e.callback&&(i.callback=e.callback),n.retrieveAgentProfile(t,i);this.log("[warning] getAgentProfile: No LRSs added yet (agent profile not retrieved)")},setAgentProfile:function(t,e,i){var n,s;if(this.log("setAgentProfile"),this.recordStores.length>0)return s=this.recordStores[0],n={agent:void 0!==(i=i||{}).agent?i.agent:this.actor},void 0!==i.callback&&(n.callback=i.callback),void 0!==i.lastSHA1&&(n.lastSHA1=i.lastSHA1),void 0!==i.contentType&&(n.contentType=i.contentType,void 0!==i.overwriteJSON&&!i.overwriteJSON&&O.Utils.isApplicationJSON(i.contentType)&&(n.method="POST")),s.saveAgentProfile(t,e,n);this.log("[warning] setAgentProfile: No LRSs added yet (agent profile not saved)")},deleteAgentProfile:function(t,e){var i,n;if(this.log("deleteAgentProfile"),this.recordStores.length>0)return n=this.recordStores[0],i={agent:void 0!==(e=e||{}).agent?e.agent:this.actor},void 0!==e.callback&&(i.callback=e.callback),n.dropAgentProfile(t,i);this.log("[warning] deleteAgentProfile: No LRSs added yet (agent profile not deleted)")}},O.DEBUG=!1,O.enableDebug=function(){O.DEBUG=!0},O.disableDebug=function(){O.DEBUG=!1},O.versions=function(){return["1.0.2","1.0.1","1.0.0","0.95","0.9"]},"object"==typeof module&&(module.exports=O),O.Utils={defaultEncoding:"utf8",getUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}))},getISODateString:function(t){function e(t,e){var i,n;for(null==t&&(t=0),null==e&&(e=2),i=Math.pow(10,e-1),n=t.toString();t<i&&i>1;)n="0"+n,i/=10;return n}return t.getUTCFullYear()+"-"+e(t.getUTCMonth()+1)+"-"+e(t.getUTCDate())+"T"+e(t.getUTCHours())+":"+e(t.getUTCMinutes())+":"+e(t.getUTCSeconds())+"."+e(t.getUTCMilliseconds(),3)+"Z"},convertISO8601DurationToMilliseconds:function(t){var e,i,n,s,r=t.indexOf("-")>=0,o=t.indexOf("T"),a=t.indexOf("H"),c=t.indexOf("M"),l=t.indexOf("S");if(-1===o||-1!==c&&c<o||-1!==t.indexOf("D")||-1!==t.indexOf("Y"))throw new Error("ISO 8601 timestamps including years, months and/or days are not currently supported");return-1===a?(a=o,e=0):e=parseInt(t.slice(o+1,a),10),-1===c?(c=o,i=0):i=parseInt(t.slice(a+1,c),10),n=parseFloat(t.slice(c+1,l)),s=parseInt(1e3*(60*(60*e+i)+n),10),isNaN(s)&&(s=0),r&&(s*=-1),s},convertMillisecondsToISO8601Duration:function(t){var e,i,n,s=parseInt(t,10),r="",o="";return(n=Math.round(s/10))<0&&(r="-",n*=-1),o=r+"PT",(e=parseInt(n/36e4,10))>0&&(o+=e+"H"),(i=parseInt(n%36e4/6e3,10))>0&&(o+=i+"M"),o+=n%36e4%6e3/100+"S"},getSHA1String:function(t){return S.SHA1(t).toString(S.enc.Hex)},getSHA256String:function(t){return"[object ArrayBuffer]"===Object.prototype.toString.call(t)&&(t=S.lib.WordArray.create(t)),S.SHA256(t).toString(S.enc.Hex)},getBase64String:function(t){return S.enc.Base64.stringify(S.enc.Latin1.parse(t))},getLangDictionaryValue:function(t,e){var i,n=this[t];if(void 0!==e&&void 0!==n[e])return n[e];if(void 0!==n.und)return n.und;if(void 0!==n["en-US"])return n["en-US"];for(i in n)if(n.hasOwnProperty(i))return n[i];return""},parseURL:function(t,e){var i,n,s,r,o="/"===t.charAt(0),a=["(/[^?#]*)","(\\?[^#]*|)","(#.*|)$"],c=/\+/g,l=/([^&=]+)=?([^&]*)/g,u=function(t){return decodeURIComponent(t.replace(c," "))};if(e=e||{},o){if(void 0===e.allowRelative||!e.allowRelative)throw new Error("Refusing to parse relative URL without 'allowRelative' option")}else a.unshift("^(file|https?)://","(([^:/?#]*)(?::([0-9]+))?)"),-1===t.indexOf("/",8)&&(t+="/");if(i=new RegExp(a.join("")),null===(n=t.match(i)))throw new Error("Unable to parse URL regular expression did not match: '"+t+"'");if(o?(s={protocol:null,host:null,hostname:null,port:null,path:null,pathname:n[1],search:n[2],hash:n[3],params:{}}).path=s.pathname:(s={protocol:n[1],host:n[2],hostname:n[3],port:n[4],pathname:n[5],search:n[6],hash:n[7],params:{}}).path=s.protocol+"//"+s.host+s.pathname,""!==s.search)for(;r=l.exec(s.search.substring(1));)s.params[u(r[1])]=u(r[2]);return s},getServerRoot:function(t){var e=t.split("/");return e[0]+"//"+e[2]},getContentTypeFromHeader:function(t){return String(t).split(";")[0]},isApplicationJSON:function(t){return 0===O.Utils.getContentTypeFromHeader(t).toLowerCase().indexOf("application/json")},stringToArrayBuffer:function(){O.prototype.log("stringToArrayBuffer not overloaded - no environment loaded?")},stringFromArrayBuffer:function(){O.prototype.log("stringFromArrayBuffer not overloaded - no environment loaded?")}},(C=O.LRS=function(t){this.log("constructor"),this.endpoint=null,this.version=null,this.auth=null,this.allowFail=!0,this.extended=null,this.init(t)}).prototype={LOG_SRC:"LRS",log:O.prototype.log,init:function(t){this.log("init");var e,i=O.versions(),n=!1;if((t=t||{}).hasOwnProperty("alertOnRequestFailure")&&this.log("'alertOnRequestFailure' is deprecated (alerts have been removed) no need to set it now"),!t.hasOwnProperty("endpoint")||null===t.endpoint||""===t.endpoint)throw this.log("[error] LRS invalid: no endpoint"),{code:3,mesg:"LRS invalid: no endpoint"};if(this.endpoint=String(t.endpoint),"/"!==this.endpoint.slice(-1)&&(this.log("adding trailing slash to endpoint"),this.endpoint+="/"),t.hasOwnProperty("allowFail")&&(this.allowFail=t.allowFail),t.hasOwnProperty("auth")?this.auth=t.auth:t.hasOwnProperty("username")&&t.hasOwnProperty("password")&&(this.auth="Basic "+O.Utils.getBase64String(t.username+":"+t.password)),t.hasOwnProperty("extended")&&(this.extended=t.extended),this._initByEnvironment(t),void 0!==t.version){for(this.log("version: "+t.version),e=0;e<i.length;e+=1)if(i[e]===t.version){n=!0;break}if(!n)throw this.log("[error] LRS invalid: version not supported ("+t.version+")"),{code:5,mesg:"LRS invalid: version not supported ("+t.version+")"};this.version=t.version}else this.version=i[0]},_getBoundary:function(){return O.Utils.getUUID().replace(/-/g,"")},_initByEnvironment:function(){this.log("_initByEnvironment not overloaded - no environment loaded?")},_makeRequest:function(){this.log("_makeRequest not overloaded - no environment loaded?")},_getMultipartRequestData:function(){this.log("_getMultipartRequestData not overloaded - no environment loaded?")},_IEModeConversion:function(){this.log("_IEModeConversion not overloaded - browser environment not loaded.")},_processGetStatementResult:function(t,e){var i,n,s,r,o={};if(!e.attachments)return O.Statement.fromJSON(t.responseText);for(i=t.getResponseHeader("Content-Type").split("boundary=")[1],n=this._parseMultipart(i,t.response),s=JSON.parse(n[0].body),r=1;r<n.length;r+=1)o[n[r].headers["X-Experience-API-Hash"]]=n[r].body;return this._assignAttachmentContent([s],o),new O.Statement(s)},sendRequest:function(t){this.log("sendRequest");var e,i=this.endpoint+t.url,n={};if(0===t.url.indexOf("http")&&(i=t.url),null!==this.extended)for(e in t.params=t.params||{},this.extended)this.extended.hasOwnProperty(e)&&(t.params.hasOwnProperty(e)||null!==this.extended[e]&&(t.params[e]=this.extended[e]));for(e in n.Authorization=this.auth,"0.9"!==this.version&&(n["X-Experience-API-Version"]=this.version),t.headers)t.headers.hasOwnProperty(e)&&(n[e]=t.headers[e]);return this._makeRequest(i,n,t)},about:function(t){var e,i,n;if(this.log("about"),e={url:"about",method:"GET",params:{}},void 0!==(t=t||{}).callback&&(n=function(e,i){var n=i;null===e&&(n=O.About.fromJSON(i.responseText)),t.callback(e,n)},e.callback=n),i=this.sendRequest(e),!n)return null===i.err&&(i.xhr=O.About.fromJSON(i.xhr.responseText)),i},saveStatement:function(t,e){this.log("saveStatement");var i,n,s,r={url:"statements",headers:{}},o=[];e=e||{};try{i=t.asVersion(this.version)}catch(t){return this.allowFail?(this.log("[warning] statement could not be serialized in version ("+this.version+"): "+t),void 0!==e.callback?void e.callback(null,null):{err:null,xhr:null}):(this.log("[error] statement could not be serialized in version ("+this.version+"): "+t),void 0!==e.callback?void e.callback(t,null):{err:t,xhr:null})}if(i.hasOwnProperty("attachments")&&t.hasAttachmentWithContent()){for(n=this._getBoundary(),r.headers["Content-Type"]="multipart/mixed; boundary="+n,s=0;s<t.attachments.length;s+=1)null!==t.attachments[s].content&&o.push(t.attachments[s]);try{r.data=this._getMultipartRequestData(n,i,o)}catch(t){return this.allowFail?(this.log("[warning] multipart request data could not be created (attachments probably not supported): "+t),void 0!==e.callback?void e.callback(null,null):{err:null,xhr:null}):(this.log("[error] multipart request data could not be created (attachments probably not supported): "+t),void 0!==e.callback?void e.callback(t,null):{err:t,xhr:null})}}else r.headers["Content-Type"]="application/json",r.data=JSON.stringify(i);return null!==t.id?(r.method="PUT",r.params={statementId:t.id}):r.method="POST",void 0!==e.callback&&(r.callback=e.callback),this.sendRequest(r)},retrieveStatement:function(t,e){this.log("retrieveStatement");var i,n,s,r=this;return(e=e||{}).params=e.params||{},i={url:"statements",method:"GET",params:{statementId:t}},e.params.attachments&&(i.params.attachments=!0,i.expectMultipart=!0),void 0!==e.callback&&(s=function(t,i){var n=i;null===t&&(n=r._processGetStatementResult(i,e.params)),e.callback(t,n)},i.callback=s),n=this.sendRequest(i),s||(n.statement=null,null===n.err&&(n.statement=r._processGetStatementResult(n.xhr,e.params))),n},retrieveVoidedStatement:function(t,e){this.log("retrieveVoidedStatement");var i,n,s,r=this;return(e=e||{}).params=e.params||{},i={url:"statements",method:"GET",params:{}},"0.9"===this.version||"0.95"===this.version?i.params.statementId=t:(i.params.voidedStatementId=t,e.params.attachments&&(i.params.attachments=!0,i.expectMultipart=!0)),void 0!==e.callback&&(s=function(t,i){var n=i;null===t&&(n=r._processGetStatementResult(i,e.params)),e.callback(t,n)},i.callback=s),n=this.sendRequest(i),s||(n.statement=null,null===n.err&&(n.statement=r._processGetStatementResult(n.xhr,e.params))),n},saveStatements:function(t,e){this.log("saveStatements");var i,n,s,r,o={url:"statements",method:"POST",headers:{}},a=[],c=[];if(e=e||{},0===t.length)return void 0!==e.callback?void e.callback(new Error("no statements"),null):{err:new Error("no statements"),xhr:null};for(s=0;s<t.length;s+=1){try{i=t[s].asVersion(this.version)}catch(t){return this.allowFail?(this.log("[warning] statement could not be serialized in version ("+this.version+"): "+t),void 0!==e.callback?void e.callback(null,null):{err:null,xhr:null}):(this.log("[error] statement could not be serialized in version ("+this.version+"): "+t),void 0!==e.callback?void e.callback(t,null):{err:t,xhr:null})}if(t[s].hasAttachmentWithContent())for(r=0;r<t[s].attachments.length;r+=1)null!==t[s].attachments[r].content&&c.push(t[s].attachments[r]);a.push(i)}if(0!==c.length){n=this._getBoundary(),o.headers["Content-Type"]="multipart/mixed; boundary="+n;try{o.data=this._getMultipartRequestData(n,a,c)}catch(t){return this.allowFail?(this.log("[warning] multipart request data could not be created (attachments probably not supported): "+t),void 0!==e.callback?void e.callback(null,null):{err:null,xhr:null}):(this.log("[error] multipart request data could not be created (attachments probably not supported): "+t),void 0!==e.callback?void e.callback(t,null):{err:t,xhr:null})}}else o.headers["Content-Type"]="application/json",o.data=JSON.stringify(a);return void 0!==e.callback&&(o.callback=e.callback),this.sendRequest(o)},queryStatements:function(t){this.log("queryStatements");var e,i,n,s=this;(t=t||{}).params=t.params||{};try{e=this._queryStatementsRequestCfg(t),t.params.attachments&&(e.expectMultipart=!0)}catch(e){return this.log("[error] Query statements failed - "+e),void 0!==t.callback&&t.callback(e,{}),{err:e,statementsResult:null}}return void 0!==t.callback&&(n=function(e,i){var n,r,o,a,c=i,l={};if(null===e)if(t.params.attachments){for(r=i.getResponseHeader("Content-Type").split("boundary=")[1],n=s._parseMultipart(r,i.response),o=JSON.parse(n[0].body),a=1;a<n.length;a+=1)l[n[a].headers["X-Experience-API-Hash"]]=n[a].body;for(s._assignAttachmentContent(o.statements,l),c=new O.StatementsResult({statements:o.statements}),a=0;a<c.statements.length;a+=1)c.statements[a]instanceof O.Statement||(c.statements[a]=new O.Statement(c.statements[a]))}else c=O.StatementsResult.fromJSON(i.responseText);t.callback(e,c)},e.callback=n),(i=this.sendRequest(e)).config=e,n||(i.statementsResult=null,null===i.err&&(i.statementsResult=O.StatementsResult.fromJSON(i.xhr.responseText))),i},_queryStatementsRequestCfg:function(t){this.log("_queryStatementsRequestCfg");var e,i,n={},s={url:"statements",method:"GET",params:n},r=["agent","actor","object","instructor"],o=["verb","activity"],a=["registration","context","since","until","limit","authoritative","sparse","ascending","related_activities","related_agents","format","attachments"],c={verb:!0,registration:!0,since:!0,until:!0,limit:!0,ascending:!0},l={.9:{supported:{actor:!0,instructor:!0,target:!0,object:!0,context:!0,authoritative:!0,sparse:!0}},"1.0.0":{supported:{agent:!0,activity:!0,related_activities:!0,related_agents:!0,format:!0,attachments:!0}}};for(i in l[.95]=l[.9],l["1.0.1"]=l["1.0.0"],l["1.0.2"]=l["1.0.0"],t.params.hasOwnProperty("target")&&(t.params.object=t.params.target),t.params)if(t.params.hasOwnProperty(i)&&void 0===c[i]&&void 0===l[this.version].supported[i])throw"Unrecognized query parameter configured: "+i;for(e=0;e<r.length;e+=1)void 0!==t.params[r[e]]&&(n[r[e]]=JSON.stringify(t.params[r[e]].asVersion(this.version)));for(e=0;e<o.length;e+=1)void 0!==t.params[o[e]]&&(void 0===t.params[o[e]].id?n[o[e]]=t.params[o[e]]:n[o[e]]=t.params[o[e]].id);for(e=0;e<a.length;e+=1)void 0!==t.params[a[e]]&&null!==t.params[a[e]]&&(n[a[e]]=t.params[a[e]]);return s},_assignAttachmentContent:function(t,e){var i,n;for(i=0;i<t.length;i+=1)if(t[i].hasOwnProperty("attachments")&&null!==t[i].attachments)for(n=0;n<t[i].attachments.length;n+=1)e.hasOwnProperty(t[i].attachments[n].sha2)&&(t[i].attachments[n].content=e[t[i].attachments[n].sha2])},_parseMultipart:function(t,e){var i,n,s,r,o,a,c,l,u,h,d,p="--"+t,f=[];for(i=new Uint8Array(e),s=(n=this.__uint8ToString(i)).indexOf(p+"--"),r=n.indexOf(p);-1!==r;)o=n.indexOf(p,r+p.length),a=r+p.length+2,l=(c=n.indexOf("\r\n\r\n",r))+2+2,u=o-2,h=this._parseHeaders(this.__uint8ToString(new Uint8Array(e.slice(a,c)))),d=e.slice(l,u),0===f.length&&(d=O.Utils.stringFromArrayBuffer(d)),f.push({headers:h,body:d}),r=o===s?-1:o;return f},__uint8ToString:function(t){var e,i="",n=t.byteLength;for(e=0;e<n;e+=1)i+=String.fromCharCode(t[e]);return i},_parseHeaders:function(t){var e,i,n,s={};for(e=t.split("\n"),n=0;n<e.length;n+=1)null!==(i=e[n].split(":",2))[1]?(s[i[0]]=i[1].replace(/^\s+|\s+$/g,""),i[0]):"\t"===i[0].substring(0,1)&&(s[i[0]]=i[1].replace(/^\s+|\s+$/g,""));return s},moreStatements:function(t){var e,i,n,s,r;return this.log("moreStatements: "+t.url),t=t||{},s=O.Utils.parseURL(t.url,{allowRelative:!0}),r=O.Utils.getServerRoot(this.endpoint),0===s.path.indexOf("/statements")&&(s.path=this.endpoint.replace(r,"")+s.path,this.log("converting non-standard more URL to "+s.path)),0!==s.path.indexOf("/")&&(s.path="/"+s.path),e={method:"GET",url:r+s.path,params:s.params},void 0!==t.callback&&(n=function(e,i){var n=i;null===e&&(n=O.StatementsResult.fromJSON(i.responseText)),t.callback(e,n)},e.callback=n),(i=this.sendRequest(e)).config=e,n||(i.statementsResult=null,null===i.err&&(i.statementsResult=O.StatementsResult.fromJSON(i.xhr.responseText))),i},retrieveState:function(t,e){this.log("retrieveState");var i,n,s,r={},o={},a=this;if(s=e.requestHeaders||{},r={stateId:t,activityId:e.activity.id},"0.9"===this.version?r.actor=JSON.stringify(e.agent.asVersion(this.version)):r.agent=JSON.stringify(e.agent.asVersion(this.version)),void 0!==e.registration&&null!==e.registration&&("0.9"===this.version?r.registrationId=e.registration:r.registration=e.registration),o={url:"activities/state",method:"GET",params:r,ignore404:!0,headers:s},void 0!==e.callback&&(n=function(i,n){var s=n;if(null===i)if(404===n.status)s=null;else if(s=new O.State({id:t,contents:n.responseText}),void 0!==n.getResponseHeader&&null!==n.getResponseHeader("ETag")&&""!==n.getResponseHeader("ETag")?s.etag=n.getResponseHeader("ETag"):s.etag='"'+O.Utils.getSHA1String(n.responseText)+'"',void 0!==n.contentType?s.contentType=n.contentType:void 0!==n.getResponseHeader&&null!==n.getResponseHeader("Content-Type")&&""!==n.getResponseHeader("Content-Type")&&(s.contentType=n.getResponseHeader("Content-Type")),O.Utils.isApplicationJSON(s.contentType))try{s.contents=JSON.parse(s.contents)}catch(t){a.log("retrieveState - failed to deserialize JSON: "+t)}e.callback(i,s)},o.callback=n),i=this.sendRequest(o),!n&&(i.state=null,null===i.err&&404!==i.xhr.status&&(i.state=new O.State({id:t,contents:i.xhr.responseText}),void 0!==i.xhr.getResponseHeader&&null!==i.xhr.getResponseHeader("ETag")&&""!==i.xhr.getResponseHeader("ETag")?i.state.etag=i.xhr.getResponseHeader("ETag"):i.state.etag='"'+O.Utils.getSHA1String(i.xhr.responseText)+'"',void 0!==i.xhr.contentType?i.state.contentType=i.xhr.contentType:void 0!==i.xhr.getResponseHeader&&null!==i.xhr.getResponseHeader("Content-Type")&&""!==i.xhr.getResponseHeader("Content-Type")&&(i.state.contentType=i.xhr.getResponseHeader("Content-Type")),O.Utils.isApplicationJSON(i.state.contentType))))try{i.state.contents=JSON.parse(i.state.contents)}catch(t){this.log("retrieveState - failed to deserialize JSON: "+t)}return i},retrieveStateIds:function(t){this.log("retrieveStateIds");var e,i,n,s,r={};if(i=(t=t||{}).requestHeaders||{},r.activityId=t.activity.id,"0.9"===this.version?r.actor=JSON.stringify(t.agent.asVersion(this.version)):r.agent=JSON.stringify(t.agent.asVersion(this.version)),void 0!==t.registration&&null!==t.registration&&("0.9"===this.version?r.registrationId=t.registration:r.registration=t.registration),e={url:"activities/state",method:"GET",params:r,headers:i,ignore404:!0},void 0!==t.callback&&(s=function(e,i){var n=i;if(null===e){if(404===i.status)n=[];else try{n=JSON.parse(i.responseText)}catch(t){e="Response JSON parse error: "+t}t.callback(e,n)}else t.callback(e,n)},e.callback=s),void 0!==t.since&&(e.params.since=t.since),n=this.sendRequest(e),!s){if(n.profileIds=null,null!==n.err)return n;if(404===n.xhr.status)n.profileIds=[];else try{n.profileIds=JSON.parse(n.xhr.responseText)}catch(t){n.err="retrieveStateIds - JSON parse error: "+t}}return n},saveState:function(t,e,i){var n,s,r;return this.log("saveState"),r=i.requestHeaders||{},void 0===i.contentType&&(i.contentType="application/octet-stream"),r["Content-Type"]=i.contentType,"object"==typeof e&&O.Utils.isApplicationJSON(i.contentType)&&(e=JSON.stringify(e)),void 0!==i.method&&"POST"===i.method||(i.method="PUT"),n={stateId:t,activityId:i.activity.id},"0.9"===this.version?n.actor=JSON.stringify(i.agent.asVersion(this.version)):n.agent=JSON.stringify(i.agent.asVersion(this.version)),void 0!==i.registration&&null!==i.registration&&("0.9"===this.version?n.registrationId=i.registration:n.registration=i.registration),s={url:"activities/state",method:i.method,params:n,data:e,headers:r},void 0!==i.callback&&(s.callback=i.callback),void 0!==i.lastSHA1&&null!==i.lastSHA1&&(s.headers["If-Match"]=i.lastSHA1),this.sendRequest(s)},dropState:function(t,e){var i,n,s;return this.log("dropState"),s=e.requestHeaders||{},i={activityId:e.activity.id},"0.9"===this.version?i.actor=JSON.stringify(e.agent.asVersion(this.version)):i.agent=JSON.stringify(e.agent.asVersion(this.version)),null!==t&&(i.stateId=t),void 0!==e.registration&&null!==e.registration&&("0.9"===this.version?i.registrationId=e.registration:i.registration=e.registration),n={url:"activities/state",method:"DELETE",params:i,headers:s},void 0!==e.callback&&(n.callback=e.callback),this.sendRequest(n)},retrieveActivity:function(t,e){this.log("retrieveActivity");var i,n,s,r={};return s=e.requestHeaders||{},r={url:"activities",method:"GET",params:{activityId:t},ignore404:!0,headers:s},void 0!==e.callback&&(n=function(i,n){var s=n;null===i&&(s=404===n.status?new O.Activity({id:t}):O.Activity.fromJSON(n.responseText)),e.callback(i,s)},r.callback=n),i=this.sendRequest(r),n||(i.activity=null,null===i.err&&(404===i.xhr.status?i.activity=new O.Activity({id:t}):i.activity=O.Activity.fromJSON(i.xhr.responseText))),i},retrieveActivityProfile:function(t,e){this.log("retrieveActivityProfile");var i,n,s,r={},o=this;if(s=e.requestHeaders||{},r={url:"activities/profile",method:"GET",params:{profileId:t,activityId:e.activity.id},ignore404:!0,headers:s},void 0!==e.callback&&(n=function(i,n){var s=n;if(null===i)if(404===n.status)s=null;else if(s=new O.ActivityProfile({id:t,activity:e.activity,contents:n.responseText}),void 0!==n.getResponseHeader&&null!==n.getResponseHeader("ETag")&&""!==n.getResponseHeader("ETag")?s.etag=n.getResponseHeader("ETag"):s.etag='"'+O.Utils.getSHA1String(n.responseText)+'"',void 0!==n.contentType?s.contentType=n.contentType:void 0!==n.getResponseHeader&&null!==n.getResponseHeader("Content-Type")&&""!==n.getResponseHeader("Content-Type")&&(s.contentType=n.getResponseHeader("Content-Type")),O.Utils.isApplicationJSON(s.contentType))try{s.contents=JSON.parse(s.contents)}catch(t){o.log("retrieveActivityProfile - failed to deserialize JSON: "+t)}e.callback(i,s)},r.callback=n),i=this.sendRequest(r),!n&&(i.profile=null,null===i.err&&404!==i.xhr.status&&(i.profile=new O.ActivityProfile({id:t,activity:e.activity,contents:i.xhr.responseText}),void 0!==i.xhr.getResponseHeader&&null!==i.xhr.getResponseHeader("ETag")&&""!==i.xhr.getResponseHeader("ETag")?i.profile.etag=i.xhr.getResponseHeader("ETag"):i.profile.etag='"'+O.Utils.getSHA1String(i.xhr.responseText)+'"',void 0!==i.xhr.contentType?i.profile.contentType=i.xhr.contentType:void 0!==i.xhr.getResponseHeader&&null!==i.xhr.getResponseHeader("Content-Type")&&""!==i.xhr.getResponseHeader("Content-Type")&&(i.profile.contentType=i.xhr.getResponseHeader("Content-Type")),O.Utils.isApplicationJSON(i.profile.contentType))))try{i.profile.contents=JSON.parse(i.profile.contents)}catch(t){this.log("retrieveActivityProfile - failed to deserialize JSON: "+t)}return i},retrieveActivityProfileIds:function(t){var e,i,n,s;if(this.log("retrieveActivityProfileIds"),i=(t=t||{}).requestHeaders||{},e={url:"activities/profile",method:"GET",params:{activityId:t.activity.id},headers:i,ignore404:!0},void 0!==t.callback&&(s=function(e,i){var n=i;if(null===e){if(404===i.status)n=[];else try{n=JSON.parse(i.responseText)}catch(t){e="Response JSON parse error: "+t}t.callback(e,n)}else t.callback(e,n)},e.callback=s),void 0!==t.since&&(e.params.since=t.since),n=this.sendRequest(e),!s){if(n.profileIds=null,null!==n.err)return n;if(404===n.xhr.status)n.profileIds=[];else try{n.profileIds=JSON.parse(n.xhr.responseText)}catch(t){n.err="retrieveActivityProfileIds - JSON parse error: "+t}}return n},saveActivityProfile:function(t,e,i){var n,s;return this.log("saveActivityProfile"),s=i.requestHeaders||{},void 0===i.contentType&&(i.contentType="application/octet-stream"),s["Content-Type"]=i.contentType,void 0!==i.method&&"POST"===i.method||(i.method="PUT"),"object"==typeof e&&O.Utils.isApplicationJSON(i.contentType)&&(e=JSON.stringify(e)),n={url:"activities/profile",method:i.method,params:{profileId:t,activityId:i.activity.id},data:e,headers:s},void 0!==i.callback&&(n.callback=i.callback),void 0!==i.lastSHA1&&null!==i.lastSHA1?n.headers["If-Match"]=i.lastSHA1:n.headers["If-None-Match"]="*",this.sendRequest(n)},dropActivityProfile:function(t,e){var i,n;return this.log("dropActivityProfile"),n=e.requestHeaders||{},i={url:"activities/profile",method:"DELETE",params:{profileId:t,activityId:e.activity.id},headers:n},void 0!==e.callback&&(i.callback=e.callback),this.sendRequest(i)},retrieveAgentProfile:function(t,e){this.log("retrieveAgentProfile");var i,n,s,r={},o=this;if(s=e.requestHeaders||{},r={method:"GET",params:{profileId:t},ignore404:!0,headers:s},"0.9"===this.version?(r.url="actors/profile",r.params.actor=JSON.stringify(e.agent.asVersion(this.version))):(r.url="agents/profile",r.params.agent=JSON.stringify(e.agent.asVersion(this.version))),void 0!==e.callback&&(n=function(i,n){var s=n;if(null===i)if(404===n.status)s=null;else if(s=new O.AgentProfile({id:t,agent:e.agent,contents:n.responseText}),void 0!==n.getResponseHeader&&null!==n.getResponseHeader("ETag")&&""!==n.getResponseHeader("ETag")?s.etag=n.getResponseHeader("ETag"):s.etag='"'+O.Utils.getSHA1String(n.responseText)+'"',void 0!==n.contentType?s.contentType=n.contentType:void 0!==n.getResponseHeader&&null!==n.getResponseHeader("Content-Type")&&""!==n.getResponseHeader("Content-Type")&&(s.contentType=n.getResponseHeader("Content-Type")),O.Utils.isApplicationJSON(s.contentType))try{s.contents=JSON.parse(s.contents)}catch(t){o.log("retrieveAgentProfile - failed to deserialize JSON: "+t)}e.callback(i,s)},r.callback=n),i=this.sendRequest(r),!n&&(i.profile=null,null===i.err&&404!==i.xhr.status&&(i.profile=new O.AgentProfile({id:t,agent:e.agent,contents:i.xhr.responseText}),void 0!==i.xhr.getResponseHeader&&null!==i.xhr.getResponseHeader("ETag")&&""!==i.xhr.getResponseHeader("ETag")?i.profile.etag=i.xhr.getResponseHeader("ETag"):i.profile.etag='"'+O.Utils.getSHA1String(i.xhr.responseText)+'"',void 0!==i.xhr.contentType?i.profile.contentType=i.xhr.contentType:void 0!==i.xhr.getResponseHeader&&null!==i.xhr.getResponseHeader("Content-Type")&&""!==i.xhr.getResponseHeader("Content-Type")&&(i.profile.contentType=i.xhr.getResponseHeader("Content-Type")),O.Utils.isApplicationJSON(i.profile.contentType))))try{i.profile.contents=JSON.parse(i.profile.contents)}catch(t){this.log("retrieveAgentProfile - failed to deserialize JSON: "+t)}return i},retrieveAgentProfileIds:function(t){this.log("retrieveAgentProfileIds");var e,i,n,s={};if(e={method:"GET",params:s,headers:(t=t||{}).requestHeaders||{},ignore404:!0},"0.9"===this.version?(e.url="actors/profile",s.actor=JSON.stringify(t.agent.asVersion(this.version))):(e.url="agents/profile",s.agent=JSON.stringify(t.agent.asVersion(this.version))),void 0!==t.callback&&(n=function(e,i){var n=i;if(null===e){if(404===i.status)n=[];else try{n=JSON.parse(i.responseText)}catch(t){e="Response JSON parse error: "+t}t.callback(e,n)}else t.callback(e,n)},e.callback=n),void 0!==t.since&&(e.params.since=t.since),i=this.sendRequest(e),!n){if(i.profileIds=null,null!==i.err)return i;if(404===i.xhr.status)i.profileIds=[];else try{i.profileIds=JSON.parse(i.xhr.responseText)}catch(t){i.err="retrieveAgentProfileIds - JSON parse error: "+t}}return i},saveAgentProfile:function(t,e,i){var n,s;return this.log("saveAgentProfile"),s=i.requestHeaders||{},void 0===i.contentType&&(i.contentType="application/octet-stream"),s["Content-Type"]=i.contentType,void 0!==i.method&&"POST"===i.method||(i.method="PUT"),"object"==typeof e&&O.Utils.isApplicationJSON(i.contentType)&&(e=JSON.stringify(e)),n={method:i.method,params:{profileId:t},data:e,headers:s},"0.9"===this.version?(n.url="actors/profile",n.params.actor=JSON.stringify(i.agent.asVersion(this.version))):(n.url="agents/profile",n.params.agent=JSON.stringify(i.agent.asVersion(this.version))),void 0!==i.callback&&(n.callback=i.callback),void 0!==i.lastSHA1&&null!==i.lastSHA1?n.headers["If-Match"]=i.lastSHA1:n.headers["If-None-Match"]="*",this.sendRequest(n)},dropAgentProfile:function(t,e){var i,n;return this.log("dropAgentProfile"),n={method:"DELETE",params:i={profileId:t},headers:e.requestHeaders||{}},"0.9"===this.version?(n.url="actors/profile",i.actor=JSON.stringify(e.agent.asVersion(this.version))):(n.url="agents/profile",i.agent=JSON.stringify(e.agent.asVersion(this.version))),void 0!==e.callback&&(n.callback=e.callback),this.sendRequest(n)}},C.syncEnabled=null,(_=O.AgentAccount=function(t){this.log("constructor"),this.homePage=null,this.name=null,this.init(t)}).prototype={LOG_SRC:"AgentAccount",log:O.prototype.log,init:function(t){this.log("init");var e,i=["name","homePage"];for(void 0!==(t=t||{}).accountServiceHomePage&&(t.homePage=t.accountServiceHomePage),void 0!==t.accountName&&(t.name=t.accountName),e=0;e<i.length;e+=1)t.hasOwnProperty(i[e])&&null!==t[i[e]]&&(this[i[e]]=t[i[e]])},toString:function(){this.log("toString");var t="";return null!==this.name||null!==this.homePage?(t+=null!==this.name?this.name:"-",t+=":",t+=null!==this.homePage?this.homePage:"-"):t="AgentAccount: unidentified",t},asVersion:function(t){this.log("asVersion: "+t);var e={};return"0.9"===(t=t||O.versions()[0])?(e.accountName=this.name,e.accountServiceHomePage=this.homePage):(e.name=this.name,e.homePage=this.homePage),e}},_.fromJSON=function(t){_.prototype.log("fromJSON");var e=JSON.parse(t);return new _(e)},(D=O.Agent=function(t){this.log("constructor"),this.name=null,this.mbox=null,this.mbox_sha1sum=null,this.openid=null,this.account=null,this.degraded=!1,this.init(t)}).prototype={objectType:"Agent",LOG_SRC:"Agent",log:O.prototype.log,init:function(t){this.log("init");var e,i,n=["name","mbox","mbox_sha1sum","openid"];for(void 0!==(t=t||{}).lastName||void 0!==t.firstName?(t.name="",void 0!==t.firstName&&t.firstName.length>0&&(t.name=t.firstName[0],t.firstName.length>1&&(this.degraded=!0)),""!==t.name&&(t.name+=" "),void 0!==t.lastName&&t.lastName.length>0&&(t.name+=t.lastName[0],t.lastName.length>1&&(this.degraded=!0))):void 0===t.familyName&&void 0===t.givenName||(t.name="",void 0!==t.givenName&&t.givenName.length>0&&(t.name=t.givenName[0],t.givenName.length>1&&(this.degraded=!0)),""!==t.name&&(t.name+=" "),void 0!==t.familyName&&t.familyName.length>0&&(t.name+=t.familyName[0],t.familyName.length>1&&(this.degraded=!0))),"object"==typeof t.name&&null!==t.name&&(t.name.length>1&&(this.degraded=!0),t.name=t.name[0]),"object"==typeof t.mbox&&null!==t.mbox&&(t.mbox.length>1&&(this.degraded=!0),t.mbox=t.mbox[0]),"object"==typeof t.mbox_sha1sum&&null!==t.mbox_sha1sum&&(t.mbox_sha1sum.length>1&&(this.degraded=!0),t.mbox_sha1sum=t.mbox_sha1sum[0]),"object"==typeof t.openid&&null!==t.openid&&(t.openid.length>1&&(this.degraded=!0),t.openid=t.openid[0]),"object"==typeof t.account&&null!==t.account&&void 0===t.account.homePage&&void 0===t.account.name&&(0===t.account.length?delete t.account:(t.account.length>1&&(this.degraded=!0),t.account=t.account[0])),t.hasOwnProperty("account")&&(t.account instanceof O.AgentAccount?this.account=t.account:this.account=new O.AgentAccount(t.account)),e=0;e<n.length;e+=1)t.hasOwnProperty(n[e])&&null!==t[n[e]]&&(i=t[n[e]],"mbox"===n[e]&&-1===i.indexOf("mailto:")&&(i="mailto:"+i),this[n[e]]=i)},toString:function(){return this.log("toString"),null!==this.name?this.name:null!==this.mbox?this.mbox.replace("mailto:",""):null!==this.mbox_sha1sum?this.mbox_sha1sum:null!==this.openid?this.openid:null!==this.account?this.account.toString():this.objectType+": unidentified"},asVersion:function(t){this.log("asVersion: "+t);var e={objectType:this.objectType};return"0.9"===(t=t||O.versions()[0])?(null!==this.mbox?e.mbox=[this.mbox]:null!==this.mbox_sha1sum?e.mbox_sha1sum=[this.mbox_sha1sum]:null!==this.openid?e.openid=[this.openid]:null!==this.account&&(e.account=[this.account.asVersion(t)]),null!==this.name&&(e.name=[this.name])):(null!==this.mbox?e.mbox=this.mbox:null!==this.mbox_sha1sum?e.mbox_sha1sum=this.mbox_sha1sum:null!==this.openid?e.openid=this.openid:null!==this.account&&(e.account=this.account.asVersion(t)),null!==this.name&&(e.name=this.name)),e}},D.fromJSON=function(t){D.prototype.log("fromJSON");var e=JSON.parse(t);return new D(e)},(A=O.Group=function(t){this.log("constructor"),this.name=null,this.mbox=null,this.mbox_sha1sum=null,this.openid=null,this.account=null,this.member=[],this.init(t)}).prototype={objectType:"Group",LOG_SRC:"Group",log:O.prototype.log,init:function(t){var e;if(this.log("init"),t=t||{},O.Agent.prototype.init.call(this,t),void 0!==t.member)for(e=0;e<t.member.length;e+=1)t.member[e]instanceof O.Agent?this.member.push(t.member[e]):this.member.push(new O.Agent(t.member[e]))},toString:function(t){this.log("toString");var e=O.Agent.prototype.toString.call(this,t);return e!==this.objectType+": unidentified"&&(e=this.objectType+": "+e),e},asVersion:function(t){var e,i;if(this.log("asVersion: "+t),t=t||O.versions()[0],e=O.Agent.prototype.asVersion.call(this,t),this.member.length>0)for(e.member=[],i=0;i<this.member.length;i+=1)e.member.push(this.member[i].asVersion(t));return e}},A.fromJSON=function(t){A.prototype.log("fromJSON");var e=JSON.parse(t);return new A(e)},R={"http://adlnet.gov/expapi/verbs/experienced":"experienced","http://adlnet.gov/expapi/verbs/attended":"attended","http://adlnet.gov/expapi/verbs/attempted":"attempted","http://adlnet.gov/expapi/verbs/completed":"completed","http://adlnet.gov/expapi/verbs/passed":"passed","http://adlnet.gov/expapi/verbs/failed":"failed","http://adlnet.gov/expapi/verbs/answered":"answered","http://adlnet.gov/expapi/verbs/interacted":"interacted","http://adlnet.gov/expapi/verbs/imported":"imported","http://adlnet.gov/expapi/verbs/created":"created","http://adlnet.gov/expapi/verbs/shared":"shared","http://adlnet.gov/expapi/verbs/voided":"voided"},(T=O.Verb=function(t){this.log("constructor"),this.id=null,this.display=null,this.init(t)}).prototype={LOG_SRC:"Verb",log:O.prototype.log,init:function(t){this.log("init");var e,i,n=["id","display"];if("string"==typeof t){for(i in this.id=t,this.display={und:this.id},R)if(R.hasOwnProperty(i)&&R[i]===t){this.id=i;break}}else{for(t=t||{},e=0;e<n.length;e+=1)t.hasOwnProperty(n[e])&&null!==t[n[e]]&&(this[n[e]]=t[n[e]]);null===this.display&&void 0!==R[this.id]&&(this.display={und:R[this.id]})}},toString:function(t){return this.log("toString"),null!==this.display?this.getLangDictionaryValue("display",t):this.id},asVersion:function(t){var e;return this.log("asVersion"),"0.9"===(t=t||O.versions()[0])?e=R[this.id]:(e={id:this.id},null!==this.display&&(e.display=this.display)),e},getLangDictionaryValue:O.Utils.getLangDictionaryValue},T.fromJSON=function(t){T.prototype.log("fromJSON");var e=JSON.parse(t);return new T(e)},(P=O.Result=function(t){this.log("constructor"),this.score=null,this.success=null,this.completion=null,this.duration=null,this.response=null,this.extensions=null,this.init(t)}).prototype={LOG_SRC:"Result",log:O.prototype.log,init:function(t){this.log("init");var e,i=["completion","duration","extensions","response","success"];for((t=t||{}).hasOwnProperty("score")&&null!==t.score&&(t.score instanceof O.Score?this.score=t.score:this.score=new O.Score(t.score)),e=0;e<i.length;e+=1)t.hasOwnProperty(i[e])&&null!==t[i[e]]&&(this[i[e]]=t[i[e]]);"Completed"===this.completion&&(this.completion=!0)},asVersion:function(t){this.log("asVersion");var e,i={},n=["success","duration","response","extensions"],s=["score"];for(t=t||O.versions()[0],e=0;e<n.length;e+=1)null!==this[n[e]]&&(i[n[e]]=this[n[e]]);for(e=0;e<s.length;e+=1)null!==this[s[e]]&&(i[s[e]]=this[s[e]].asVersion(t));return null!==this.completion&&("0.9"===t?this.completion&&(i.completion="Completed"):i.completion=this.completion),i}},P.fromJSON=function(t){P.prototype.log("fromJSON");var e=JSON.parse(t);return new P(e)},(I=O.Score=function(t){this.log("constructor"),this.scaled=null,this.raw=null,this.min=null,this.max=null,this.init(t)}).prototype={LOG_SRC:"Score",log:O.prototype.log,init:function(t){this.log("init");var e,i=["scaled","raw","min","max"];for(t=t||{},e=0;e<i.length;e+=1)t.hasOwnProperty(i[e])&&null!==t[i[e]]&&(this[i[e]]=t[i[e]])},asVersion:function(t){this.log("asVersion");var e,i={},n=["scaled","raw","min","max"];for(t=t||O.versions()[0],e=0;e<n.length;e+=1)null!==this[n[e]]&&(i[n[e]]=this[n[e]]);return i}},I.fromJSON=function(t){I.prototype.log("fromJSON");var e=JSON.parse(t);return new I(e)},(k=O.InteractionComponent=function(t){this.log("constructor"),this.id=null,this.description=null,this.init(t)}).prototype={LOG_SRC:"InteractionComponent",log:O.prototype.log,init:function(t){this.log("init");var e,i=["id","description"];for(t=t||{},e=0;e<i.length;e+=1)t.hasOwnProperty(i[e])&&null!==t[i[e]]&&(this[i[e]]=t[i[e]])},asVersion:function(t){this.log("asVersion");var e,i,n={id:this.id},s=["description"];for(t=t||O.versions()[0],e=0;e<s.length;e+=1)null!==this[i=s[e]]&&(n[i]=this[i]);return n},getLangDictionaryValue:O.Utils.getLangDictionaryValue},k.fromJSON=function(t){k.prototype.log("fromJSON");var e=JSON.parse(t);return new k(e)},function(){var t={"http://adlnet.gov/expapi/activities/course":"course","http://adlnet.gov/expapi/activities/module":"module","http://adlnet.gov/expapi/activities/meeting":"meeting","http://adlnet.gov/expapi/activities/media":"media","http://adlnet.gov/expapi/activities/performance":"performance","http://adlnet.gov/expapi/activities/simulation":"simulation","http://adlnet.gov/expapi/activities/assessment":"assessment","http://adlnet.gov/expapi/activities/interaction":"interaction","http://adlnet.gov/expapi/activities/cmi.interaction":"cmi.interaction","http://adlnet.gov/expapi/activities/question":"question","http://adlnet.gov/expapi/activities/objective":"objective","http://adlnet.gov/expapi/activities/link":"link"},e=O.ActivityDefinition=function(t){this.log("constructor"),this.name=null,this.description=null,this.type=null,this.moreInfo=null,this.extensions=null,this.interactionType=null,this.correctResponsesPattern=null,this.choices=null,this.scale=null,this.source=null,this.target=null,this.steps=null,this.init(t)};e.prototype={LOG_SRC:"ActivityDefinition",log:O.prototype.log,init:function(e){this.log("init");var i,n,s,r=["name","description","moreInfo","extensions","correctResponsesPattern"],o=[];if((e=e||{}).hasOwnProperty("type")&&null!==e.type){for(s in t)t.hasOwnProperty(s)&&t[s]===e.type&&(e.type=t[s]);this.type=e.type}if(e.hasOwnProperty("interactionType")&&null!==e.interactionType&&(this.interactionType=e.interactionType,"choice"===e.interactionType||"sequencing"===e.interactionType?o.push("choices"):"likert"===e.interactionType?o.push("scale"):"matching"===e.interactionType?(o.push("source"),o.push("target")):"performance"===e.interactionType&&o.push("steps"),o.length>0))for(i=0;i<o.length;i+=1)if(s=o[i],e.hasOwnProperty(s)&&null!==e[s])for(this[s]=[],n=0;n<e[s].length;n+=1)e[s][n]instanceof O.InteractionComponent?this[s].push(e[s][n]):this[s].push(new O.InteractionComponent(e[s][n]));for(i=0;i<r.length;i+=1)e.hasOwnProperty(r[i])&&null!==e[r[i]]&&(this[r[i]]=e[r[i]])},toString:function(t){return this.log("toString"),null!==this.name?this.getLangDictionaryValue("name",t):null!==this.description?this.getLangDictionaryValue("description",t):""},asVersion:function(e){this.log("asVersion");var i,n,s,r={},o=["name","description","interactionType","correctResponsesPattern","extensions"],a=["choices","scale","source","target","steps"];for(e=e||O.versions()[0],null!==this.type&&(r.type="0.9"===e?t[this.type]:this.type),i=0;i<o.length;i+=1)null!==this[s=o[i]]&&(r[s]=this[s]);for(i=0;i<a.length;i+=1)if(null!==this[s=a[i]])for(r[s]=[],n=0;n<this[s].length;n+=1)r[s].push(this[s][n].asVersion(e));return 0!==e.indexOf("0.9")&&null!==this.moreInfo&&(r.moreInfo=this.moreInfo),r},getLangDictionaryValue:O.Utils.getLangDictionaryValue},e.fromJSON=function(t){e.prototype.log("fromJSON");var i=JSON.parse(t);return new e(i)}}(),(E=O.Activity=function(t){this.log("constructor"),this.objectType="Activity",this.id=null,this.definition=null,this.init(t)}).prototype={LOG_SRC:"Activity",log:O.prototype.log,init:function(t){this.log("init");var e,i=["id"];for((t=t||{}).hasOwnProperty("definition")&&(t.definition instanceof O.ActivityDefinition?this.definition=t.definition:this.definition=new O.ActivityDefinition(t.definition)),e=0;e<i.length;e+=1)t.hasOwnProperty(i[e])&&null!==t[i[e]]&&(this[i[e]]=t[i[e]])},toString:function(t){this.log("toString");var e="";return null!==this.definition&&""!==(e=this.definition.toString(t))?e:null!==this.id?this.id:"Activity: unidentified"},asVersion:function(t){this.log("asVersion");var e={id:this.id,objectType:this.objectType};return t=t||O.versions()[0],null!==this.definition&&(e.definition=this.definition.asVersion(t)),e}},E.fromJSON=function(t){E.prototype.log("fromJSON");var e=JSON.parse(t);return new E(e)},(N=O.ContextActivities=function(t){this.log("constructor"),this.category=null,this.parent=null,this.grouping=null,this.other=null,this.init(t)}).prototype={LOG_SRC:"ContextActivities",log:O.prototype.log,init:function(t){this.log("init");var e,i,n,s,r=["category","parent","grouping","other"];for(t=t||{},e=0;e<r.length;e+=1)if(n=r[e],t.hasOwnProperty(n)&&null!==t[n])if("[object Array]"===Object.prototype.toString.call(t[n]))for(i=0;i<t[n].length;i+=1)this.add(n,t[n][i]);else s=t[n],this.add(n,s)},add:function(t,e){if("category"===t||"parent"===t||"grouping"===t||"other"===t)return null===this[t]&&(this[t]=[]),e instanceof O.Activity||(e="string"==typeof e?{id:e}:e,e=new O.Activity(e)),this[t].push(e),this[t].length-1},asVersion:function(t){this.log("asVersion");var e,i,n={},s=["parent","grouping","other"];for(t=t||O.versions()[0],e=0;e<s.length;e+=1)if(null!==this[s[e]]&&this[s[e]].length>0)if("0.9"===t||"0.95"===t)this[s[e]].length>1&&this.log("[warning] version does not support multiple values in: "+s[e]),n[s[e]]=this[s[e]][0].asVersion(t);else for(n[s[e]]=[],i=0;i<this[s[e]].length;i+=1)n[s[e]].push(this[s[e]][i].asVersion(t));if(null!==this.category&&this.category.length>0){if("0.9"===t||"0.95"===t)throw this.log("[error] version does not support the 'category' property: "+t),new Error(t+" does not support the 'category' property");for(n.category=[],e=0;e<this.category.length;e+=1)n.category.push(this.category[e].asVersion(t))}return n}},N.fromJSON=function(t){N.prototype.log("fromJSON");var e=JSON.parse(t);return new N(e)},(M=O.Context=function(t){this.log("constructor"),this.registration=null,this.instructor=null,this.team=null,this.contextActivities=null,this.revision=null,this.platform=null,this.language=null,this.statement=null,this.extensions=null,this.init(t)}).prototype={LOG_SRC:"Context",log:O.prototype.log,init:function(t){this.log("init");var e,i,n,s=["registration","revision","platform","language","extensions"],r=["instructor","team"];for(t=t||{},e=0;e<s.length;e+=1)i=s[e],t.hasOwnProperty(i)&&null!==t[i]&&(this[i]=t[i]);for(e=0;e<r.length;e+=1)i=r[e],t.hasOwnProperty(i)&&null!==t[i]&&(void 0!==(n=t[i]).objectType&&"Person"!==n.objectType||(n.objectType="Agent"),"Agent"!==n.objectType||n instanceof O.Agent?"Group"!==n.objectType||n instanceof O.Group||(n=new O.Group(n)):n=new O.Agent(n),this[i]=n);t.hasOwnProperty("contextActivities")&&null!==t.contextActivities&&(t.contextActivities instanceof O.ContextActivities?this.contextActivities=t.contextActivities:this.contextActivities=new O.ContextActivities(t.contextActivities)),t.hasOwnProperty("statement")&&null!==t.statement&&(t.statement instanceof O.StatementRef||t.statement instanceof O.SubStatement?this.statement=t.statement:"StatementRef"===t.statement.objectType?this.statement=new O.StatementRef(t.statement):"SubStatement"===t.statement.objectType?this.statement=new O.SubStatement(t.statement):this.log("Unable to parse statement.context.statement property."))},asVersion:function(t){this.log("asVersion");var e,i={},n=["registration","revision","platform","language","extensions"],s=["instructor","team","contextActivities","statement"];if(t=t||O.versions()[0],this.statement instanceof O.SubStatement&&"0.9"!==t&&"0.95"!==t)throw this.log("[error] version does not support SubStatements in the 'statement' property: "+t),new Error(t+" does not support SubStatements in the 'statement' property");for(e=0;e<n.length;e+=1)null!==this[n[e]]&&(i[n[e]]=this[n[e]]);for(e=0;e<s.length;e+=1)null!==this[s[e]]&&(i[s[e]]=this[s[e]].asVersion(t));return i}},M.fromJSON=function(t){M.prototype.log("fromJSON");var e=JSON.parse(t);return new M(e)},(U=O.StatementRef=function(t){this.log("constructor"),this.id=null,this.init(t)}).prototype={objectType:"StatementRef",LOG_SRC:"StatementRef",log:O.prototype.log,init:function(t){this.log("init");var e,i=["id"];for(t=t||{},e=0;e<i.length;e+=1)t.hasOwnProperty(i[e])&&null!==t[i[e]]&&(this[i[e]]=t[i[e]])},toString:function(){return this.log("toString"),this.id},asVersion:function(t){this.log("asVersion");var e={objectType:this.objectType,id:this.id};return"0.9"===t&&(e.objectType="Statement"),e}},U.fromJSON=function(t){U.prototype.log("fromJSON");var e=JSON.parse(t);return new U(e)},(L=O.SubStatement=function(t){this.log("constructor"),this.actor=null,this.verb=null,this.target=null,this.result=null,this.context=null,this.timestamp=null,this.init(t)}).prototype={objectType:"SubStatement",LOG_SRC:"SubStatement",log:O.prototype.log,init:function(t){this.log("init");var e,i=["timestamp"];for((t=t||{}).hasOwnProperty("object")&&(t.target=t.object),t.hasOwnProperty("actor")&&(void 0!==t.actor.objectType&&"Person"!==t.actor.objectType||(t.actor.objectType="Agent"),"Agent"===t.actor.objectType?t.actor instanceof O.Agent?this.actor=t.actor:this.actor=new O.Agent(t.actor):"Group"===t.actor.objectType&&(t.actor instanceof O.Group?this.actor=t.actor:this.actor=new O.Group(t.actor))),t.hasOwnProperty("verb")&&(t.verb instanceof O.Verb?this.verb=t.verb:this.verb=new O.Verb(t.verb)),t.hasOwnProperty("target")&&(t.target instanceof O.Activity||t.target instanceof O.Agent||t.target instanceof O.Group||t.target instanceof O.SubStatement||t.target instanceof O.StatementRef?this.target=t.target:(void 0===t.target.objectType&&(t.target.objectType="Activity"),"Activity"===t.target.objectType?this.target=new O.Activity(t.target):"Agent"===t.target.objectType?this.target=new O.Agent(t.target):"Group"===t.target.objectType?this.target=new O.Group(t.target):"SubStatement"===t.target.objectType?this.target=new O.SubStatement(t.target):"StatementRef"===t.target.objectType?this.target=new O.StatementRef(t.target):this.log("Unrecognized target type: "+t.target.objectType))),t.hasOwnProperty("result")&&(t.result instanceof O.Result?this.result=t.result:this.result=new O.Result(t.result)),t.hasOwnProperty("context")&&(t.context instanceof O.Context?this.context=t.context:this.context=new O.Context(t.context)),e=0;e<i.length;e+=1)t.hasOwnProperty(i[e])&&null!==t[i[e]]&&(this[i[e]]=t[i[e]])},toString:function(t){return this.log("toString"),(null!==this.actor?this.actor.toString(t):"")+" "+(null!==this.verb?this.verb.toString(t):"")+" "+(null!==this.target?this.target.toString(t):"")},asVersion:function(t){this.log("asVersion");var e,i,n=["timestamp"],s=["actor","verb","result","context"];for(e={objectType:this.objectType},t=t||O.versions()[0],i=0;i<n.length;i+=1)null!==this[n[i]]&&(e[n[i]]=this[n[i]]);for(i=0;i<s.length;i+=1)null!==this[s[i]]&&(e[s[i]]=this[s[i]].asVersion(t));return null!==this.target&&(e.object=this.target.asVersion(t)),"0.9"===t&&(e.objectType="Statement"),e}},L.fromJSON=function(t){L.prototype.log("fromJSON");var e=JSON.parse(t);return new L(e)},(j=O.Statement=function(t,e){this.log("constructor"),void 0===(e="number"==typeof e?{storeOriginal:e}:e||{}).storeOriginal&&(e.storeOriginal=null),void 0===e.doStamp&&(e.doStamp=!0),this.id=null,this.actor=null,this.verb=null,this.target=null,this.result=null,this.context=null,this.timestamp=null,this.stored=null,this.authority=null,this.attachments=null,this.version=null,this.degraded=!1,this.voided=null,this.inProgress=null,this.originalJSON=null,this.init(t,e)}).prototype={LOG_SRC:"Statement",log:O.prototype.log,init:function(t,e){this.log("init");var i,n=["id","stored","timestamp","version","inProgress","voided"];if(t=t||{},e.storeOriginal&&(this.originalJSON=JSON.stringify(t,null,e.storeOriginal)),t.hasOwnProperty("object")&&(t.target=t.object),t.hasOwnProperty("actor")&&(void 0!==t.actor.objectType&&"Person"!==t.actor.objectType||(t.actor.objectType="Agent"),"Agent"===t.actor.objectType?t.actor instanceof O.Agent?this.actor=t.actor:this.actor=new O.Agent(t.actor):"Group"===t.actor.objectType&&(t.actor instanceof O.Group?this.actor=t.actor:this.actor=new O.Group(t.actor))),t.hasOwnProperty("authority")&&(void 0!==t.authority.objectType&&"Person"!==t.authority.objectType||(t.authority.objectType="Agent"),"Agent"===t.authority.objectType?t.authority instanceof O.Agent?this.authority=t.authority:this.authority=new O.Agent(t.authority):"Group"===t.authority.objectType&&(t.actor instanceof O.Group?this.authority=t.authority:this.authority=new O.Group(t.authority))),t.hasOwnProperty("verb")&&(t.verb instanceof O.Verb?this.verb=t.verb:this.verb=new O.Verb(t.verb)),t.hasOwnProperty("target")&&(t.target instanceof O.Activity||t.target instanceof O.Agent||t.target instanceof O.Group||t.target instanceof O.SubStatement||t.target instanceof O.StatementRef?this.target=t.target:(void 0===t.target.objectType&&(t.target.objectType="Activity"),"Activity"===t.target.objectType?this.target=new O.Activity(t.target):"Agent"===t.target.objectType?this.target=new O.Agent(t.target):"Group"===t.target.objectType?this.target=new O.Group(t.target):"SubStatement"===t.target.objectType?this.target=new O.SubStatement(t.target):"StatementRef"===t.target.objectType?this.target=new O.StatementRef(t.target):this.log("Unrecognized target type: "+t.target.objectType))),t.hasOwnProperty("result")&&(t.result instanceof O.Result?this.result=t.result:this.result=new O.Result(t.result)),t.hasOwnProperty("context")&&(t.context instanceof O.Context?this.context=t.context:this.context=new O.Context(t.context)),t.hasOwnProperty("attachments")&&null!==t.attachments)for(this.attachments=[],i=0;i<t.attachments.length;i+=1)t.attachments[i]instanceof O.Attachment?this.attachments.push(t.attachments[i]):this.attachments.push(new O.Attachment(t.attachments[i]));for(i=0;i<n.length;i+=1)t.hasOwnProperty(n[i])&&null!==t[n[i]]&&(this[n[i]]=t[n[i]]);e.doStamp&&this.stamp()},toString:function(t){return this.log("toString"),(null!==this.actor?this.actor.toString(t):"")+" "+(null!==this.verb?this.verb.toString(t):"")+" "+(null!==this.target?this.target.toString(t):"")},asVersion:function(t){this.log("asVersion");var e,i={},n=["id","timestamp"],s=["actor","verb","result","context","authority"];for(t=t||O.versions()[0],e=0;e<n.length;e+=1)null!==this[n[e]]&&(i[n[e]]=this[n[e]]);for(e=0;e<s.length;e+=1)null!==this[s[e]]&&(i[s[e]]=this[s[e]].asVersion(t));if(null!==this.target&&(i.object=this.target.asVersion(t)),"0.9"!==t&&"0.95"!==t||null!==this.voided&&(i.voided=this.voided),"0.9"===t&&null!==this.inProgress&&(i.inProgress=this.inProgress),null!==this.attachments&&"0.9"!==t&&"0.95"!==t)for(i.attachments=[],e=0;e<this.attachments.length;e+=1)this.attachments[e]instanceof O.Attachment?i.attachments.push(this.attachments[e].asVersion(t)):i.attachments.push(new O.Attachment(this.attachments[e]).asVersion(t));return i},stamp:function(){this.log("stamp"),null===this.id&&(this.id=O.Utils.getUUID()),null===this.timestamp&&(this.timestamp=O.Utils.getISODateString(new Date))},hasAttachmentWithContent:function(){var t;if(this.log("hasAttachmentWithContent"),null===this.attachments)return!1;for(t=0;t<this.attachments.length;t+=1)if(null!==this.attachments[t].content)return!0;return!1}},j.fromJSON=function(t){j.prototype.log("fromJSON");var e=JSON.parse(t);return new j(e)},(F=O.StatementsResult=function(t){this.log("constructor"),this.statements=null,this.more=null,this.init(t)}).prototype={LOG_SRC:"StatementsResult",log:O.prototype.log,init:function(t){this.log("init"),(t=t||{}).hasOwnProperty("statements")&&(this.statements=t.statements),t.hasOwnProperty("more")&&(this.more=t.more)}},F.fromJSON=function(t){F.prototype.log("fromJSON");var e,i,n,s=[];try{e=JSON.parse(t)}catch(t){F.prototype.log("fromJSON - JSON.parse error: "+t)}if(e){for(n=0;n<e.statements.length;n+=1){try{i=new O.Statement(e.statements[n],4)}catch(t){F.prototype.log("fromJSON - statement instantiation failed: "+t+" ("+JSON.stringify(e.statements[n])+")"),i=new O.Statement({id:e.statements[n].id},4)}s.push(i)}e.statements=s}return new F(e)},(H=O.State=function(t){this.log("constructor"),this.id=null,this.updated=null,this.contents=null,this.etag=null,this.contentType=null,this.init(t)}).prototype={LOG_SRC:"State",log:O.prototype.log,init:function(t){this.log("init");var e,i=["id","contents","etag","contentType"];for(t=t||{},e=0;e<i.length;e+=1)t.hasOwnProperty(i[e])&&null!==t[i[e]]&&(this[i[e]]=t[i[e]]);this.updated=!1}},H.fromJSON=function(t){H.prototype.log("fromJSON");var e=JSON.parse(t);return new H(e)},(J=O.ActivityProfile=function(t){this.log("constructor"),this.id=null,this.activity=null,this.updated=null,this.contents=null,this.etag=null,this.contentType=null,this.init(t)}).prototype={LOG_SRC:"ActivityProfile",log:O.prototype.log,init:function(t){this.log("init");var e,i=["id","contents","etag","contentType"];for((t=t||{}).hasOwnProperty("activity")&&(t.activity instanceof O.Activity?this.activity=t.activity:this.activity=new O.Activity(t.activity)),e=0;e<i.length;e+=1)t.hasOwnProperty(i[e])&&null!==t[i[e]]&&(this[i[e]]=t[i[e]]);this.updated=!1}},J.fromJSON=function(t){J.prototype.log("fromJSON");var e=JSON.parse(t);return new J(e)},(B=O.AgentProfile=function(t){this.log("constructor"),this.id=null,this.agent=null,this.updated=null,this.contents=null,this.etag=null,this.contentType=null,this.init(t)}).prototype={LOG_SRC:"AgentProfile",log:O.prototype.log,init:function(t){this.log("init");var e,i=["id","contents","etag","contentType"];for((t=t||{}).hasOwnProperty("agent")&&(t.agent instanceof O.Agent?this.agent=t.agent:this.agent=new O.Agent(t.agent)),e=0;e<i.length;e+=1)t.hasOwnProperty(i[e])&&null!==t[i[e]]&&(this[i[e]]=t[i[e]]);this.updated=!1}},B.fromJSON=function(t){B.prototype.log("fromJSON");var e=JSON.parse(t);return new B(e)},(q=O.About=function(t){this.log("constructor"),this.version=null,this.init(t)}).prototype={LOG_SRC:"About",log:O.prototype.log,init:function(t){this.log("init");var e,i=["version"];for(t=t||{},e=0;e<i.length;e+=1)t.hasOwnProperty(i[e])&&null!==t[i[e]]&&(this[i[e]]=t[i[e]])}},q.fromJSON=function(t){q.prototype.log("fromJSON");var e=JSON.parse(t);return new q(e)},(V=O.Attachment=function(t){this.log("constructor"),this.usageType=null,this.display=null,this.contentType=null,this.length=null,this.sha2=null,this.description=null,this.fileUrl=null,this.content=null,this.init(t)}).prototype={LOG_SRC:"Attachment",log:O.prototype.log,init:function(t){this.log("init");var e,i=["contentType","length","sha2","usageType","display","description","fileUrl"];for(t=t||{},e=0;e<i.length;e+=1)t.hasOwnProperty(i[e])&&null!==t[i[e]]&&(this[i[e]]=t[i[e]]);t.hasOwnProperty("content")&&null!==t.content&&("string"==typeof t.content?this.setContentFromString(t.content):this.setContent(t.content))},asVersion:function(t){var e;return this.log("asVersion"),"0.9"===(t=t||O.versions()[0])||"0.95"===t?e=null:(e={contentType:this.contentType,display:this.display,length:this.length,sha2:this.sha2,usageType:this.usageType},null!==this.fileUrl&&(e.fileUrl=this.fileUrl),null!==this.description&&(e.description=this.description)),e},getLangDictionaryValue:O.Utils.getLangDictionaryValue,setContent:function(t){this.content=t,this.length=t.byteLength,this.sha2=O.Utils.getSHA256String(t)},setContentFromString:function(t){var e;e=O.Utils.stringToArrayBuffer(t),this.setContent(e)},getContentAsString:function(){return O.Utils.stringFromArrayBuffer(this.content)}},V.fromJSON=function(t){V.prototype.log("fromJSON");var e=JSON.parse(t);return new V(e)},V._defaultEncoding="utf-8",X="Environment.Browser",K={},Y=O.prototype.log,"undefined"!=typeof window?(K.hasCORS="undefined"!=typeof XMLHttpRequest&&void 0!==(new XMLHttpRequest).withCredentials,z=function(t,e){var i;return Y("requestComplete: xhr.status: "+t.status,X),t.status>=200&&t.status<400?e.callback?void e.callback(null,t):i={err:null,xhr:t}:(i={err:t.status,xhr:t},Y("[warning] Problem communicating with the Learning Record Store ("+t.status+" | "+t.responseText+")",X),e.callback&&e.callback(t.status,t),i)},G=function(t,e,i){Y("sendRequest using XMLHttpRequest",X);var n,s,r=this,o=[],a=void 0!==i.callback,c=t;for(s in i.params)i.params.hasOwnProperty(s)&&o.push(s+"="+encodeURIComponent(i.params[s]));for(s in o.length>0&&(c+="?"+o.join("&")),t=c,(n=new XMLHttpRequest).open(i.method,t,a),i.expectMultipart&&(n.responseType="arraybuffer"),e)e.hasOwnProperty(s)&&n.setRequestHeader(s,e[s]);a&&(n.onreadystatechange=function(){4===n.readyState&&z.call(r,n,i)});try{n.send(i.data)}catch(t){Y("sendRequest caught send exception: "+t,X)}return a?n:z.call(this,n,i)},O.LRS.prototype._initByEnvironment=function(t){if(Y("_initByEnvironment",X),this._makeRequest=G,null===this.endpoint.toLowerCase().match(/([A-Za-z]+:)\/\/([^:\/]+):?(\d+)?(\/.*)?$/))throw Y("[error] LRS invalid: failed to divide URL parts",X),{code:4,mesg:"LRS invalid: failed to divide URL parts"};if(!K.hasCORS)throw Y("[error] LRS invalid: CORS not supported in this browser",X),{code:1,mesg:"LRS invalid: CORS not supported in this browser"}},O.LRS.prototype._getMultipartRequestData=function(t,e,i){var n,s=[];for(s.push(W(t,e)),n=0;n<i.length;n+=1)null!==i[n].content&&s.push($(t,i[n].content,i[n].sha2,i[n].contentType));return s.push("\r\n--"+t+"--\r\n"),new Blob(s)},W=function(t,e){return["--"+t,"Content-Type: application/json","",JSON.stringify(e)].join("\r\n")+"\r\n"},$=function(t,e,i,n){var s=[],r=["--"+t,"Content-Type: "+n,"Content-Transfer-Encoding: binary","X-Experience-API-Hash: "+i].join("\r\n");return s.push(r+"\r\n\r\n"),s.push(e),new Blob(s)},O.Utils.stringToArrayBuffer=function(t,e){return e=e||O.Utils.defaultEncoding,new TextEncoder(e).encode(t).buffer},O.Utils.stringFromArrayBuffer=function(t,e){return e=e||O.Utils.defaultEncoding,new TextDecoder(e).decode(t)}):Y("'window' not defined",X),function(){function t(t,e){return(t=0|t||0)<0?Math.max(t+e,0):Math.min(t,e)}ArrayBuffer.prototype.slice||(ArrayBuffer.prototype.slice=function(e,i){var n=this.byteLength,s=t(e,n),r=n;if(void 0!==i&&(r=t(i,n)),s>r)return new ArrayBuffer(0);var o=r-s,a=new ArrayBuffer(o),c=new Uint8Array(a),l=new Uint8Array(this,s,o);return c.set(l),a})}(),function(t){function e(t,e,i){return e<=t&&t<=i}var i=Math.floor;function n(t){if(void 0===t)return{};if(t===Object(t))return t;throw TypeError("Could not convert argument to dictionary")}function s(t){return 0<=t&&t<=127}var r=s,o=-1;function a(t){this.tokens=[].slice.call(t),this.tokens.reverse()}a.prototype={endOfStream:function(){return!this.tokens.length},read:function(){return this.tokens.length?this.tokens.pop():o},prepend:function(t){if(Array.isArray(t))for(var e=t;e.length;)this.tokens.push(e.pop());else this.tokens.push(t)},push:function(t){if(Array.isArray(t))for(var e=t;e.length;)this.tokens.unshift(e.shift());else this.tokens.unshift(t)}};var c=-1;function l(t,e){if(t)throw TypeError("Decoder error");return e||65533}function u(t){throw TypeError("The code point "+t+" could not be encoded.")}function h(t){return t=String(t).trim().toLowerCase(),Object.prototype.hasOwnProperty.call(p,t)?p[t]:null}var d=[{encodings:[{labels:["unicode-1-1-utf-8","utf-8","utf8"],name:"UTF-8"}],heading:"The Encoding"},{encodings:[{labels:["866","cp866","csibm866","ibm866"],name:"IBM866"},{labels:["csisolatin2","iso-8859-2","iso-ir-101","iso8859-2","iso88592","iso_8859-2","iso_8859-2:1987","l2","latin2"],name:"ISO-8859-2"},{labels:["csisolatin3","iso-8859-3","iso-ir-109","iso8859-3","iso88593","iso_8859-3","iso_8859-3:1988","l3","latin3"],name:"ISO-8859-3"},{labels:["csisolatin4","iso-8859-4","iso-ir-110","iso8859-4","iso88594","iso_8859-4","iso_8859-4:1988","l4","latin4"],name:"ISO-8859-4"},{labels:["csisolatincyrillic","cyrillic","iso-8859-5","iso-ir-144","iso8859-5","iso88595","iso_8859-5","iso_8859-5:1988"],name:"ISO-8859-5"},{labels:["arabic","asmo-708","csiso88596e","csiso88596i","csisolatinarabic","ecma-114","iso-8859-6","iso-8859-6-e","iso-8859-6-i","iso-ir-127","iso8859-6","iso88596","iso_8859-6","iso_8859-6:1987"],name:"ISO-8859-6"},{labels:["csisolatingreek","ecma-118","elot_928","greek","greek8","iso-8859-7","iso-ir-126","iso8859-7","iso88597","iso_8859-7","iso_8859-7:1987","sun_eu_greek"],name:"ISO-8859-7"},{labels:["csiso88598e","csisolatinhebrew","hebrew","iso-8859-8","iso-8859-8-e","iso-ir-138","iso8859-8","iso88598","iso_8859-8","iso_8859-8:1988","visual"],name:"ISO-8859-8"},{labels:["csiso88598i","iso-8859-8-i","logical"],name:"ISO-8859-8-I"},{labels:["csisolatin6","iso-8859-10","iso-ir-157","iso8859-10","iso885910","l6","latin6"],name:"ISO-8859-10"},{labels:["iso-8859-13","iso8859-13","iso885913"],name:"ISO-8859-13"},{labels:["iso-8859-14","iso8859-14","iso885914"],name:"ISO-8859-14"},{labels:["csisolatin9","iso-8859-15","iso8859-15","iso885915","iso_8859-15","l9"],name:"ISO-8859-15"},{labels:["iso-8859-16"],name:"ISO-8859-16"},{labels:["cskoi8r","koi","koi8","koi8-r","koi8_r"],name:"KOI8-R"},{labels:["koi8-ru","koi8-u"],name:"KOI8-U"},{labels:["csmacintosh","mac","macintosh","x-mac-roman"],name:"macintosh"},{labels:["dos-874","iso-8859-11","iso8859-11","iso885911","tis-620","windows-874"],name:"windows-874"},{labels:["cp1250","windows-1250","x-cp1250"],name:"windows-1250"},{labels:["cp1251","windows-1251","x-cp1251"],name:"windows-1251"},{labels:["ansi_x3.4-1968","ascii","cp1252","cp819","csisolatin1","ibm819","iso-8859-1","iso-ir-100","iso8859-1","iso88591","iso_8859-1","iso_8859-1:1987","l1","latin1","us-ascii","windows-1252","x-cp1252"],name:"windows-1252"},{labels:["cp1253","windows-1253","x-cp1253"],name:"windows-1253"},{labels:["cp1254","csisolatin5","iso-8859-9","iso-ir-148","iso8859-9","iso88599","iso_8859-9","iso_8859-9:1989","l5","latin5","windows-1254","x-cp1254"],name:"windows-1254"},{labels:["cp1255","windows-1255","x-cp1255"],name:"windows-1255"},{labels:["cp1256","windows-1256","x-cp1256"],name:"windows-1256"},{labels:["cp1257","windows-1257","x-cp1257"],name:"windows-1257"},{labels:["cp1258","windows-1258","x-cp1258"],name:"windows-1258"},{labels:["x-mac-cyrillic","x-mac-ukrainian"],name:"x-mac-cyrillic"}],heading:"Legacy single-byte encodings"},{encodings:[{labels:["chinese","csgb2312","csiso58gb231280","gb2312","gb_2312","gb_2312-80","gbk","iso-ir-58","x-gbk"],name:"GBK"},{labels:["gb18030"],name:"gb18030"}],heading:"Legacy multi-byte Chinese (simplified) encodings"},{encodings:[{labels:["big5","big5-hkscs","cn-big5","csbig5","x-x-big5"],name:"Big5"}],heading:"Legacy multi-byte Chinese (traditional) encodings"},{encodings:[{labels:["cseucpkdfmtjapanese","euc-jp","x-euc-jp"],name:"EUC-JP"},{labels:["csiso2022jp","iso-2022-jp"],name:"ISO-2022-JP"},{labels:["csshiftjis","ms932","ms_kanji","shift-jis","shift_jis","sjis","windows-31j","x-sjis"],name:"Shift_JIS"}],heading:"Legacy multi-byte Japanese encodings"},{encodings:[{labels:["cseuckr","csksc56011987","euc-kr","iso-ir-149","korean","ks_c_5601-1987","ks_c_5601-1989","ksc5601","ksc_5601","windows-949"],name:"EUC-KR"}],heading:"Legacy multi-byte Korean encodings"},{encodings:[{labels:["csiso2022kr","hz-gb-2312","iso-2022-cn","iso-2022-cn-ext","iso-2022-kr"],name:"replacement"},{labels:["utf-16be"],name:"UTF-16BE"},{labels:["utf-16","utf-16le"],name:"UTF-16LE"},{labels:["x-user-defined"],name:"x-user-defined"}],heading:"Legacy miscellaneous encodings"}],p={};d.forEach((function(t){t.encodings.forEach((function(t){t.labels.forEach((function(e){p[e]=t}))}))}));var f={},m={};function g(t,e){return e&&e[t]||null}function v(t,e){var i=e.indexOf(t);return-1===i?null:i}function y(e){if(!("encoding-indexes"in t))throw Error("Indexes missing. Did you forget to include encoding-indexes.js?");return t["encoding-indexes"][e]}var S="utf-8";function w(t,e){if(!(this instanceof w))throw TypeError("Called as a function. Did you forget 'new'?");t=void 0!==t?String(t):S,e=n(e),this._encoding=null,this._decoder=null,this._ignoreBOM=!1,this._BOMseen=!1,this._error_mode="replacement",this._do_not_flush=!1;var i=h(t);if(null===i||"replacement"===i.name)throw RangeError("Unknown encoding: "+t);if(!m[i.name])throw Error("Decoder not present. Did you forget to include encoding-indexes.js?");var s=this;return s._encoding=i,Boolean(e.fatal)&&(s._error_mode="fatal"),Boolean(e.ignoreBOM)&&(s._ignoreBOM=!0),s}function b(e,i){if(!(this instanceof b))throw TypeError("Called as a function. Did you forget 'new'?");i=n(i),this._encoding=null,this._encoder=null,this._do_not_flush=!1,this._fatal=Boolean(i.fatal)?"fatal":"replacement";var s=this;if(Boolean(i.NONSTANDARD_allowLegacyEncoding)){var r=h(e=void 0!==e?String(e):S);if(null===r||"replacement"===r.name)throw RangeError("Unknown encoding: "+e);if(!f[r.name])throw Error("Encoder not present. Did you forget to include encoding-indexes.js?");s._encoding=r}else s._encoding=h("utf-8"),void 0!==e&&"console"in t&&console.warn("TextEncoder constructor called with encoding label, which is ignored.");return s}function O(t){var i=t.fatal,n=0,s=0,r=0,a=128,u=191;this.handler=function(t,h){if(h===o&&0!==r)return r=0,l(i);if(h===o)return c;if(0===r){if(e(h,0,127))return h;if(e(h,194,223))r=1,n=h-192;else if(e(h,224,239))224===h&&(a=160),237===h&&(u=159),r=2,n=h-224;else{if(!e(h,240,244))return l(i);240===h&&(a=144),244===h&&(u=143),r=3,n=h-240}return n<<=6*r,null}if(!e(h,a,u))return n=r=s=0,a=128,u=191,t.prepend(h),l(i);if(a=128,u=191,n+=h-128<<6*(r-(s+=1)),s!==r)return null;var d=n;return n=r=s=0,d}}function x(t){t.fatal,this.handler=function(t,i){if(i===o)return c;if(e(i,0,127))return i;var n,s;e(i,128,2047)?(n=1,s=192):e(i,2048,65535)?(n=2,s=224):e(i,65536,1114111)&&(n=3,s=240);for(var r=[(i>>6*n)+s];n>0;){var a=i>>6*(n-1);r.push(128|63&a),n-=1}return r}}function C(t,e){var i=e.fatal;this.handler=function(e,n){if(n===o)return c;if(s(n))return n;var r=t[n-128];return null===r?l(i):r}}function _(t,e){e.fatal,this.handler=function(e,i){if(i===o)return c;if(r(i))return i;var n=v(i,t);return null===n&&u(i),n+128}}function D(t){var i=t.fatal,n=0,r=0,a=0;this.handler=function(t,u){if(u===o&&0===n&&0===r&&0===a)return c;var h;if(u!==o||0===n&&0===r&&0===a||(n=0,r=0,a=0,l(i)),0!==a){h=null,e(u,48,57)&&(h=function(t){if(t>39419&&t<189e3||t>1237575)return null;if(7457===t)return 59335;var e,i=0,n=0,s=y("gb18030");for(e=0;e<s.length;++e){var r=s[e];if(!(r[0]<=t))break;i=r[0],n=r[1]}return n+t-i}(10*(126*(10*(n-129)+(r-48))+(a-129))+u-48));var d=[r,a,u];return n=0,r=0,a=0,null===h?(t.prepend(d),l(i)):h}if(0!==r)return e(u,129,254)?(a=u,null):(t.prepend([r,u]),n=0,r=0,l(i));if(0!==n){if(e(u,48,57))return r=u,null;var p=n,f=null;n=0;var m=u<127?64:65;return(e(u,64,126)||e(u,128,254))&&(f=190*(p-129)+(u-m)),null===(h=null===f?null:g(f,y("gb18030")))&&s(u)&&t.prepend(u),null===h?l(i):h}return s(u)?u:128===u?8364:e(u,129,254)?(n=u,null):l(i)}}function A(t,e){t.fatal,this.handler=function(t,n){if(n===o)return c;if(r(n))return n;if(58853===n)return u(n);if(e&&8364===n)return 128;var s=v(n,y("gb18030"));if(null!==s){var a=s%190;return[i(s/190)+129,a+(a<63?64:65)]}if(e)return u(n);s=function(t){if(59335===t)return 7457;var e,i=0,n=0,s=y("gb18030");for(e=0;e<s.length;++e){var r=s[e];if(!(r[1]<=t))break;i=r[1],n=r[0]}return n+t-i}(n);var l=i(s/10/126/10),h=i((s-=10*l*126*10)/10/126),d=i((s-=10*h*126)/10);return[l+129,h+48,d+129,s-10*d+48]}}function R(t){var i=t.fatal,n=0;this.handler=function(t,r){if(r===o&&0!==n)return n=0,l(i);if(r===o&&0===n)return c;if(0!==n){var a=n,u=null;n=0;var h=r<127?64:98;switch((e(r,64,126)||e(r,161,254))&&(u=157*(a-129)+(r-h)),u){case 1133:return[202,772];case 1135:return[202,780];case 1164:return[234,772];case 1166:return[234,780]}var d=null===u?null:g(u,y("big5"));return null===d&&s(r)&&t.prepend(r),null===d?l(i):d}return s(r)?r:e(r,129,254)?(n=r,null):l(i)}}function T(t){t.fatal,this.handler=function(t,e){if(e===o)return c;if(r(e))return e;var n=function(t){var e=y("big5");return 9552===t||9566===t||9569===t||9578===t||21313===t||21317===t?e.lastIndexOf(t):v(t,e)}(e);if(null===n)return u(e);var s=i(n/157)+129;if(s<161)return u(e);var a=n%157;return[s,a+(a<63?64:98)]}}function P(t){var i=t.fatal,n=!1,r=0;this.handler=function(t,a){if(a===o&&0!==r)return r=0,l(i);if(a===o&&0===r)return c;if(142===r&&e(a,161,223))return r=0,65377+a-161;if(143===r&&e(a,161,254))return n=!0,r=a,null;if(0!==r){var u=r;r=0;var h=null;return e(u,161,254)&&e(a,161,254)&&(h=g(94*(u-161)+(a-161),y(n?"jis0212":"jis0208"))),n=!1,e(a,161,254)||t.prepend(a),null===h?l(i):h}return s(a)?a:142===a||143===a||e(a,161,254)?(r=a,null):l(i)}}function I(t){t.fatal,this.handler=function(t,n){if(n===o)return c;if(r(n))return n;if(165===n)return 92;if(8254===n)return 126;if(e(n,65377,65439))return[142,n-65377+161];8722===n&&(n=65293);var s=v(n,y("jis0208"));return null===s?u(n):[i(s/94)+161,s%94+161]}}function k(t){var i=t.fatal,n=0,s=1,r=2,a=3,u=4,h=5,d=6,p=n,f=n,m=0,v=!1;this.handler=function(t,S){switch(p){default:case n:return 27===S?(p=h,null):e(S,0,127)&&14!==S&&15!==S&&27!==S?(v=!1,S):S===o?c:(v=!1,l(i));case s:return 27===S?(p=h,null):92===S?(v=!1,165):126===S?(v=!1,8254):e(S,0,127)&&14!==S&&15!==S&&27!==S&&92!==S&&126!==S?(v=!1,S):S===o?c:(v=!1,l(i));case r:return 27===S?(p=h,null):e(S,33,95)?(v=!1,65377+S-33):S===o?c:(v=!1,l(i));case a:return 27===S?(p=h,null):e(S,33,126)?(v=!1,m=S,p=u,null):S===o?c:(v=!1,l(i));case u:if(27===S)return p=h,l(i);if(e(S,33,126)){p=a;var w=g(94*(m-33)+S-33,y("jis0208"));return null===w?l(i):w}return S===o?(p=a,t.prepend(S),l(i)):(p=a,l(i));case h:return 36===S||40===S?(m=S,p=d,null):(t.prepend(S),v=!1,p=f,l(i));case d:var b=m;m=0;var O=null;if(40===b&&66===S&&(O=n),40===b&&74===S&&(O=s),40===b&&73===S&&(O=r),36!==b||64!==S&&66!==S||(O=a),null!==O){p=p=O;var x=v;return v=!0,x?l(i):null}return t.prepend([b,S]),v=!1,p=f,l(i)}}}function E(t){t.fatal;var e=0,n=1,s=2,a=e;this.handler=function(t,l){if(l===o&&a!==e)return t.prepend(l),a=e,[27,40,66];if(l===o&&a===e)return c;if(!(a!==e&&a!==n||14!==l&&15!==l&&27!==l))return u(65533);if(a===e&&r(l))return l;if(a===n&&(r(l)&&92!==l&&126!==l||165==l||8254==l)){if(r(l))return l;if(165===l)return 92;if(8254===l)return 126}if(r(l)&&a!==e)return t.prepend(l),a=e,[27,40,66];if((165===l||8254===l)&&a!==n)return t.prepend(l),a=n,[27,40,74];8722===l&&(l=65293);var h=v(l,y("jis0208"));return null===h?u(l):a!==s?(t.prepend(l),a=s,[27,36,66]):[i(h/94)+33,h%94+33]}}function N(t){var i=t.fatal,n=0;this.handler=function(t,r){if(r===o&&0!==n)return n=0,l(i);if(r===o&&0===n)return c;if(0!==n){var a=n,u=null;n=0;var h=r<127?64:65,d=a<160?129:193;(e(r,64,126)||e(r,128,252))&&(u=188*(a-d)+r-h);var p=null===u?null:g(u,y("jis0208"));return null===p&&null!==u&&e(u,8836,10528)?57344+u-8836:(null===p&&s(r)&&t.prepend(r),null===p?l(i):p)}return s(r)||128===r?r:e(r,161,223)?65377+r-161:e(r,129,159)||e(r,224,252)?(n=r,null):l(i)}}function M(t){t.fatal,this.handler=function(t,n){if(n===o)return c;if(r(n)||128===n)return n;if(165===n)return 92;if(8254===n)return 126;if(e(n,65377,65439))return n-65377+161;8722===n&&(n=65293);var s=function(t){var i=v(t,y("jis0208"));return null===i||e(i,8272,8835)?null:i}(n);if(null===s)return u(n);var a=i(s/188),l=s%188;return[a+(a<31?129:193),l+(l<63?64:65)]}}function U(t){var i=t.fatal,n=0;this.handler=function(t,r){if(r===o&&0!==n)return n=0,l(i);if(r===o&&0===n)return c;if(0!==n){var a=n,u=null;n=0,e(r,65,254)&&(u=190*(a-129)+(r-65));var h=null===u?null:g(u,y("euc-kr"));return null===u&&s(r)&&t.prepend(r),null===h?l(i):h}return s(r)?r:e(r,129,254)?(n=r,null):l(i)}}function L(t){t.fatal,this.handler=function(t,e){if(e===o)return c;if(r(e))return e;var n=v(e,y("euc-kr"));return null===n?u(e):[i(n/190)+129,n%190+65]}}function j(t,e){var i=t>>8,n=255&t;return e?[i,n]:[n,i]}function F(t,i){var n=i.fatal,s=null,r=null;this.handler=function(i,a){if(a===o&&(null!==s||null!==r))return l(n);if(a===o&&null===s&&null===r)return c;if(null===s)return s=a,null;var u;if(u=t?(s<<8)+a:(a<<8)+s,s=null,null!==r){var h=r;return r=null,e(u,56320,57343)?65536+1024*(h-55296)+(u-56320):(i.prepend(j(u,t)),l(n))}return e(u,55296,56319)?(r=u,null):e(u,56320,57343)?l(n):u}}function H(t,i){i.fatal,this.handler=function(i,n){if(n===o)return c;if(e(n,0,65535))return j(n,t);var s=j(55296+(n-65536>>10),t),r=j(56320+(n-65536&1023),t);return s.concat(r)}}function J(t){t.fatal,this.handler=function(t,e){return e===o?c:s(e)?e:63360+e-128}}function B(t){t.fatal,this.handler=function(t,i){return i===o?c:r(i)?i:e(i,63360,63487)?i-63360+128:u(i)}}Object.defineProperty&&(Object.defineProperty(w.prototype,"encoding",{get:function(){return this._encoding.name.toLowerCase()}}),Object.defineProperty(w.prototype,"fatal",{get:function(){return"fatal"===this._error_mode}}),Object.defineProperty(w.prototype,"ignoreBOM",{get:function(){return this._ignoreBOM}})),w.prototype.decode=function(t,e){var i;i="object"==typeof t&&t instanceof ArrayBuffer?new Uint8Array(t):"object"==typeof t&&"buffer"in t&&t.buffer instanceof ArrayBuffer?new Uint8Array(t.buffer,t.byteOffset,t.byteLength):new Uint8Array(0),e=n(e),this._do_not_flush||(this._decoder=m[this._encoding.name]({fatal:"fatal"===this._error_mode}),this._BOMseen=!1),this._do_not_flush=Boolean(e.stream);for(var s,r=new a(i),l=[];;){var u=r.read();if(u===o)break;if((s=this._decoder.handler(r,u))===c)break;null!==s&&(Array.isArray(s)?l.push.apply(l,s):l.push(s))}if(!this._do_not_flush){do{if((s=this._decoder.handler(r,r.read()))===c)break;null!==s&&(Array.isArray(s)?l.push.apply(l,s):l.push(s))}while(!r.endOfStream());this._decoder=null}return function(t){var e,i;return e=["UTF-8","UTF-16LE","UTF-16BE"],i=this._encoding.name,-1===e.indexOf(i)||this._ignoreBOM||this._BOMseen||(t.length>0&&65279===t[0]?(this._BOMseen=!0,t.shift()):t.length>0&&(this._BOMseen=!0)),function(t){for(var e="",i=0;i<t.length;++i){var n=t[i];n<=65535?e+=String.fromCharCode(n):(n-=65536,e+=String.fromCharCode(55296+(n>>10),56320+(1023&n)))}return e}(t)}.call(this,l)},Object.defineProperty&&Object.defineProperty(b.prototype,"encoding",{get:function(){return this._encoding.name.toLowerCase()}}),b.prototype.encode=function(t,e){t=t?String(t):"",e=n(e),this._do_not_flush||(this._encoder=f[this._encoding.name]({fatal:"fatal"===this._fatal})),this._do_not_flush=Boolean(e.stream);for(var i,s=new a(function(t){for(var e=String(t),i=e.length,n=0,s=[];n<i;){var r=e.charCodeAt(n);if(r<55296||r>57343)s.push(r);else if(56320<=r&&r<=57343)s.push(65533);else if(55296<=r&&r<=56319)if(n===i-1)s.push(65533);else{var o=t.charCodeAt(n+1);if(56320<=o&&o<=57343){var a=1023&r,c=1023&o;s.push(65536+(a<<10)+c),n+=1}else s.push(65533)}n+=1}return s}(t)),r=[];;){var l=s.read();if(l===o)break;if((i=this._encoder.handler(s,l))===c)break;Array.isArray(i)?r.push.apply(r,i):r.push(i)}if(!this._do_not_flush){for(;(i=this._encoder.handler(s,s.read()))!==c;)Array.isArray(i)?r.push.apply(r,i):r.push(i);this._encoder=null}return new Uint8Array(r)},f["UTF-8"]=function(t){return new x(t)},m["UTF-8"]=function(t){return new O(t)},"encoding-indexes"in t&&d.forEach((function(t){"Legacy single-byte encodings"===t.heading&&t.encodings.forEach((function(t){var e=t.name,i=y(e.toLowerCase());m[e]=function(t){return new C(i,t)},f[e]=function(t){return new _(i,t)}}))})),m.GBK=function(t){return new D(t)},f.GBK=function(t){return new A(t,!0)},f.gb18030=function(t){return new A(t)},m.gb18030=function(t){return new D(t)},f.Big5=function(t){return new T(t)},m.Big5=function(t){return new R(t)},f["EUC-JP"]=function(t){return new I(t)},m["EUC-JP"]=function(t){return new P(t)},f["ISO-2022-JP"]=function(t){return new E(t)},m["ISO-2022-JP"]=function(t){return new k(t)},f.Shift_JIS=function(t){return new M(t)},m.Shift_JIS=function(t){return new N(t)},f["EUC-KR"]=function(t){return new L(t)},m["EUC-KR"]=function(t){return new U(t)},f["UTF-16BE"]=function(t){return new H(!0,t)},m["UTF-16BE"]=function(t){return new F(!0,t)},f["UTF-16LE"]=function(t){return new H(!1,t)},m["UTF-16LE"]=function(t){return new F(!1,t)},f["x-user-defined"]=function(t){return new B(t)},m["x-user-defined"]=function(t){return new J(t)},t.TextEncoder||(t.TextEncoder=b),t.TextDecoder||(t.TextDecoder=w),"undefined"!=typeof module&&module.exports&&(module.exports={TextEncoder:t.TextEncoder,TextDecoder:t.TextDecoder,EncodingIndexes:t["encoding-indexes"]})}(window),window.TinCan=O;try{Q.name="XAPIWrapper"}catch(f){}function Z(){this._debug=!1,this.api=pipwerks.SCORM,Object.defineProperty(this,"debug",{get:function(){return this._debug},set:function(t){this._debug=t,pipwerks.debug.isActive=t}})}Q.prototype.init=function(){return new Promise(function(t){this.tincan=new TinCan({url:window.location.href}),this.enabled=this.tincan.recordStores.length>0,this.enabled?this.getCourseDuration().then((function(){t(this.enabled)})):(console.error("xapi-wrapper.js :: xAPI disabled, TinCan recordStores empty !"),t(this.enabled))}.bind(this))},Q.prototype.save=function(){return Promise.resolve(!0)},Q.prototype.quit=function(){var t=this.tincan.getStatements({sendActor:!0,sendActivity:!0});if(!t.err)var e=t.statementsResult.statements?t.statementsResult.statements.find((function(t){return Object.prototype.hasOwnProperty.call(t,"result")&&t.result&&Object.prototype.hasOwnProperty.call(t.result,"completion")&&"boolean"==typeof t.result.completion})):null;var i=!!e&&e.result.completion?[]:[this.createStatement("suspended")];return i.push(this.createStatement("exited")),this.sendStatementsSync(i),Promise.resolve()},Q.prototype.getUser=function(){var t=this.tincan.actor;return Promise.resolve({id:t.account.name,name:t.name,account:t.account})},Q.prototype.isActivityCompleted=function(){return new Promise(function(t,e){this.tincan.getStatements({sendActor:!0,sendActivity:!0,callback:function(i,n){if(null!==i)e(i);else{var s=null;Object.prototype.hasOwnProperty.call(n,"statements")&&Array.isArray(n.statements)&&(s=n.statements.find((function(t){return Object.prototype.hasOwnProperty.call(t,"result")&&t.result&&Object.prototype.hasOwnProperty.call(t.result,"completion")&&"boolean"==typeof t.result.completion}))),t(!!s&&s.result.completion)}}})}.bind(this))},Q.prototype.isCompleted=Q.prototype.isActivityCompleted,Q.prototype.getCourseData=function(){return this.course_data?Promise.resolve(this.course_data):this.getState("course_data").then(function(t){var e=Object.assign({},Q.DEFAULT_COURSE_DATA);return this.course_data=Object.assign(e,this.course_data,t),this.course_data}.bind(this))},Q.prototype.setCourseData=function(t){return this.course_data=Object.assign(this.course_data||{},t),this.setState("course_data",this.course_data)},Q.prototype.getCourseLocation=function(){return this.course_data?Promise.resolve(this.course_data.location):this.getState("course_data").then(function(t){return this.course_data=Object.assign({location:0},this.course_data,t),this.course_data.location}.bind(this))},Q.prototype.setCourseLocation=function(t){return this.course_data=Object.assign(this.course_data||{},{location:t}),this.setState("course_data",this.course_data)},Q.prototype.getCourseDuration=function(){return this.course_data?Promise.resolve(this.course_data.duration):this.getState("course_data").then(function(t){return this.course_data=Object.assign({duration:0},this.course_data,t),this.course_data.duration}.bind(this))},Q.prototype.setCourseDuration=function(){return this.course_data=Object.assign(this.course_data||{},{duration:this.getTotalDuration()}),Q.utils._initializationTime=(new Date).getTime(),this.setState("course_data",this.course_data)},Q.prototype.getCourseProgress=function(){return this.course_data?Promise.resolve(this.course_data.progress):this.getState("course_data").then(function(t){return this.course_data=Object.assign({progress:0},this.course_data,t),this.course_data.progress}.bind(this))},Q.prototype.setCourseProgress=function(t){return this.course_data=Object.assign(this.course_data||{},{progress:t}),Promise.all([this.setState("course_data",this.course_data),this.sendStatement(this.createStatement("progressed",t))])},Q.prototype.getCourseScore=function(){return this.course_data?Promise.resolve(this.course_data.score):this.getState("course_data").then(function(t){return this.course_data=Object.assign({score:{}},this.course_data,t),this.course_data.score}.bind(this))},Q.prototype.setCourseScore=function(t){return this.course_data=Object.assign(this.course_data||{},{score:t}),Promise.all([this.setState("course_data",this.course_data),this.sendStatement(this.createStatement("scored",t))])},Q.prototype.isCourseInitialized=function(){return this.getState("course_data").then((function(t){return null!==t}))},Q.prototype.setCourseStarted=function(){return Q.utils.updateInteractionTime(),this.isCourseInitialized().then(function(t){var e=t?"resumed":"initialized";return this.sendStatement(this.createStatement(e))}.bind(this))},Q.prototype.setCourseCompleted=function(){return this.sendStatements([this.createStatement("completed"),this.createStatement("terminated")])},Q.prototype.setCoursePassed=function(){return this.sendStatement(this.createStatement("passed"))},Q.prototype.setCourseFailed=function(){return this.sendStatement(this.createStatement("failed"))},Q.prototype.sendInteraction=function(t){return this.sendStatement(this.createStatement("answered",t))},Q.prototype.sendObjective=function(t){return this.sendStatement(this.createObjectiveStatement(t))},Q.prototype.getObjectives=function(){return new Promise(function(t,e){this.tincan.getStatements({sendActor:!0,sendActivity:!1,callback:function(i,n){if(null!==i)e(i);else{var s=n.statements.filter((function(t){return Object.prototype.hasOwnProperty.call(t,"target")&&t.target&&Object.prototype.hasOwnProperty.call(t.target,"definition")&&t.target.definition&&Object.prototype.hasOwnProperty.call(t.target.definition,"type")&&t.target.definition.type===Q.activities.objective&&Object.prototype.hasOwnProperty.call(t.target,"id")})),r=[],o=Q.extensions.progress.id;s.forEach((function(t){if(!r.find((function(e){return e.id===t.target.id}))){var e={id:t.target.id,scoreMin:t.result.score.min,scoreMax:t.result.score.max,scoreRaw:t.result.score.raw,success_status:/passed|failed/g.test(""+t.verb.id)?/passed/g.test(""+t.verb.id)?"passed":"failed":"unknown",completion_status:/completed/g.test(""+t.verb.id)?"completed":Object.prototype.hasOwnProperty.call(t.result,"completion")?!0===t.result.completion?"completed":"incomplete":"unknown",progress_measure:Object.prototype.hasOwnProperty.call(t.result,"extensions")&&"number"==typeof t.result.extensions[o]?t.result.extensions[o]:0,description:t.target.definition.description};(Object.prototype.hasOwnProperty.call(e,"progress_measure")&&e.progress_measure>=1||Object.prototype.hasOwnProperty.call(e,"completion_status")&&"completed"===e.completion_status||Object.prototype.hasOwnProperty.call(e,"success_status")&&/passed|failed/g.test(e.success_status))&&r.push(e)}})),t(r)}}})}.bind(this))},Q.prototype.getState=function(t){return new Promise(function(e,i){this.tincan.getState(t,{callback:function(t,n){null!==t?i(t):n&&Object.prototype.hasOwnProperty.call(n,"contents")?e(n.contents):e(n)}})}.bind(this))},Q.prototype.setState=function(t,e){return new Promise(function(i,n){this.tincan.setState(t,e,{contentType:"application/json",overwriteJSON:!1,callback:function(t){null!==t?n(t):i(!0)}})}.bind(this))},Q.prototype.sendStatements=function(t){return new Promise(function(e,i){this.tincan.sendStatements(t,(function(t,n){var s=t||{err:new Error("sendStatements : No results in response !")};s.err?i(s.err):e(n)}))}.bind(this))},Q.prototype.sendStatementsSync=function(t){this.tincan.sendStatements(t)},Q.prototype.sendStatement=function(t){return new Promise(function(e,i){this.tincan.sendStatement(t,(function(t,n){var s=t||{err:new Error("sendStatement : No results in response !")};s.err?i(s.err):e(n)}))}.bind(this))},Q.prototype.createStatement=function(t,e){var i,n={context:{}};switch(t){case"initialized":n.verb=Q.verbs.initialized,n.result={completion:!1,duration:"PT0S"};break;case"suspended":n.verb=Q.verbs.suspended,n.result={duration:TinCan.Utils.convertMillisecondsToISO8601Duration(this.getTotalDuration())};break;case"resumed":n.verb=Q.verbs.resumed;break;case"progressed":n.verb=Q.verbs.progressed,n.result={extensions:(i={},i[Q.extensions.progress.id]=e||0,i)};break;case"scored":n.verb=Q.verbs.scored,n.result={score:e};break;case"completed":n.verb=Q.verbs.completed,n.result={completion:!0,duration:TinCan.Utils.convertMillisecondsToISO8601Duration(this.getTotalDuration())};break;case"passed":n.verb=Q.verbs.passed,n.result={completion:!0,success:!0};break;case"failed":n.verb=Q.verbs.failed,n.result={completion:!0,success:!1};break;case"terminated":n.verb=Q.verbs.terminated,n.result={duration:TinCan.Utils.convertMillisecondsToISO8601Duration(this.getTotalDuration())};break;case"exited":n.verb=Q.verbs.exited,n.result={duration:TinCan.Utils.convertMillisecondsToISO8601Duration(this.getTotalDuration())};break;case"answered":case"responded":n.verb=Q.verbs[t],n.result={success:"correct"===e.result,score:{raw:"correct"===e.result?1:0},duration:TinCan.Utils.convertMillisecondsToISO8601Duration(Q.utils.getInteractionLatency())},e.studentResponse.length>0&&(n.result.response=e.studentResponse),n.object={id:Q.utils.makeInteractionId(this.tincan.activity.id,e.id),definition:{name:{"fr-FR":"Question "+e.id},description:{"fr-FR":e.description},type:Q.activities.interaction,interactionType:e.type},objectType:"Activity"},e.correctResponse.length>0&&(n.object.definition.correctResponsesPattern=[e.correctResponse]),(e.objectiveId+"").length>0&&(Object.prototype.hasOwnProperty.call(n.context,"contextActivities")||(n.context.contextActivities={}),n.context.contextActivities.parent||(n.context.contextActivities.parent=[]),n.context.contextActivities.parent.push({id:Q.utils.makeObjectiveId(this.tincan.activity.id,e.objectiveId)}));break;default:throw new Error('XAPIWrapper :: createStatement : statement "'+t+'" not available !')}return n},Q.prototype.createObjectiveStatement=function(t){var e="attempted",i=/passed|failed/.test(t.success_status);i?e=t.success_status:/completed/.test(t.completion_status)&&(e=t.completion_status);var n,s={context:{}};return s.verb=Q.verbs[e],s.result={completion:t.progress_measure>=1,score:{min:t.scoreMin,max:t.scoreMax,raw:t.scoreRaw,scaled:t.scoreScaled},extensions:(n={},n[Q.extensions.progress.id]=t.progress_measure,n)},i&&(s.result.success="passed"===e),s.object={id:Q.utils.makeObjectiveId(this.tincan.activity.id,t.id),definition:{name:{"fr-FR":"Objectif "+t.id},description:{"fr-FR":t.description},type:Q.activities.objective},objectType:"Activity"},s.category=[Q.activities.profile],s},Q.prototype.getTotalDuration=function(){return(this.course_data?this.course_data.duration:0)+Q.utils.getSessionTime()},Q.DEFAULT_COURSE_DATA={course:[],content:"",location:0,duration:0,progress:0,score:{}},Q.verbs={abandoned:{id:"https://w3id.org/xapi/adl/verbs/abandoned",display:{"en-US":"abandoned","fr-FR":"a abandonné"}},answered:{id:"http://adlnet.gov/expapi/verbs/answered",display:{"de-DE":"beantwortete","en-US":"answered","fr-FR":"a répondu","es-ES":"contestó"}},asked:{id:"http://adlnet.gov/expapi/verbs/asked",display:{"de-DE":"fragte","en-US":"asked","fr-FR":"a demandé","es-ES":"preguntó"}},attempted:{id:"http://adlnet.gov/expapi/verbs/attempted",display:{"de-DE":"versuchte","en-US":"attempted","fr-FR":"a essayé","es-ES":"intentó"}},attended:{id:"http://adlnet.gov/expapi/verbs/attended",display:{"de-DE":"nahm teil an","en-US":"attended","fr-FR":"a suivi","es-ES":"asistió"}},commented:{id:"http://adlnet.gov/expapi/verbs/commented",display:{"de-DE":"kommentierte","en-US":"commented","fr-FR":"a commenté","es-ES":"comentó"}},completed:{id:"http://adlnet.gov/expapi/verbs/completed",display:{"de-DE":"beendete","en-US":"completed","fr-FR":"a terminé","es-ES":"completó"}},exited:{id:"http://adlnet.gov/expapi/verbs/exited",display:{"de-DE":"verließ","en-US":"exited","fr-FR":"a quitté","es-ES":"salió"}},experienced:{id:"http://adlnet.gov/expapi/verbs/experienced",display:{"de-DE":"erlebte","en-US":"experienced","fr-FR":"a éprouvé","es-ES":"experimentó"}},failed:{id:"http://adlnet.gov/expapi/verbs/failed",display:{"de-DE":"verfehlte","en-US":"failed","fr-FR":"a échoué","es-ES":"fracasó"}},imported:{id:"http://adlnet.gov/expapi/verbs/imported",display:{"de-DE":"importierte","en-US":"imported","fr-FR":"a importé","es-ES":"importó"}},initialized:{id:"http://adlnet.gov/expapi/verbs/initialized",display:{"de-DE":"initialisierte","en-US":"initialized","fr-FR":"a initialisé","es-ES":"inicializó"}},interacted:{id:"http://adlnet.gov/expapi/verbs/interacted",display:{"de-DE":"interagierte","en-US":"interacted","fr-FR":"a interagi","es-ES":"interactuó"}},launched:{id:"http://adlnet.gov/expapi/verbs/launched",display:{"de-DE":"startete","en-US":"launched","fr-FR":"a lancé","es-ES":"lanzó"}},mastered:{id:"http://adlnet.gov/expapi/verbs/mastered",display:{"de-DE":"meisterte","en-US":"mastered","fr-FR":"a maîtrisé","es-ES":"dominó"}},passed:{id:"http://adlnet.gov/expapi/verbs/passed",display:{"de-DE":"bestand","en-US":"passed","fr-FR":"a réussi","es-ES":"aprobó"}},preferred:{id:"http://adlnet.gov/expapi/verbs/preferred",display:{"de-DE":"bevorzugte","en-US":"preferred","fr-FR":"a préféré","es-ES":"prefirió"}},progressed:{id:"http://adlnet.gov/expapi/verbs/progressed",display:{"de-DE":"machte Fortschritt mit","en-US":"progressed","fr-FR":"a progressé","es-ES":"progresó"}},registered:{id:"http://adlnet.gov/expapi/verbs/registered",display:{"de-DE":"registrierte","en-US":"registered","fr-FR":"a enregistré","es-ES":"registró"}},responded:{id:"http://adlnet.gov/expapi/verbs/responded",display:{"de-DE":"reagierte","en-US":"responded","fr-FR":"a répondu","es-ES":"respondió"}},resumed:{id:"http://adlnet.gov/expapi/verbs/resumed",display:{"de-DE":"setzte fort","en-US":"resumed","fr-FR":"a repris","es-ES":"continuó"}},satisfied:{id:"https://w3id.org/xapi/adl/verbs/satisfied",display:{"en-US":"satisfied"}},scored:{id:"http://adlnet.gov/expapi/verbs/scored",display:{"de-DE":"erreichte","en-US":"scored","fr-FR":"a marqué","es-ES":"anotó"}},shared:{id:"http://adlnet.gov/expapi/verbs/shared",display:{"de-DE":"teilte","en-US":"shared","fr-FR":"a partagé","es-ES":"compartió"}},suspended:{id:"http://adlnet.gov/expapi/verbs/suspended",display:{"de-DE":"pausierte","en-US":"suspended","fr-FR":"a suspendu","es-ES":"aplazó"}},terminated:{id:"http://adlnet.gov/expapi/verbs/terminated",display:{"de-DE":"beendete","en-US":"terminated","fr-FR":"a terminé","es-ES":"terminó"}},voided:{id:"http://adlnet.gov/expapi/verbs/voided",display:{"de-DE":"entwertete","en-US":"voided","fr-FR":"a annulé","es-ES":"anuló"}},waived:{id:"https://w3id.org/xapi/adl/verbs/waived",display:{"en-US":"waived"}}},Q.extensions={progress:{id:"https://w3id.org/xapi/cmi5/result/extensions/progress"}},Q.activities={interaction:"http://adlnet.gov/expapi/activities/cmi.interaction",objective:"http://adlnet.gov/expapi/activities/objective",profile:{id:"https://w3id.org/xapi/scorm",definition:{type:"http://adlnet.gov/expapi/activities/profile"}}},Q.utils={},Q.utils._initializationTime=(new Date).getTime(),Q.utils.getSessionTime=function(){return(new Date).getTime()-this._initializationTime},Q.utils._interactionTime=(new Date).getTime(),Q.utils.getInteractionLatency=function(){var t=(new Date).getTime()-this._interactionTime;return this.updateInteractionTime(),t},Q.utils.updateInteractionTime=function(){this._interactionTime=(new Date).getTime()},Q.utils.getUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}))},Q.utils.makeInteractionId=function(t,e){return t+"/interaction/"+e},Q.utils.makeObjectiveId=function(t,e){return t+"/objective/"+e},window.XAPIWrapper=Q;try{Z.name="SCORMWrapper"}catch(f){}function tt(){this.type="none",this.wrapper=null,this.enabled=!0,this._debug=!1;var t=this,e=null;switch(tt.utils.isLocal(window)||(this.type=tt.utils.hasXAPIQueryStringParameters(window.location.href)?tt.TYPE_XAPI:tt.TYPE_SCORM),this.type){case tt.TYPE_SCORM:"function"==typeof window.SCORMWrapper&&"object"==typeof window.pipwerks?this.wrapper=new SCORMWrapper:(this.wrapper=new et,e='WARNING : "'+this.type+'" detected but "SCORMWrapper" and/or "pipwerks" not found ! Fallback to "FakeWrapper"');break;case tt.TYPE_XAPI:"function"==typeof window.XAPIWrapper&&"function"==typeof window.TinCan?this.wrapper=new XAPIWrapper:(this.wrapper=new et,e='WARNING : "'+this.type+'" detected but "XAPIWrapper" and/or "TinCan" not found ! Fallback to "FakeWrapper"');break;default:this.wrapper=new et}this.wrapper.debug=this._debug,tt.METHODS.forEach((function(e){tt.prototype[e]="function"==typeof t.wrapper[e]?function(){return t.enabled?t.wrapper[e].apply(t.wrapper,Array.prototype.slice.call(arguments)):tt.utils.createFakeWrapperFunction.call(t.wrapper,e).apply(t.wrapper,Array.prototype.slice.call(arguments))}:tt.utils.createFakeWrapperFunction.call(t.wrapper,e),tt.createMethodAdapter(e)}));var i=[SCORMWrapper,XAPIWrapper,et].find((function(e){return t.wrapper instanceof e})).name,n=function(){this._debug&&(console.log("---------------------------------------------------"),console.log('\tStandard detected : "'+this.type+'"'),console.log('\tWrapper instance : "'+i+'"'),console.log("---------------------------------------------------")),e&&console.warn("\t"+e)};n.call(this),Object.defineProperty(this,"debug",{get:function(){return this._debug},set:function(t){this._debug=this.wrapper.debug=t,n.call(this)}})}function et(){this.debug=!1}Z.prototype.init=function(){return new Promise(function(t){this.api.API.getHandle()?(this.api.version||(console.warn('scorm-wrapper.js :: The version of the SCORM API was manually set to "2004", the value was "'+this.api.version+'".'),this.api.version="2004"),function e(i){var n=i+1;this.api.init()?(this.setCMIExitSuspend(),t(!0)):n<2?window.setTimeout(e.bind(this,n),250):(console.error("scorm-wrapper.js :: SCORM "+this.api.version+" API init failed !"),t(!1))}.call(this,0)):(console.error("scorm-wrapper.js :: No SCORM API found !"),t(!1))}.bind(this))},Z.prototype.save=function(){return new Promise(function(t){(function e(i){var n=i+1,s=this.api.save();!s&&n<2?window.setTimeout(e.bind(this,n),250):t(s)}).call(this,0)}.bind(this))},Z.prototype.quit=function(){return new Promise(function(t){this.api?function e(i){var n=i+1;this.api.quit()?t(!0):n<2?window.setTimeout(e.bind(this,n),250):(console.error("scorm-wrapper.js :: SCORM "+this.api.version+" API quit failed !"),t(!1))}.call(this,0):(console.error("scorm-wrapper.js :: No SCORM API or connection inactive !"),t(!1))}.bind(this))},Z.prototype.setCMIExitSuspend=function(){var t=this.api.set("1.2"===this.api.version?"cmi.core.exit":"cmi.exit","suspend"),e=this.api.save();return t&&e},Z.prototype.getUser=function(){var t=this.api.get("1.2"===this.api.version?"cmi.core.student_id":"cmi.learner_id"),e=this.api.get("1.2"===this.api.version?"cmi.core.student_name":"cmi.learner_name");return Promise.resolve({id:t,name:e})},Z.prototype.getCMILaunchData=function(){var t=this.api.get("cmi.launch_data");return Promise.resolve(t)},Z.prototype.isCompleted=function(){var t;switch(this.api.version){case"1.2":var e=this.api.get("cmi.core.lesson_status");t="completed"===e||"passed"===e||"failed"===e;break;case"2004":t="completed"===this.api.get("cmi.completion_status");break;default:t=!1}return Promise.resolve(t)},Z.prototype.isIncomplete=function(){var t;switch(this.api.version){case"1.2":t="incomplete"===this.api.get("cmi.core.lesson_status");break;case"2004":t="incomplete"===this.api.get("cmi.completion_status");break;default:t=!1}return Promise.resolve(t)},Z.prototype.isNotAttempted=function(){var t;switch(this.api.version){case"1.2":t="not attempted"===this.api.get("cmi.core.lesson_status");break;case"2004":t="not attempted"===this.api.get("cmi.completion_status");break;default:t=!1}return Promise.resolve(t)},Z.prototype.isCompletionUnknown=function(){var t;switch(this.api.version){case"1.2":var e=this.api.get("cmi.core.lesson_status");t=!["passed","completed","failed","incomplete","not attempted"].includes(e);break;case"2004":t="unknown"===this.api.get("cmi.completion_status");break;default:t=!0}return Promise.resolve(t)},Z.prototype.isSuccessUnknown=function(){var t;switch(this.api.version){case"1.2":var e=this.api.get("cmi.core.lesson_status");t=!["passed","completed","failed","incomplete","not attempted"].includes(e);break;case"2004":t="unknown"===this.api.get("cmi.success_status");break;default:t=!0}return Promise.resolve(t)},Z.prototype.isPassed=function(){var t;switch(this.api.version){case"1.2":t="passed"===this.api.get("cmi.core.lesson_status");break;case"2004":t="passed"===this.api.get("cmi.success_status");break;default:t=!1}return Promise.resolve(t)},Z.prototype.isFailed=function(){var t;switch(this.api.version){case"1.2":t="failed"===this.api.get("cmi.core.lesson_status");break;case"2004":t="failed"===this.api.get("cmi.success_status");break;default:t=!1}return Promise.resolve(t)},Z.prototype.getCourseData=function(){var t=this.api.get("cmi.suspend_data"),e=this.parseCourseData(t);return Promise.resolve(e)},Z.prototype.setCourseData=function(t){var e=this.buildCourseData(t.course)+"+"+t.content+"$"+t.timeLeft+"@"+this.buildAssetsData(t.assets);t.comment&&(e+="£"+t.comment);var i=this.api.set("cmi.suspend_data",e);return Promise.resolve(i)},Z.prototype.getCourseLocation=function(){var t="1.2"===this.api.version?"cmi.core.lesson_location":"cmi.location",e=Number.parseFloat(this.api.get(t));return Number.isNaN(e)&&(e=0),Promise.resolve(e)},Z.prototype.setCourseLocation=function(t){var e="1.2"===this.api.version?"cmi.core.lesson_location":"cmi.location",i=this.api.set(e,t);return Promise.resolve(i)},Z.prototype.getCourseDuration=function(){var t,e,i,n="1.2"===this.api.version?"cmi.core.total_time":"cmi.total_time",s=this.api.get(n);if("1.2"===this.api.version){var r=s.split(":").map((function(t){return Number.parseFloat(t)}));t=r[0]||0,e=r[1]||0,i=r[2]||0}else{var o=(s=s.replace("PT","")).indexOf("H");o>-1?(t=Number.parseFloat(s.substring(0,o)),o+=1):t=o=0;var a=s.indexOf("M");a>-1?(e=Number.parseFloat(s.substring(o,s.indexOf("M"))),a+=1):e=a=0,i=s.indexOf("S")>-1?Number.parseFloat(s.substring(a,s.indexOf("S"))):0}var c=1e3*(60*t*60+60*e+i);return Promise.resolve(c)},Z.prototype.setCourseDuration=function(){var t="1.2"===this.api.version?"cmi.core.session_time":"cmi.session_time",e=Z.utils.getStringSessionTime();"2004"===this.api.version&&(e=Z.utils.sessionTimeToScorm2004(e));var i=this.api.set(t,e);return Promise.resolve(i)},Z.prototype.getCourseProgress=function(){var t=0;if("2004"===this.api.version)t=Number.parseFloat(this.api.get("cmi.progress_measure")),Number.isNaN(t)&&(t=0);else{var e=this.api.get("cmi.core.lesson_status");"incomplete"===e?t=50:"completed"!==e&&"passed"!==e&&"failed"!==e||(t=100)}return Promise.resolve(t)},Z.prototype.setCourseProgress=function(t){var e=!0;return"2004"===this.api.version&&(e=this.api.set("cmi.progress_measure",Number.parseFloat(t))),Promise.resolve(e)},Z.prototype.getCourseScore=function(){var t="1.2"===this.api.version?"cmi.core.score.":"cmi.score.",e={},i="min max raw";return"2004"===this.api.version&&(i+=" scaled"),i.split(" ").forEach(function(i){var n=Number.parseFloat(this.api.get(t+i));Number.isNaN(n)||(e[i]=n)}.bind(this)),Promise.resolve(e)},Z.prototype.setCourseScore=function(t){var e="1.2"===this.api.version?"cmi.core.score.":"cmi.score.",i=Object.keys(t).reduce(function(i,n){if("scaled"===n&&"2004"!==this.api.version)return i;var s=this.api.set(e+n,t[n]);return i&&s}.bind(this),!0);return Promise.resolve(i)},Z.prototype.setCourseStarted=function(){var t="1.2"===this.api.version?"cmi.core.lesson_status":"cmi.completion_status",e=this.api.set(t,"incomplete");return Z.utils.updateInteractionTime(),Promise.resolve(e)},Z.prototype.setCourseCompleted=function(){var t="1.2"===this.api.version?"cmi.core.lesson_status":"cmi.completion_status",e=this.api.set(t,"completed");return Promise.resolve(e)},Z.prototype.setCourseIncomplete=function(){var t="1.2"===this.api.version?"cmi.core.lesson_status":"cmi.completion_status",e=this.api.set(t,"incomplete");return Promise.resolve(e)},Z.prototype.setCoursePassed=function(){var t="1.2"===this.api.version?"cmi.core.lesson_status":"cmi.success_status",e=this.api.set(t,"passed");return Promise.resolve(e)},Z.prototype.setCourseFailed=function(){var t="1.2"===this.api.version?"cmi.core.lesson_status":"cmi.success_status",e=this.api.set(t,"failed");return Promise.resolve(e)},Z.prototype.setCourseSuccessUnknown=function(){var t=!1;return this.api&&"2004"===this.api.version&&(t=this.api.set("cmi.success_status","unknown")),Promise.resolve(t)},Z.prototype.setCourseCompletionUnknown=function(){var t=!1;return this.api&&"2004"===this.api.version&&(t=this.api.set("cmi.completion_status","unknown")),Promise.resolve(t)},Z.prototype.sendInteraction=function(t){var e="cmi.interactions.",i="2004"===this.api.version,n="id objectives.0.id time type correct_responses.0.pattern weighting student_response result latency";i?n=n.replace(/time/,"timestamp").replace(/student_response/,"learner_response")+" description":("other"===t.type&&(t.type="performance"),"incorrect"===t.result&&(t.result="wrong")),0===(""+t.objectiveId).trim().length&&(n=n.replace("objectives.0.id ",""));var s=Z.utils.getInteractionLatency(),r=Z.utils.sessionTimeToString(s);t.latency=i?Z.utils.sessionTimeToScorm2004(r):r;var o=Number.parseInt(this.api.get(e+"_count"),10);if(void 0!==t.id){var a=this.getInteractionIndexById(t.id);!Number.isNaN(a)&&a>=0&&(o=a)}var c=n.split(" ").reduce(function(n,s){/time|timestamp/.test(s)&&(t[s]=i?Z.utils.getISOStringDate():Z.utils.getStringTime());var r=e+o+"."+s,a=t[function(t){switch(t){case"objectives.0.id":return"objectiveId";case"correct_responses.0.pattern":return"correctResponse";case"student_response":case"learner_response":return"studentResponse";default:return t}}(s)];/id$/.test(s)&&(a=(a+"").trim());var c=this.api.set(r,a);return this.debug&&console.log("scorm-wrapper.js :: SCORM "+this.api.version+" sendInteraction : ",r,a),n&&c}.bind(this),!0);return Promise.resolve(c)},Z.prototype.sendObjective=function(t){var e="cmi.objectives.",i="id score.min score.max score.raw status";"2004"===this.api.version?i=i.replace(/status/,"")+"score.scaled success_status completion_status progress_measure description":t.status="unknown"!==t.success_status?t.success_status:t.completion_status;var n=Number.parseInt(this.api.get(e+"_count"),10);if(void 0!==t.id){var s=this.getObjectiveIndexById(t.id);!Number.isNaN(s)&&s>=0&&(n=s)}var r=i.split(" ").reduce(function(i,s){var r=e+n+"."+s,o=t[function(t){switch(t){case"score.min":return"scoreMin";case"score.max":return"scoreMax";case"score.raw":return"scoreRaw";case"score.scaled":return"scoreScaled";default:return t}}(s)];"id"===s&&(o=(o+"").trim());var a=this.api.set(r,o);return this.debug&&console.log("scorm-wrapper.js :: SCORM "+this.api.version+" sendObjective : ",r,o),i&&a}.bind(this),!0);return Promise.resolve(r)},Z.prototype.getObjectives=function(){var t="cmi.objectives.",e="id score.min score.max score.raw status";"2004"===this.api.version&&(e=e.replace(/status/,"")+"score.scaled success_status completion_status progress_measure description");var i=function(t){switch(t){case"score.min":return"scoreMin";case"score.max":return"scoreMax";case"score.raw":return"scoreRaw";case"score.scaled":return"scoreScaled";default:return t}},n=Number.parseInt(this.api.get(t+"_count"),10);(Number.isNaN(n)||n<0)&&(n=0);for(var s,r=[],o=0;o<n;o++)s=e.split(" ").reduce(function(e,n){var s=this.api.get(t+o+"."+n);return e[i(n)]=/score|progress/.test(n)?Number.parseFloat(s):s,e}.bind(this),{}),r.push(s);return Promise.resolve(r)},Z.prototype.getInteractionIndexById=function(t){return this.getChildIndexById(t,"cmi.interactions")},Z.prototype.getObjectiveIndexById=function(t){return this.getChildIndexById(t,"cmi.objectives")},Z.prototype.getChildIndexById=function(t,e){for(var i=Number.parseInt(this.api.get(e+"._count"),10),n=0;n<i;n+=1){var s=this.api.get(e+"."+n+".id");if(String(s)===String(t))return n}return-1},Z.prototype.buildCourseData=function(t){return t.reduce((function(t,e){var i=e.id+":"+e.status+":"+e.score;return""===t?i:t+"-"+i}),"")},Z.prototype.buildAssetsData=function(t){return t.reduce((function(t,e){var i=e.id+":"+e.status;return""===t?i:t+"-"+i}),"")},Z.prototype.parseCourseData=function(t){var e=window.decodeURIComponent(t),i="";if(e.indexOf("£")>-1){var n=e.split("£");i=n.pop(),e=n.shift()}var s=[];e.indexOf("@")>-1&&(s=e.split("@").pop().split("-").map((function(t){var e=t.split(":");return{id:e[0]||-1,status:e[1]||"na"}})),e=e.split("@").shift());var r=null;e.indexOf("$")>-1&&(r=Number.parseFloat(e.split("$").pop()),Number.isNaN(r)&&(r=-1),e=e.split("$").shift());var o="";e.indexOf("+")>-1&&(o=e.split("+").pop(),e=e.split("+").shift());var a=[];return e.indexOf(":")>-1&&(a=e.split("-").map((function(t){var e=t.split(":");return{id:e[0]||-1,status:e[1]||"na",score:e[2]||0}}))),{course:a,assets:s,content:o,timeLeft:r,comment:i}},Z.prototype.getADLNavRequest=function(){var t="_none_";return this.api&&"2004"===this.api.version&&(t=this.api.get("adl.nav.request")),Promise.resolve(t)},Z.prototype.setADLNavRequest=function(t){var e=!1;if(this.api&&"2004"===this.api.version){var i;if("string"==typeof t)i="continue previous exit exitAll abandon abandonAll suspendAll _none_".split(" ").indexOf(t)>-1?t:"{target="+t+"}choice";i&&(e=this.api.set("adl.nav.request",i))}return Promise.resolve(e)},Z.prototype.getADLNavRequestValid=function(t){var e="unknown";if(this.api&&"2004"===this.api.version){var i;if("string"==typeof t)i=/^(continue|previous)$/g.test(t.trim())?t.trim():"choice.{target="+t+"}";i&&(e=this.api.get("adl.nav.request_valid."+i))}return Promise.resolve(e)},Z.prototype.getLearnerPreferenceLanguage=function(){var t="";if(this.api){var e="2004"===this.api.version?"learner":"student";t=this.api.get("cmi."+e+"_preference.language")}return Promise.resolve(t)},Z.prototype.setLearnerPreferenceLanguage=function(t){var e=!0;if(this.api){var i="2004"===this.api.version?"learner":"student";e=this.api.set("cmi."+i+"_preference.language",t)}return Promise.resolve(e)},Z.prototype.appendExerciceTime=function(t){if(this.api&&this.api.API&&this.api.API.getHandle()){var e=this.api.API.getHandle();"function"==typeof e.AppendExerciceTime&&e.AppendExerciceTime(t)}return Promise.resolve()},Z.utils={},Z.utils._initializationTime=(new Date).getTime(),Z.utils.getSessionTime=function(){return(new Date).getTime()-this._initializationTime},Z.utils._interactionTime=(new Date).getTime(),Z.utils.getInteractionLatency=function(){var t=(new Date).getTime()-this._interactionTime;return this.updateInteractionTime(),t},Z.utils.updateInteractionTime=function(){this._interactionTime=(new Date).getTime()},Z.utils.getStringSessionTime=function(){return this.sessionTimeToString(this.getSessionTime())},Z.utils.sessionTimeToString=function(t){var e=t,i=Math.floor(e/36e5);i<0&&(i=0),e%=36e5;var n=Math.floor(e/6e5);e%=6e5;var s=Math.floor(e/6e4);e%=6e4;var r=Math.floor(e/1e4);e%=1e4;var o=Math.floor(e/1e3);return(i<9?"0"+String(i):String(i))+":"+n+s+":"+r+o},Z.utils.milliSecondsToSCORM2004Time=function(t){var e,i,n,s,r,o,a,c="",l=6e3,u=36e4,h=864e4,d=26298e4,p=315576e4;return e=Math.floor(t/10),e-=(a=Math.floor(e/p))*p,e-=(o=Math.floor(e/d))*d,e-=(r=Math.floor(e/h))*h,e-=(s=Math.floor(e/u))*u,e-=(n=Math.floor(e/l))*l,a>0&&(c+=a+"Y"),o>0&&(c+=o+"M"),r>0&&(c+=r+"D"),(e-=100*(i=Math.floor(e/100)))+i+n+s>0&&(c+="T",s>0&&(c+=s+"H"),n>0&&(c+=n+"M"),e+i>0&&(c+=i,e>0&&(c+="."+e),c+="S")),""===c&&(c="0S"),c="P"+c},Z.utils.sessionTimeToScorm2004=function(t){var e=t.split(":"),i=Number.parseInt(e[0],10);return"PT"+(i<1e3?"0":"")+(i<100?"0":"")+e[0]+"H"+e[1]+"M"+e[2]+"S"},Z.utils.getUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}))},Z.utils.getStringTime=function(){var t=function(t){return(t<10?"0":"")+t},e=new Date;return t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())},Z.utils.getISOStringDate=function(){var t=(new Date).toISOString(),e=t.split(".").pop();return t.replace(e,e.substring(0,1)+"Z")},Z.utils.round=function(t,e){var i=Math.pow(10,e||2);return Math.round(t*i)/i},Z.utils.isRemoteSCORMContext=function(t){var e=t||window;try{return void 0!==e.ofp_waitForDistantSCORMAPI&&e.ofp_waitForDistantSCORMAPI}catch(t){return!1}},window.SCORMWrapper=Z,tt.METHODS="init save quit isCompleted isIncomplete isNotAttempted isCompletionUnknown isSuccessUnknown isPassed isFailed getUser setCourseStarted getCourseData setCourseData getCourseLocation setCourseLocation getCourseDuration setCourseDuration getCourseProgress setCourseProgress getCourseScore setCourseScore setCourseCompleted setCoursePassed setCourseFailed setCourseCompletionUnknown setCourseSuccessUnknown sendInteraction sendObjective getObjectives".split(" "),tt.TYPE_SCORM="SCORM",tt.TYPE_XAPI="xAPI";try{et.name="FakeWrapper"}catch(f){}tt.utils={},tt.utils.decode=function(t){return window.decodeURIComponent(t.replace(/\+/g," "))},tt.utils.isLocal=function(t){return/^file/i.test(t.location.protocol)},tt.utils.round=function(t,e){var i=Math.pow(10,e||2);return Math.round(t*i)/i},tt.utils.hasXAPIQueryStringParameters=function(t){var e=this.decode(t);return/[?&]actor\={/g.test(e)&&/[?&]endpoint\=/g.test(e)&&/[?&]activity_id\=/g.test(e)},tt.utils.createFakeWrapperFunction=function(t){var e;switch(t){case"init":case"save":case"quit":case"setCourseStarted":case"setCourseData":case"setCourseLocation":case"setCourseDuration":case"setCourseProgress":case"setCourseScore":case"setCourseCompleted":case"setCoursePassed":case"setCourseFailed":case"sendInteraction":case"sendObjective":e=!0;break;case"isCompleted":case"isIncomplete":case"isNotAttempted":case"isCompletionUnknown":case"isSuccessUnknown":case"isPassed":case"isFailed":e=!1;break;default:e=null}return function(){var i=Array.prototype.slice.call(arguments);return this.debug&&(console.log(et.name+' :: function "'+t+'" called'+(i.length>0?" with "+i.length+" arguments : ":"")),i.forEach((function(t,e){console.log("\t-argument "+(e+1)+" = ",t)}))),Promise.resolve(e)}.bind(this)},tt.utils.promisify=function(t){return new Promise((function(e,i){var n=t.apply(null,Array.prototype.slice.call(arguments));try{return n.then(e,i)}catch(t){return t instanceof TypeError?e(n):i(t),!0}}))},tt.createMethodAdapter=function(t){var e=Object.prototype.hasOwnProperty;switch(t){case"setCourseScore":var i=tt.prototype[t];tt.prototype[t]=function(t){var n="min max raw scaled".split(" ").every((function(i){return!e.call(t,i)||Number.isNaN(t[i])}));if(!t||n)throw new Error("setCourseScore :: invalid data : "+JSON.stringify(t)+". (!) min, max, raw or scaled required");var s={scaled:0};if(t){var r=e.call(t,"min")&&!Number.isNaN(t.min),o=e.call(t,"raw")&&!Number.isNaN(t.raw),a=e.call(t,"max")&&!Number.isNaN(t.max),c=e.call(t,"scaled")&&!Number.isNaN(t.scaled);!c&&o&&a&&(t.scaled=t.max>0?Math.round(t.raw/t.max*100)/100:0),!r&&o&&a&&(t.min=0),(r||o||a||c)&&Object.assign(s,t)}return i(s)};break;case"sendInteraction":var n=tt.prototype[t];tt.prototype[t]=function(t){var i="id type result".split(" ").some((function(i){return!e.call(t,i)||null===t[i]||void 0===t[i]}));if(!t||i)throw new Error("sendInteraction :: invalid data : "+JSON.stringify(t)+". (!) id, type and result required");var s={objectiveId:"",correctResponse:"",studentResponse:"",weighting:1,description:""};return t&&(Object.assign(s,t),e.call(s,"result")&&"number"==typeof s.result&&(s.result=s.result>0?"correct":"incorrect"),"correctResponse studentResponse".split(" ").forEach((function(t){s[t]=(s[t]+"").replace(/(\.|\,)/g,"[$1]")}))),n(s)};break;case"sendObjective":var s=tt.prototype[t];tt.prototype[t]=function(t){if(!t||!e.call(t,"id")||null===t.id||void 0===t.id)throw new Error("sendObjective :: invalid data : "+JSON.stringify(t)+". (!) id required");var i={scoreMin:0,scoreMax:100,scoreRaw:0,scoreScaled:0,success_status:"unknown",completion_status:"unknown",progress_measure:0,description:""};return t&&(Object.assign(i,t),i.scoreScaled=i.scoreMax>0?tt.utils.round(i.scoreRaw/i.scoreMax):0),s(i)};break;case"methodName":var r=tt.prototype[t];tt.prototype[t]=tt.utils.promisify(r).then((function(t){return Object.assign({},t)}));break;case"quit":var o=tt.prototype[t],a=!1;tt.prototype[t]=function(){return!a&&(a=!0,tt.utils.promisify(o).then((function(t){return a=!1,t})))}}},window.Standard=tt;class it{static PHP_TUTOR_URL="/apprenant/tutorat.php";constructor(){this.services={mail:{enabled:!1,value:""},chat:{enabled:!1,value:""},visio:{enabled:!1,value:""}}}async init(){try{const t=await fetch(it.PHP_TUTOR_URL,{method:"GET"});if(!t.ok)throw new Error(`Tutoring :: Error fetching data: ${t.statusText}`);this.processConfig(await t.text())}catch(t){console.error("Tutor.js :: init :: error with status",t)}}processConfig(t){(new DOMParser).parseFromString(t,"application/xml").querySelectorAll("CONFIG BOUTON").forEach((t=>{const e=t.querySelector("LABEL"),i=t.querySelector("PARAMS PARAM");let n="",s="";switch(e&&(n=e.textContent.toLowerCase()),i&&(s=i.textContent),n){case"email":this.services.mail.enabled=!0,this.services.mail.value=s;break;case"chat":this.services.chat.enabled=!0,this.initializeChat();break;case"visio":this.services.visio.enabled=!0}}))}initializeChat(){void 0===window.lpTag?(window.lpTag={site:"95053",section:window.lpTag?.section||"",autoStart:!1!==window.lpTag?.autoStart,ovr:window.lpTag?.ovr||{},_v:"1.6.0",_tagCount:1,protocol:"https:",events:{bind:(t,e,i)=>lpTag.defer((()=>lpTag.events.bind(t,e,i)),0),trigger:(t,e,i)=>lpTag.defer((()=>lpTag.events.trigger(t,e,i)),1)},defer:function(t,e){0===e?(this._defB=this._defB||[],this._defB.push(t)):1===e?(this._defT=this._defT||[],this._defT.push(t)):(this._defL=this._defL||[],this._defL.push(t))},load:function(t,e,i){setTimeout((()=>{this._load(t,e,i)}),0)},_load:function(t,e,i){const n=t||`${this.protocol}//${this.ovr?.domain||"lptag.liveperson.net"}/tag/tag.js?site=${this.site}`,s=document.createElement("script");s.setAttribute("charset",e||"UTF-8"),i&&s.setAttribute("id",i),s.setAttribute("src",n),document.head.appendChild(s)},init:function(){this._timing=this._timing||{},this._timing.start=Date.now(),window.attachEvent?window.attachEvent("onload",(()=>this._domReady("domReady"))):(window.addEventListener("DOMContentLoaded",(()=>this._domReady("contReady")),!1),window.addEventListener("load",(()=>this._domReady("domReady")),!1)),void 0===window._lptStop&&this.load()},start:function(){this.autoStart=!0},_domReady:function(t){if(!this.isDom){this.isDom=!0;const e=document.createElement("div");e.id="LP_DIV_1469450220152",e.style.position="absolute",e.style.display="none",document.body.appendChild(e),this.events.trigger("LPT","DOM_READY",{t:t})}this._timing[t]=Date.now()},vars:window.lpTag?.vars||[],dbs:window.lpTag?.dbs||[],ctn:window.lpTag?.ctn||[],sdes:window.lpTag?.sdes||[],ev:window.lpTag?.ev||[]},lpTag.init()):window.lpTag._tagCount+=1,window.lpTag._domReady("domReady")}getAvailableServices(){const t=[];for(const e in this.services)this.services[e].enabled&&t.push(e);return t}mail(){if(!this.services.mail.enabled)return;const t=`/apprenant/formulaire.php?emailde=${encodeURIComponent(this.services.mail.value)}`;window.open(t,"EMAIL","width=550,height=321")}chat(){if(!this.services.chat.enabled)return;const t=()=>{const e=document.getElementById("LP_DIV_1469450220152");if(e&&e.firstChild){const t=e.firstChild;t&&t.firstChild?t.firstChild.click():window.open(`http://server.iad.liveperson.net/hc/95053/?cmd=file&file=visitorWantsToChat&site=95053&referrer=${window.document.location}`,"chat95053","width=472,height=320")}else setTimeout(t,100)};try{t()}catch(t){window.open(`http://server.iad.liveperson.net/hc/95053/?cmd=file&file=visitorWantsToChat&site=95053&referrer=${window.document.location}`,"chat95053","width=472,height=320")}}visio(){this.services.visio.enabled&&window.open("/visio/liste_tuteur_accessible.php","visiotuteur","scrollbars=no,width=300,height=175")}}let nt;class st extends i{static get LOAD(){return"ScormManager.LOAD"}static get ERROR(){return"ScormManager.error"}static get ERROR_CODE(){return Object.freeze({INIT:1,MISC:2457})}#t="[ScormManager] ••••";#e=!1;#i=null;#n={};constructor(t={}){if(nt)return nt;super(),nt=this,this.options={debug:!1,autoSave:!0,autoCheckCompleted:!0,autoSendDuration:!0,throttleMethods:["save"],throttleDuration:250,...t},this.loaded=!1,this.initialized=!1,this.api=null,this.debug=this.options.debug}get debug(){return this.#e}set debug(t){"boolean"==typeof t&&(this.#e=t)}get data(){return{course:[],assets:[],content:"",comment:"",timeLeft:-1,...this.#n.data}}get learner(){return{id:"",name:"",...this.#n.learner}}get launchData(){return this.#n.launchData||""}get suspendData(){return this.data.content||""}get suspendComment(){return this.data.comment||""}get timeLeft(){return this.data.timeLeft||""}get progress(){return this.#n.progress||0}get completionUnknown(){return this.#n.completionUnknown||!1}get successUnknown(){return this.#n.successUnknown||!1}get passed(){return this.#n.passed||!1}get failed(){return this.#n.failed||!1}get incomplete(){return this.#n.incomplete||!1}get notAttempted(){return this.#n.notAttempted||!1}get completed(){return this.#n.completed||!1}get duration(){return this.#n.duration||0}get location(){return this.#n.location||0}get score(){return{min:0,max:0,raw:0,scaled:0,...this.#n.score}}#s(t,e){const i=`🔺${this.#t}`;this.debug&&console.error.apply(console,[i,t]),this.emit(st.ERROR,{message:t,code:e})}#r(...t){const e=`🔸${this.#t}`;this.debug&&console.warn.apply(console,[e,...t])}#o(...t){const e=`🔹${this.#t}`;this.debug&&console.log.apply(console,[e,...t])}#a(){this.options.throttleMethods.forEach((t=>{const e={};"string"==typeof t?(e.method=t,e.duration=this.options.throttleDuration):(e.method=t.method,e.duration=t.duration||this.options.throttleDuration);const{method:i,duration:n}=e;this[i]&&"function"==typeof this[i]&&(this[i]=function(t,e){let i=null,n=0;return function(...s){const r=this;return e<=0?t.apply(r,s):i?(clearTimeout(i),n++,i=setTimeout((()=>{n>1&&t.apply(r,s),i=null,n=0}),e),Promise.resolve()):(n++,i=setTimeout((()=>{i=null}),e),t.apply(r,s))}}(this[i].bind(this),n))}))}async init(){if(this.loaded)return Promise.resolve();this.#a();const t=rt("Standard");if(null!=t){this.#i||(this.#i=new t.Standard),await async function(){let t=rt("ofp_waitForDistantSCORMAPI");if(t&&t.ofp_waitForDistantSCORMAPI)return async function(t){return new Promise((function(e){const i=()=>{t.ofp_distantSCORMAPILoaded?e():setTimeout(i,250)};i()}))}(t);return Promise.resolve()}();try{if(!await this.#i.init()&&this.#i.type===t.Standard.TYPE_SCORM){const t=this.#i.wrapper.api.API.getHandle();throw new Error(t?"Failed to initialize Scorm":"Failed to find scorm API",{cause:st.ERROR_CODE.INIT})}this.#i.wrapper.api?this.#n.launchData=await this.#i.wrapper.api.get("cmi.launch_data"):this.#n.launchData="",this.loaded=!0,this.api=this.#i.wrapper.api,await this.refreshDatas(),this.emit(st.LOAD)}catch(t){this.#n.data=this.data,this.#n.learner=this.learner,this.#n.progress=this.progress,this.#n.location=this.location,this.#n.score=this.score,this.#n.duration=this.duration,this.#n.passed=!1,this.#n.failed=!1,this.#n.notAttempted=!1,this.#n.completed=!1,this.#n.completionUnknown=!1,this.#n.successUnknown=!1,this.#n.incomplete=!0,this.#s(t,t.cause||st.ERROR_CODE.MISC)}this.loaded||this.#r("ScormManager is not loaded yet. Data will be saved locally."),this.initialized=!0,!0===this.#n.notAttempted&&await this.incompleteCourse()}else this.#s("Failed to initialize ScormManager, standard is missing",st.ERROR_CODE.INIT)}async refreshDatas(){if(!this.loaded)return!1;this.#n.data={...this.data,...await this.#i.getCourseData()},this.#n.learner={...this.learner,...await this.#i.getUser()},this.#n.progress=await this.#i.getCourseProgress(),this.#n.location=await this.#i.getCourseLocation(),this.#n.passed=await this.#i.isPassed(),this.#n.failed=await this.#i.isFailed(),this.#n.incomplete=await this.#i.isIncomplete(),this.#n.notAttempted=await this.#i.isNotAttempted(),this.#n.completed=await this.#i.isCompleted(),this.#n.completionUnknown=await this.#i.isCompletionUnknown(),this.#n.successUnknown=await this.#i.isSuccessUnknown(),this.#n.score={...this.score,...await this.#i.getCourseScore()},this.#n.duration=await this.#i.getCourseDuration()}async requireInit(){if(!this.initialized)throw this.#s("ScormManager is not initialized yet.",st.ERROR_CODE.INIT),new Error("ScormManager is not initialized yet.")}async autoCheckCompleted(){return await this.requireInit(),!!this.options.autoCheckCompleted&&this.isCompleted()}async isCompleted(){await this.requireInit();const t=this.api?await this.#i.isCompleted():this.#n.completed;if(this.#n.completed=t,t&&(this.#n.incomplete=!1,this.#n.notAttempted=!1,this.#n.completionUnknown=!1,this.api&&"1.2"===this.api.version)){const t=this.api?await this.#i.isPassed():this.#n.passed,e=this.api?await this.#i.isFailed():this.#n.failed;this.#n.passed=t,this.#n.failed=e,this.#n.successUnknown=!1}return this.#o("[isCompleted] "+(t?"Course is completed.":"Course is not completed.")),t}async isPassed(){await this.requireInit();const t=this.api?await this.#i.isPassed():this.#n.passed;return this.#n.passed=t,t&&(this.#n.failed=!1,this.#n.successUnknown=!1,this.api&&"1.2"===this.api.version&&(this.#n.completed=!0,this.#n.incomplete=!1,this.#n.notAttempted=!1,this.#n.completionUnknown=!1)),this.#o("[isPassed] "+(t?"Course is passed.":"Course is not passed.")),t}async isFailed(){await this.requireInit();const t=this.api?await this.#i.isFailed():this.#n.failed;return this.#n.failed=t,t&&(this.#n.passed=!1,this.#n.successUnknown=!1,this.api&&"1.2"===this.api.version&&(this.#n.completed=!0,this.#n.incomplete=!1,this.#n.notAttempted=!1,this.#n.completionUnknown=!1)),this.#o("[isFailed] "+(t?"Course is failed.":"Course is not failed.")),t}async isIncomplete(){await this.requireInit();const t=this.api?await this.#i.isIncomplete():this.#n.incomplete;return this.#n.incomplete=t,t&&(this.#n.completed=!1,this.#n.notAttempted=!1,this.#n.completionUnknown=!1,this.api&&"1.2"===this.api.version&&(this.#n.passed=!1,this.#n.failed=!1,this.#n.successUnknown=!1)),this.#o("[isIncomplete] "+(t?"Course is incomplete.":"Course is not incomplete.")),t}async isNotAttempted(){await this.requireInit();const t=this.api?await this.#i.isNotAttempted():this.#n.notAttempted;return this.#n.notAttempted=t,t&&(this.#n.completed=!1,this.#n.incomplete=!1,this.#n.completionUnknown=!1,this.api&&"1.2"===this.api.version&&(this.#n.passed=!1,this.#n.failed=!1,this.#n.successUnknown=!1)),this.#o("[isNotAttempted] "+(t?"Course is not attempted.":"Course is attempted.")),t}async isCompletionUnknown(){if(await this.requireInit(),this.api&&"1.2"===this.api.version)return this.#r("[isCompletionUnknown] Ignored because is not compatible with this scorm version."),!1;const t=this.api?await this.#i.isCompletionUnknown():this.#n.completionUnknown;return this.#n.completionUnknown=t,t&&(this.#n.completed=!1,this.#n.incomplete=!1,this.#n.notAttempted=!1),this.#o("[isCompletionUnknown] "+(t?"Completion status is unknown.":"Completion status is known.")),t}async isSuccessUnknown(){if(await this.requireInit(),this.api&&"1.2"===this.api.version)return this.#r("[isCompletionUnknown] Ignored because is not compatible with this scorm version."),!1;const t=this.api?await this.#i.isSuccessUnknown():this.#n.successUnknown;return this.#n.successUnknown=t,t&&(this.#n.failed=!1,this.#n.passed=!1),this.#o("[isSuccessUnknown] "+(t?"Success status is unknown.":"Success status is known.")),t}async autoSave(){return await this.requireInit(),this.options.autoSave?this.save():Promise.resolve()}async autoSendDuration(){return await this.requireInit(),this.options.autoSendDuration?this.#c():Promise.resolve()}async save(){await this.requireInit(),this.#o("[save] Saving...");try{await this.#i.save(),this.#o("[save] Done.")}catch(t){throw this.#s(t,st.ERROR_CODE.MISC),t}}async sendData(){await this.requireInit();const t=this.options.autoCheckCompleted,e=this.options.autoSave,i=this.options.autoSendDuration;if(!0===await this.autoCheckCompleted())return this.#r("[sendData] Cancelled due completed."),!1;t&&(this.options.autoCheckCompleted=!1),e&&(this.options.autoSave=!1),i&&(this.options.autoSendDuration=!1);try{await this.setCourseData(this.data),await this.setLocation(this.location),await this.sendDuration(),await this.setProgress(this.progress),this.options.autoCheckCompleted=t,this.options.autoSave=e,this.options.autoSendDuration=i,e&&await this.save()}catch(t){throw this.#s(t,st.ERROR_CODE.MISC),t}finally{this.options.autoCheckCompleted=t,this.options.autoSave=e}}async setCourseData(t){await this.requireInit(),this.#o(`[setCourseData] Set given value => {${typeof t}}`,t);const e=await this.autoCheckCompleted(),i=this.#n.data;if(!1===e)try{this.#n.data=t,await this.#i.setCourseData(t),this.#o("[setCourseData] Done."),await this.autoSendDuration(),await this.autoSave()}catch(t){throw this.#n.data=i,this.#s(t,st.ERROR_CODE.MISC),t}else this.#r("[setCourseData] Cancelled due completed.")}async setSuspendData(t){await this.requireInit();const e=this.#n.data.content;if(e===t)return!1;this.#o(`[setSuspendData] Set given value => {${typeof t}}`,t);try{this.#n.data.content=t,await this.setCourseData(this.data),this.#o("[setSuspendData] Done.")}catch(t){throw this.#n.data.content=e,this.#s("[setSuspendData] Failed.",st.ERROR_CODE.MISC),t}}async setSuspendComment(t){await this.requireInit();const e=this.#n.data.comment;if(e===t)return!1;this.#o(`[setSuspendComment] Set given value => {${typeof t}}`,t);try{this.#n.data.comment=t,await this.setCourseData(this.data),this.#o("[setSuspendComment] Done.")}catch(t){throw this.#n.data.comment=e,this.#s("[setSuspendComment] Failed.",st.ERROR_CODE.MISC),t}}async setFileData(t,e){await this.requireInit(),this.#o(`[setFileData] Set given value => {${typeof t}}`,t);const i=this.#n.data.course.slice();try{if("number"!=typeof e||Number.isNaN(e))this.#n.data.course=t;else{const i=this.#n.data.course.findIndex((t=>Number(t.id)===e));if(-1===i)throw new Error(`[setFileData] File with id ${e} not found.`);this.#n.data.course[i]=t}await this.setCourseData(this.data),this.#o("[setFileData] Done.")}catch(t){throw this.#n.data.course=i,this.#s("[setFileData] Failed.",st.ERROR_CODE.MISC),t}}async setAssetsData(t,e){await this.requireInit(),this.#o(`[setAssetsData] Set given value => {${typeof t}}`,t);const i=this.#n.data.assets.slice();try{if("number"!=typeof e||Number.isNaN(e))this.#n.data.assets=t;else{const i=this.#n.data.assets.findIndex((t=>Number(t.id)===e));if(-1===i)throw new Error(`[setAssetsData] Asset with id ${e} not found.`);this.#n.data.assets[i]=t}await this.setCourseData(this.data),this.#o("[setAssetsData] Done.")}catch(t){throw this.#n.data.assets=i,this.#s("[setAssetsData] Failed.",st.ERROR_CODE.MISC),t}}async setTimeLeft(t){await this.requireInit();const e=this.#n.data.timeLeft;if(e===t)return!1;this.#o(`[setTimeLeft] Set given value => {${typeof t}}`,t);try{this.#n.data.timeLeft=t,await this.setCourseData(this.data),this.#o("[setTimeLeft] Done.")}catch(t){throw this.#n.data.timeLeft=e,this.#s("[setTimeLeft] Failed.",st.ERROR_CODE.MISC),t}}async sendDuration(){await this.#c(),await this.autoSave()}async#c(){await this.requireInit(),this.#o("[sendDuration] Started");if(!1===await this.autoCheckCompleted())try{await this.#i.setCourseDuration(),this.#n.duration=await this.#i.getCourseDuration(),this.#o("[sendDuration] Done.")}catch(t){throw this.#s(t,st.ERROR_CODE.MISC),t}else this.#r("[sendDuration] Cancelled due completed.")}async setObjective(t){await this.requireInit(),this.#o(`[setObjective] Set given value => {${typeof t}}`,t);if(!1===await this.autoCheckCompleted())try{await this.#i.sendObjective(t),this.#o("[setObjective] Done."),await this.autoSendDuration(),await this.autoSave()}catch(t){throw this.#s(t,st.ERROR_CODE.MISC),t}else this.#r("[setObjective] Cancelled due completed.")}async setInteraction(t){await this.requireInit(),this.#o(`[setInteraction] Set given value => {${typeof t}}`,t);if(!1===await this.autoCheckCompleted())try{await this.#i.sendInteraction(t),this.#o("[setInteraction] Done."),await this.autoSendDuration(),await this.autoSave()}catch(t){throw this.#s(t,st.ERROR_CODE.MISC),t}else this.#r("[setInteraction] Cancelled due completed.")}async setLocation(t){if(await this.requireInit(),this.#n.location===t)return!1;this.#o(`[setLocation] Set given value => {${typeof t}}`,t);if(!1===await this.autoCheckCompleted())try{await this.#i.setCourseLocation(t),this.#n.location=t,this.#o("[setLocation] Done."),await this.autoSendDuration(),await this.autoSave()}catch(t){throw this.#s(t,st.ERROR_CODE.MISC),t}else this.#r("[setLocation] Cancelled due completed.")}async setProgress(t){if(await this.requireInit(),this.api&&"1.2"===this.api.version)return this.#r("[setProgress] Ignored because is not compatible with this scorm version."),!1;if(this.#n.progress===t)return!1;this.#o(`[setProgress] Set given value => {${typeof t}}`,t);if(!1===await this.autoCheckCompleted())try{await this.#i.setCourseProgress(t),this.#n.progress=t,this.#o("[setProgress] Done."),await this.autoSendDuration(),await this.autoSave()}catch(t){throw this.#s(t,st.ERROR_CODE.MISC),t}else this.#r("[setProgress] Cancelled due completed.")}async setScore(t){await this.requireInit(),this.#o(`[setScore] Set given value => {${typeof t}}`,t);const e=this.#n.score,i={...e,...t};"object"!=typeof t&&this.#r("[setScore] Given value looks wrong converted it to => {object}",i),i.min=n(0,i.min,100),i.max=n(0===i.min?1:i.min,i.max,100),i.raw=n(i.min,i.raw,i.max);const s=parseFloat((i.raw/i.max).toFixed(2));if(t.scaled||i.scaled===s||(i.scaled=s),e.raw===i.raw&&e.max===i.max&&e.scaled===i.scaled)return!1;i.scaled&&this.api&&"1.2"===this.api.version&&(this.#r("[setScore] Scaled will not be setted because it's not compatible with this scorm version."),delete i.scaled),this.#o(`[setScore] Set normalized value => {${typeof i}}`,i);if(!1===await this.autoCheckCompleted())try{await this.#i.setCourseScore(i),this.#n.score=i,this.#o("[setScore] Done."),await this.autoSendDuration(),await this.autoSave()}catch(t){throw this.#s(t,st.ERROR_CODE.MISC),t}else this.#r("[setScore] Cancelled due completed.")}async incompleteCourse(){if(await this.requireInit(),!0===this.#n.incomplete)return!1;this.#o("[incompleteCourse] Processing...");try{await this.autoSendDuration(),await this.#i.setCourseStarted(),this.#n.incomplete=!0,this.#n.completed=!1,this.#n.notAttempted=!1,this.#n.completionUnknown=!1,this.api&&"1.2"===this.api.version&&(this.#n.passed=!1,this.#n.failed=!1,this.#n.successUnknown=!1),this.#o("[incompleteCourse] Done."),await this.autoSave()}catch(t){throw this.#s(t,st.ERROR_CODE.MISC),t}}async completeCourse(){if(await this.requireInit(),!0===this.#n.completed)return!1;this.#o("[completeCourse] Processing...");try{await this.autoSendDuration(),await this.#i.setCourseCompleted(),this.#n.completed=!0,this.#n.incomplete=!1,this.#n.notAttempted=!1,this.#n.completionUnknown=!1,this.api&&"1.2"===this.api.version&&(this.#n.passed=!1,this.#n.failed=!1,this.#n.successUnknown=!1),this.#o("[completeCourse] Done."),await this.autoSave()}catch(t){throw this.#s(t,st.ERROR_CODE.MISC),t}}async setCompletionUnknown(){if(await this.requireInit(),this.api&&"1.2"===this.api.version)return this.#r("[setCompletionUnknown] Ignored because is not compatible with this scorm version."),!1;if(!0===this.#n.completionUnknown)return!1;this.#o("[setCompletionUnknown] Processing...");try{await this.autoSendDuration(),await this.#i.setCourseCompletionUnknown(),this.#n.completionUnknown=!0,this.#n.incomplete=!1,this.#n.completed=!1,this.#n.notAttempted=!1,this.#o("[setCompletionUnknown] Done."),await this.autoSave()}catch(t){throw this.#s(t,st.ERROR_CODE.MISC),t}}async setSuccessUnknown(){if(await this.requireInit(),this.api&&"1.2"===this.api.version)return this.#r("[setSuccessUnknown] Ignored because is not compatible with this scorm version."),!1;if(!0===this.#n.successUnknown)return!1;this.#o("[setSuccessUnknown] Processing...");try{await this.autoSendDuration(),await this.#i.setCourseSuccessUnknown(),this.#n.successUnknown=!0,this.#n.failed=!1,this.#n.passed=!1,this.#o("[setSuccessUnknown] Done."),await this.autoSave()}catch(t){throw this.#s(t,st.ERROR_CODE.MISC),t}}async setSuccess(){if(await this.requireInit(),!0===this.#n.passed)return!1;this.#o("[setSuccess] Processing...");try{await this.autoSendDuration(),await this.#i.setCoursePassed(),this.#n.passed=!0,this.#n.failed=!1,this.#n.successUnknown=!1,this.api&&"1.2"===this.api.version&&(this.#n.completed=!1,this.#n.incomplete=!1,this.#n.notAttempted=!1,this.#n.completionUnknown=!1),this.#o("[setSuccess] Done."),await this.autoSave()}catch(t){throw this.#s(t,st.ERROR_CODE.MISC),t}}async setFailed(){if(await this.requireInit(),!0===this.#n.failed)return!1;this.#o("[setFailed] Processing...");try{await this.autoSendDuration(),await this.#i.setCourseFailed(),this.#n.failed=!0,this.#n.passed=!1,this.#n.successUnknown=!1,this.api&&"1.2"===this.api.version&&(this.#n.completed=!1,this.#n.incomplete=!1,this.#n.notAttempted=!1,this.#n.completionUnknown=!1),this.#o("[setFailed] Done."),await this.autoSave()}catch(t){throw this.#s(t,st.ERROR_CODE.MISC),t}}async suspend(){await this.requireInit(),this.#o("[suspend] Processing...");try{await this.#i.quit(),this.#o("[suspend] Done."),function(){const t=rt("ofpSCOExit");if(t)t.ofpSCOExit();else{const t=function(){let t=window;for(;!t.opener&&t.parent!==t;)t=t.parent;return t.opener?t:null}();t?t.close():window.history.length>1?window.history.go(-1):window.alert("Vous pouvez désormais fermer votre fenêtre.")}}()}catch(t){throw this.#s(t,st.ERROR_CODE.MISC),t}}async quit(){return await this.requireInit(),this.#i.quit()}}function rt(t,e){let i=window,n=i,s=null;do{n=i,s=void 0!==i[t]?i:null,i=i.parent}while(!s&&n!==i);return s}class ot{constructor(){this.element=document.querySelector("#scaleLoader")}show(){this.element&&this.element.classList.remove("hide")}hide(){this.element&&this.element.classList.add("hide")}}class at{constructor(t,e){this.device=t,this.modes=e,this.element=document.querySelector("#rotate"),this.boundHandleOrientationChange=this.handleOrientationChange.bind(this),this.init()}init(){0===this.modes.length&&this.element&&this.element.classList.add("no-support"),this.handleOrientationChange(),screen.orientation&&screen.orientation.addEventListener?screen.orientation.addEventListener(s.CHANGE,this.boundHandleOrientationChange):window.addEventListener("orientationchange",this.boundHandleOrientationChange)}handleOrientationChange(){this.device.mobile&&this.element&&(this.modes.includes(this.device.orientation)?this.element.classList.remove("show"):this.element.classList.add("show"))}}class ct{constructor(){this.element=document.querySelector(".popup"),this.buttonEventsMap={},this.init()}init(){this.element&&(this.overlay=this.element.querySelector(".popup-overlay"),this.message=this.element.querySelector(".popup-message"),this.buttons=Array.from(this.element.querySelectorAll(".popup-button")),this.overlay&&this.overlay.addEventListener(s.CLICK_TOUCH,this.hide.bind(this)),this.buttons.forEach((t=>{t.addEventListener(s.CLICK_TOUCH,this.handleButtonClick.bind(this))})))}handleButtonClick(t){const e=t.currentTarget;for(const i in this.buttonEventsMap)if(lt(i,e)){const e=this.buttonEventsMap[i];e&&(this.buttonEventsMap[i]=e.filter((e=>(e.callback.call(this,t),!e.once))))}this.hide()}getButtons(t){return 0===this.buttons.length?[]:this.buttons.filter((e=>lt(t,e)))}assignButtonCallback(t,e){if(0===this.buttons.length)return;const i={callback:()=>{},deleteOnHide:!1,once:!1,...e};0!==this.getButtons(t).length&&(this.buttonEventsMap[t]||(this.buttonEventsMap[t]=[]),this.buttonEventsMap[t].push(i))}clearButtonCallbacks(t){delete this.buttonEventsMap[t]}setMessage(t){this.message&&(this.message.innerHTML=t)}show(){this.element&&(this.element.classList.add("show"),this.element.setAttribute("aria-hidden","false"))}hide(){if(this.element){this.element.classList.remove("show"),this.element.setAttribute("aria-hidden","true");for(const t in this.buttonEventsMap){const e=this.buttonEventsMap[t];this.buttonEventsMap[t]=e.filter((t=>!t.deleteOnHide))}}}}function lt(t,e){const i=e.dataset.descriptor===t,n=e.classList.contains(t);return!(!i&&!n)}class ut{constructor(t){this.container=r(t),this.container&&!this.container.classList.contains("no-resize")&&(this.data={bounding:null,resize:{scale:1,top:0,left:0}},this.elements={},this.device=new e,this.metaScale="iOS"===this.device.os&&this.device.mobile,this.windowResize=new a,this.renderer=new c,this.currentScale=1,this.boundResize=this.resize.bind(this),this.init(),this.render())}init(){if(this.windowResize.on(a.CHANGED,this.boundResize),this.elements.html=document.querySelector("html"),this.elements.head=this.elements.html.querySelector("head"),this.elements.metaViewport=this.elements.head.querySelector("meta[name=viewport]"),this.metaScale&&!this.elements.metaViewport){const t=document.createElement("meta");t.name="viewport",t.content="width=device-width, initial-scale=0, maximum-scale=1.0, user-scalable=0",head.appendChild(t),this.elements.metaViewport=t}else this.metaScale&&(this.elements.metaViewport.content=this.elements.metaViewport.content.replace(/minimum-scale=[0-9.]+/,"minimum-scale=0.0").replace(/maximum-scale=[0-9.]+/,"maximum-scale=100.0"));this.data.resizeRender=this.renderer.add({fct:this.render,context:this,active:!1}),this.setBounding()}setBounding(){return!!this.data.bounding||!(!this.container.offsetParent&&!this.container.parentNode)&&(this.data.bounding=this.container.getBoundingClientRect(),!0)}render(){if(!this.setBounding())return!1;const t=this.data.bounding.width,e=this.data.bounding.height,i=this.container,n=this.elements.html;let s,r,o=null;if(this.metaScale){let i=n.clientWidth,a=n.clientHeight;this.currentScale<1&&(i=Math.ceil(i*this.currentScale),a=Math.ceil(a*this.currentScale)),s=Math.min(i/t,a/e),r=Math.abs(Math.floor((t*s-i)/2)),o=Math.abs(Math.floor((e*s-a)/2)),this.elements.metaViewport.content=this.elements.metaViewport.content.replace(/initial-scale=[0-9.]+/,"initial-scale="+s),o/=s,r/=s}else s=Math.min(n.clientWidth/t,n.clientHeight/e),r=Math.abs(Math.floor((t*s-n.clientWidth)/2)),o=Math.abs(Math.floor((e*s-n.clientHeight)/2)),i.style.transformOrigin="0 0",i.style.transform="scale("+s+")";this.currentScale=s,i.style.position="absolute",i.style.top=o+"px",i.style.left=r+"px",this.data.resize.scale=s,this.data.resize.top=o,this.data.resize.left=r,this.data.resizeRender.active=!1}applyResize(t){return{x:(t.x-this.data.resize.left)/this.data.resize.scale,y:(t.y-this.data.resize.top)/this.data.resize.scale}}resize(){this.data.resizeRender.active=!0}}class ht{constructor(t){this.config={debug:!1,files:{preload:!1,cacheAfterOpen:!0,lazyLoad:!1},scorm:{resume:!0,passationTime:-1,mastery:100},resize:!0,tutor:!0,autoHideLoader:!0,mobileOrientation:["landscape"],lang:"fr"},this.ready=!1,this.context=window,this.contextDocument=this.context.document,this.container=t,this.upperInterface=function(t,e){let i=e||window,n=dt(i,t)?i[t]:null;for(;i.parent&&i.parent!==i;)i=i.parent,dt(i,t)&&(n=i[t]);return n}("scormInterface",this.context),this.device=new e,this.popup=new ct,this.loader=new ot,this.tutoring=new it,this.frameWrapper=this.container.querySelector("#content"),this.datas={},this.assetsDatas=[],this.assetsDatasMap={},this.fileDatas=[],this.fileDatasMap={},this.loadedFiles=[],this.loadedFilesMap={},this.currentFile=null,this.root={relative:null,absolute:null},this.basePath=null}async init(){this.#l();try{await this.#u()}catch(t){console.warn("No dataprovider.js file found. Using standalone mode."),this.#h()}if(new at(this.device,this.config.mobileOrientation),this.config.tutor)try{await this.tutoring.init()}catch(t){}const e=this.fileDatas.map((t=>(this.fileDatasMap[t.id]=t,Number(t.id)))),i=this.assetsDatas.map((t=>(this.assetsDatasMap[t.id]=t,Number(t.id))));this.debug=new t(this.config.debug),this.debug.init(),await this.#d();const n=this.config.scorm.resume&&this.scorm.location||1,s=this.scorm.options.autoSave,r=this.scorm.options.autoSendDuration;this.scorm.options.autoSave=!1,this.scorm.options.autoSendDuration=!1,new Set(e).size!==this.fileDatas.length&&console.warn("Duplicate file IDs detected. Please check your dataprovider.js file."),new Set(i).size!==this.assetsDatas.length&&console.warn("Duplicate asset IDs detected. Please check your dataprovider.js file."),await this.#p(),await this.resume().then((()=>{if(this.config.files.preload)for(let t=0;t<this.fileDatas.length;t++)this.fileDatas[t].id!==n&&this.#f(this.fileDatas[t])})),this.config.resize&&new ut(this.container),this.config.autoHideLoader&&this.loader.hide(),this.scorm.options.autoSave=s,this.scorm.options.autoSendDuration=r}async#d(){this.scorm=this.upperInterface?.scorm||new st,void 0===this.config.scorm.debug?(this.scorm.debug=this.debug.active,this.debug.on(this.debug.events.LOGS_ENABLED,(()=>{this.scorm.debug=!0})),this.debug.on(this.debug.events.LOGS_DISABLED,(()=>{this.scorm.debug=!1}))):this.scorm.debug=this.config.scorm.debug;for(const t in this.scorm.options)void 0!==this.config.scorm[t]&&(this.scorm.options[t]=this.config.scorm[t]);this.scorm.initialized||await this.scorm.init()}async#p(){const t=this.scorm.data;let e=!1;if(0===t.course.length){const i=this.fileDatas.map((t=>({id:t.id,status:"na",score:0})));t.course=i,e=!0}if(0===t.assets.length){const i=this.assetsDatas.map((t=>({id:t.id,status:"na"})));t.assets=i,e=!0}t.timeLeft!==this.config.scorm.passationTime&&(t.timeLeft=this.config.scorm.passationTime,e=!0),t.course.forEach((t=>{const e=this.fileDatasMap[t.id];e&&(e.status=t.status,e.score=t.score)})),t.assets.forEach((t=>{const e=this.assetsDatasMap[t.id];e&&(e.status=t.status)})),e&&await this.scorm.setCourseData(t)}async#u(){if(document.body.hasAttribute("no-dataprovider"))return Promise.resolve();const t=document.location.href.replace(/[?#].+$/gi,"").replace(/(.+\/)[^\/]+\.[^\/]+$/,"$1").replace(/\/$/,""),e=(await import(`${t}/dataprovider.js`)).default;this.config={...this.config,...e.config,files:{...this.config.files,...e.config?.files},scorm:{...this.config.scorm,...e.config?.scorm}},this.fileDatas=e.files,this.assetsDatas=e.assets,delete e.config,delete e.files,delete e.assets,this.datas=e}#h(){Array.from(this.frameWrapper.querySelectorAll("iframe")).forEach(((t,e)=>{const i=e+1,n={loaded:!0,dataStoreID:this.fileDatas.length,loadedStoreID:this.loadedFiles.length,id:i,frame:t};this.loadedFilesMap[i]=n,this.loadedFiles.push(n),this.fileDatas.push({id:i,src:t.src,title:t.dataset.title||""})}))}#l(){const t=import.meta.url.replace(/\/$/,"").split("/"),e=document.location.href.replace(/\/$/,"").split("/"),i=[],n=[];e.forEach(((e,s)=>{e!==t[s]?n.push(".."):i.push(e)})),this.root.relative=`${n.join("/")}/`,this.root.absolute=`${i.join("/")}/`,this.basePath=document.location.href}async#f(t){if(this.getFileById(t.id))return Promise.resolve();const e=`${t.id}:${t.src}`,i=document.createElement("iframe"),n={loaded:!1,dataStoreID:this.fileDatas.indexOf(this.fileDatasMap[t.id]),loadedStoreID:this.loadedFiles.length,id:t.id,frame:i};i.id=o(e),i.allowFullscreen=!0,i.style.display="none",this.config.files.lazyLoad&&(i.loading="lazy",0!==this.loadedFiles.length&&this.config.preload||(i.style.display="block")),i.style.overflow="hidden",i.style.minWidth="100%",i.style.minHeight="100%",i.style.margin="0",i.style.border="none",i.style.background="transparent",await new Promise((e=>{const r=()=>{n.frame.removeEventListener(s.LOAD,r),n.loaded=!0,e()};i.addEventListener(s.LOAD,r),i.src=t.src,this.frameWrapper.appendChild(i),this.loadedFilesMap[t.id]=n,this.loadedFiles.push(n)}))}resume(){const t=this.config.scorm.resume&&this.scorm.location||1;return new Promise((e=>{const i=t=>{"file-opened"===t.data.type&&(this.context.removeEventListener(s.MESSAGE,i),e())};this.context.addEventListener(s.MESSAGE,i),this.openFileById(t)}))}getFileDataById(t){return this.fileDatasMap[Number(t)]}getFileById(t){return this.loadedFilesMap[Number(t)]}setFileStatus(t,e){const i=this.getFileDataById(t);i&&i.status!==e&&i.status!==e&&(i.status=e,this.scorm.setFileData({id:i.id,status:i.status,score:i.score},t))}setFileScore(t,e){const i=this.getFileDataById(t);i&&i.score!==e&&(i.score=e,this.scorm.setFileData({id:i.id,status:i.status,score:i.score},t))}async openFileById(t){const e=Number(t);if(Number.isNaN(e))return Promise.resolve();this.config.files.cacheAfterOpen||this.config.files.preload||(this.loadedFiles.forEach((t=>{t.frame.remove()})),this.loadedFiles.length=0,this.loadedFilesMap={},this.currentFile=null);const i=this.getFileDataById(e);if(!i||i.id===this.currentFile?.id)return Promise.resolve();this.loader.show(),await this.#f(i);const n=this.getFileById(e),r=this.getFileDataById(e);if(this.currentFile=n,this.loadedFiles.forEach((t=>{t.id!==e&&t.frame.classList.contains("active")&&(t.frame.style.display="none",t.frame.classList.remove("active"),t.frame.contentWindow.postMessage({type:"closeFile"},"*"))})),n){if(n.loaded)n.frame.contentWindow.postMessage({type:"openFile"},"*");else{const t=()=>{n.frame.removeEventListener(s.LOAD,t),n.frame.contentWindow.postMessage({type:"openFile"},"*")};n.frame.addEventListener(s.LOAD,t)}n.frame.style.display="block",n.frame.classList.add("active")}this.config.autoHideLoader&&this.loader.hide(),"na"===r.status&&this.setFileStatus(e,"i"),this.scorm.setLocation(e)}}function dt(t,e){if(!t)return!1;let i;try{i=t[e]}catch(t){}return void 0!==i}async function pt(){const t=[],e=document.querySelectorAll("iframe"),i=[];window.removeEventListener(s.LOAD,pt);for(let n=0;n<e.length;n++){const s=e[n];try{const e=s.contentWindow,n=s.contentDocument||e.document,r=s.dataset.src,o=t=>new Promise((e=>{i.push(t),t.onload=e,t.onerror=e}));s.src&&""!==s.src&&"complete"===n.readyState?(i.push(s),t.push(Promise.resolve())):t.push(o(s)),r&&(delete s.dataset.src,s.src=r+window.location.search)}catch(t){console.warn("Frame : ",s,`ignored due to error : ${t}`)}}await Promise.all(t);const n=await async function(){const t=document.querySelector("#mainWrapper"),e=new ht(t);return window.scormInterface=e,e.device.mobile&&document.body.addEventListener(s.CLICK_TOUCH,(function(t){if(t.stopPropagation){const e=["audio","video","input","textarea","select"],i=[".rotate-help a"],n=t.target,s=n.tagName.toLowerCase();let r=e.includes(s);if(r&&i.length>0)for(let t=0;t<i.length;t++){const e=i[t];if(n.closest(e)){r=!1;break}}r&&t.preventDefault()}})),window.addEventListener(s.BEFORE_UNLOAD,(()=>e.scorm.quit())),window.addEventListener(s.FOCUS_OUT,(()=>window.scrollTo(0,0))),await e.init(),e}();n.ready=!0,i.forEach((t=>{t.contentWindow.postMessage({type:"interface-ready"},"*")})),n.loadedFiles.forEach((t=>{t.frame.contentWindow.postMessage({type:"interface-ready"},"*")}))}"complete"===document.readyState?pt():window.addEventListener(s.LOAD,pt);
